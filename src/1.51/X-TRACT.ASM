TITLE XTRACT v1.51
		IDEAL
                MODEL LARGE
		JUMPS
                CODESEG
SEGMENT SUCK 'STACK'
                STACK 0100H
ENDS
MAIN:
                MOV AX,SEGUNDAPARTE
                MOV DS,AX
                MOV [WORD DS:PUSHSECOND+002H],DS
                MOV [WORD DS:POPSECOND+002H],DS
                MOV AX,CS
                MOV [WORD DS:CSEGMENT],AX
                JMP XMAIN

EXEHEADORIG     DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
		DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0

DTAPOINTERS     DB 00,00,00,00
POINTDTATEMP	DB 00,00,00,00
DTA		DB 80H DUP (0)
KEYREPPLY	DB 155 DUP (0)
BACKUPINT	DB 4*0100H DUP (0)
CANONICAL	DB 80h DUP (0)
HANDLE		DB 00,00
HANDLE2 	DB 00,00
HANDLE3 	DB 00,00
DATE		DB 00,00
TIME		DB 00,00
ATRIB		DB 00,00
BUFFER		DB 200H DUP (0)
OFFRUT4 	DB 00,00
FILESIZECOM	DW 00
TEMPAX		DW 00
TEMPBX		DW 00
TEMPCX		DW 00
TEMPDX		DW 00
TEMPDS		DW 00
TEMPES		DW 00
TEMPSI		DW 00
TEMPDI		DW 00
TEMPF		DW 00
OLDINT00	DW 00,00
INTF0IP 	DB 00,00
INTF0CS 	DB 00,00
INITSSSP	DB 00,00,00,00
PARAMBLOCK	DB 00,00 ; Copy caller's enviroment
		DB 80H,00
TAIL		DB 00,00 ; Command Tail Pointer ;-)
		DB 05CH,00
SEGFCB1 	DB 00,00 ; 1st FCB Pointer
		DB 06CH,00
SEGFCB2 	DB 00,00 ; 2nd FCB

CHILDSSSP	DB 00,00,00,00 ; Initial SS:SP
CHILDCSIP	DB 00,00,00,00 ; Initial CS:IP

POINT		DB 00,00
POINTS		DB 00
STARTNAME	DB 00,00
EXEHEADER	DB 020h DUP (0)
PID		DB 00,00
PID3		DB 00,00
DXLOW		DB 00,00
CXHIGH		DB 00,00
EXITINFO	DB 00
POINTIP 	DB 00,00
POINTCS 	DB 00,00
SIZEEXE1	DB 00,00
SIZEEXE2	DB 00,00
HIGHSIZE	DB 00,00
LOWSIZE 	DB 00,00
RELOC		DB 00
EXEIP		DB 00,00
EXECS		DB 00,00
EXESS		DB 00,00
EXESP		DB 00,00
HEADHIGH	DB 00,00
HEADLOW 	DB 00,00
REG		DB 00
REG148		DB 00
TYPEREG1	DB 00
REGVAL1 	DB 00,00
TYPEREG2	DB 00
REGVAL2 	DB 00,00
COUNTER148	DB 00
CODEPOINTER	DB 00,00
ACTIVO		DB 00
VALUEREG	DB 00,00
BREAKJZNZ	DB 00,00
NZNUMBA 	DB 00
TEMPBYTE	DB 00,00
EXEMARK 	DB 00
OVERLAY 	DB 00
NOTFUCKINGDEL	DB 00
STATE21 	DB 00
PKLITESHORTLONG DB 00
COMPRTYPE	DB 00
MSBLENGTH	DB 00,00
LSBLENGTH	DB 00,00
KEYTYPE 	DB 00
FAKEPK		DB 00
PKFIRSTYPE	DB 00
PKTYPE		DB 00
PKXTRATYPE	DB 00
PPTYPE		DB 00
EXEPACK 	DB 00
EPW		DB 00
BINLOK		DB 00,00
EXE2COMMSOK	DB 00
OPTLINK 	DB 00
DISLITEOK	DB 00
DIET		DB 00
DIETOK		DB 00
ONEMANOFFSET	DB 00,00
TINYTYPE        DB 00
PKTINYOK        DB 00
ADYTYPE         DB 00
TNT             DB 00
FSHIELDTYPE     DB 00
COMSTYLE        DB 00
PASAALTOS       DB 00,00
PASABANDA       DB 00,00
PASABAJOS       DB 00,00
PASAALTOS2      DB 00,00
PASABANDA2      DB 00,00
PASABAJOS2      DB 00,00
STEP55          DB 00
OFFSETXCHG      DB 00,00
UNKNOWNPHASE1   DB 00,00
UNKNOWNCOUNTER  DB 00,00
KNOWNCOUNTER    DB 00,00
OFFSETJZNZ      DB 00,00
JZTYPE          DB 00
PRXCM55TYPE     DB 00
INSTRPREVCX     DB 00,00
JZVALUE         DB 00,00
SCRUNCHEXE      DB 00
WWPACK300OK     DB 00
LEJOS           DB 00
EXEMAX          DB 00,00
EXEMIN          DB 00,00
STACKFLAGS      DB 00,00
STACKIP         DB 00,00
STACKCS         DB 00,00
EXEHEADSTICKER  DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
		DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
CXPOS           DB 00,00
DXPOS		DB 00,00
ACTIVADO	DB 00
PARAES		DB 00,00
PARADI		DB 00,00
DATADI		DB 00,00
DATAES		DB 00,00
OFFSALTO	DB 00,00
RESERSEG	DB 00,00
PKLITEFIX	DB 0B8H,0,0,0,0,0,005H,0,0
RELOCAPPLY	DB 00
CANTRELOC	DB 00,00
OFFSETRELOC	DB 00,00
HEADFILL	DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
REGD		DB 00
SCRE2B		DB 00
HEADORIG	DB 00
ALLEXEMARKS	DB 00
EXITORCONT	DB 00
DSEGMENT	DB 00,00
ISJUMPINST	DB 00
LASTLOOP	DB 00
RETFLOOP	DB 00

TEMPPARAMETERS	DB 80h DUP (0)
LINEPARAMETERS	DB 80h DUP (0)

FAKEPKUPPER:
		DB 0EBH,007H,058H,02DH,054H,052H,041H,043H,054H,0C7H
		DB 006H,05CH,000H,050H,04BH,08CH,0D8H,005H,000H,000H
		DB 050H,0B8H,000H,000H,050H,0CBH
FAKEPKLOWER:
		DB 0EBH,007H,058H,02DH,054H,052H,041H,043H,054H,0C7H
		DB 006H,05CH,000H,070H,06BH,08CH,0D8H,005H,000H,000H
		DB 050H,0B8H,000H,000H,050H,0CBH

INCLUDE "STRINGID.ASM"

EXEHEAD:
		DB 04DH,05AH,000H,000H,000H,000H,000H,000H,002H,000H
		DB 000H,000H,0FFH,0FFH,000H,000H,000H,000H,000H,000H
		DB 000H,000H,000H,000H,01CH,000H,000H,000H
		DB 000H,000H,000H,000H
KEYID:
		DB   84,104,105,115, 32,105,115, 32,121,111
		DB  117,114, 32,114,101,103,105,115,116,114
		DB   97,116,105,111,110, 32,107,101,121, 32
		DB  102,111,114, 32, 88, 45, 84, 82, 65, 67
		DB   84, 46, 32, 80,108,101, 97,115,101, 44
		DB   32,100,111, 32,110,111,116, 32,100,105
		DB  115,116,114,105, 98,117,116,101, 32,105
		DB  116, 33, 13, 10, 40, 99, 41, 32, 49, 57
		DB   57, 52, 32, 98,121, 32, 87,111,111,100
		DB  121, 44, 32, 66,117,101,110,111,115, 32
		DB   65,105,114,101,115, 44, 32, 65, 82, 71
		DB   69, 78, 84, 73, 78, 65, 46, 32, 80, 97
		DB  98, 108, 111, 32, 76, 105, 118, 101
		DB  115, 32, 83, 111, 109, 101, 119, 104
		DB  101, 114, 101, 32, 73, 110, 32, 84
		DB  104, 101, 32, 84, 105, 109, 101, 46
		DB  13, 10
TEMPNAME:
		DB '$$XTRAC$.$$$',00h
KEYNAME:
		DB 'X-TRACT.KEY',00h
STICKERNAME:
                DB 'STICKER.EXE',00h
STICKERNAMECOM:
                DB 'STICKER.COM',00h
BYTEREGISTERED:
		DB 00

INCLUDE "DATE.ASM"

INCLUDE "VARIOSMS.ASM"

INCLUDE "NAMEID.ASM"

XMAIN:
		IN AL,21H
		MOV [BYTE CS:STATE21],AL
		PUSHF
		CALL INTRO
		CLC
		MOV AH,62H
		INT 21H
		MOV ES,BX
		CMP [BYTE ES:0080H],02
		JNB READCOMMANDLINE
SHELP:
		JMP HELP
READCOMMANDLINE:
		CMP [BYTE ES:0081H],20H
		JNE SHELP
		XOR CH,CH
		MOV CL,[BYTE ES:0080H]
		MOV SI,0081H
		MOV BX,CX
		MOV [BYTE ES:BX+SI],00
		MOV DI,OFFSET LINEPARAMETERS
		CLD
		PUSH ES
		POP DS
		PUSH CS
		POP ES
		REP MOVSB
COMMANDLINE:
		MOV BX,OFFSET LINEPARAMETERS
		INC BX
		XOR SI,SI
CHECKPOINT:
		MOV AL,[BYTE ES:BX+SI]
		CMP AL,"."
		JE PUTPOINT
		CMP AL,00H
		JE EXTENSION
		INC SI
		JMP CHECKPOINT
PUTPOINT:
		ADD BX,SI
		MOV [WORD ES:POINT],BX
		SUB BX,SI
		INC SI
		INC [WORD ES:POINTS]
		JMP CHECKPOINT

EXTENSION:
		CMP [WORD ES:POINTS],0000H
		JNE EXT2
		ADD BX,SI
		MOV [WORD ES:POINT],BX
EXT2:
		ADD BX,SI
		SUB BX,0002H
		XOR SI,SI
CONT2:
		MOV AL,[BYTE ES:BX+SI]
		CMP AL," "
		JE FOUNDNAME
		DEC BX
		JMP CONT2
FOUNDNAME:
		XCHG BX,SI
		ADD BX,SI
		INC BX
		MOV [WORD ES:STARTNAME],BX
		MOV CX,[WORD ES:POINT]
		ADD CX,0004H
		SUB CX,[WORD ES:STARTNAME]
		CLD
		MOV SI,[WORD ES:STARTNAME]
		MOV DI,OFFSET LINEPARAMETERS
		PUSH CS
		POP DS
		REP MOVSB
		MOV AL,0H
		STOSB

SHOWFILENAME:
		MOV AH,60H
		MOV SI,OFFSET LINEPARAMETERS
		MOV DI,OFFSET CANONICAL
		INT 21H

		MOV AH,2FH
		INT 21H
		MOV [WORD CS:DTAPOINTERS],BX
		MOV [WORD CS:DTAPOINTERS+2],ES

		MOV AH,1AH
		MOV DX,OFFSET DTA
		PUSH CS
		POP DS
		INT 21H


		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET CANONICAL
		INT 21H

		JNC  OK
		JMP MSGERR
OK:
		MOV DX,OFFSET NAMEFILE
		CALL PRINT

		MOV BX,OFFSET DTA+1EH
		XOR SI,SI

FILE:
		MOV DL,[BYTE BX+SI]
		CMP DL,00
		JZ CHECK
		MOV AH,02
		INT 21H
		INC SI
		JMP FILE

CHECK:
		MOV BX,OFFSET CANONICAL
		DEC BX
		XOR SI,SI
COPYPATH:
		INC SI
		MOV AL,[BYTE BX+SI]
		CMP AL,0000H
		JNZ COPYPATH
SCANSLASH:
		DEC SI
		MOV AL,[BX+SI]
		CMP AL,005CH
		JZ STOREPATH
		JMP SCANSLASH

STOREPATH:
		ADD BX,SI
		SUB BX,OFFSET CANONICAL-0001H
		MOV CX,BX
		CLD
		MOV SI,OFFSET CANONICAL
		MOV DI,OFFSET LINEPARAMETERS
		PUSH CS
		POP ES
		REP MOVSB

		XOR BX,BX
		MOV SI,OFFSET DTA+1EH
COPYFILENAME:
		MOV AL,[BX+SI]
		CMP AL,00
		JZ OPENFILE
		MOV [BX+DI],AL
		INC BX
		JMP COPYFILENAME

		MOV [BX+DI],AL
		INC BX
		JMP COPYPATH

OPENFILE:
		MOV [BX+DI],AL

		MOV DX,OFFSET CARRIAGE
		CALL PRINT
FINDINGPATH:
		STD
		MOV CX,0080H
		PUSH CS
		POP ES
		MOV DI,OFFSET LINEPARAMETERS+007FH
		MOV AL,'\'
		REPNZ SCASB
		INC CX

		PUSH CS
		POP DS
		MOV SI,OFFSET LINEPARAMETERS
		MOV DI,OFFSET TEMPPARAMETERS
		CLD
		REP MOVSB
		MOV SI,OFFSET TEMPNAME
		MOV CX,000DH
		REP MOVSB




OPENFILE2:
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID3],BX
		MOV ES,BX

		MOV [WORD CS:TAIL],ES
		MOV [WORD CS:SEGFCB1],ES
		MOV [WORD CS:SEGFCB2],ES

		MOV AX,ES
		MOV BX,XT
		SUB BX,AX

		MOV AH,4AH
		INT 21H

		MOV BX,[WORD ES:002CH]
		MOV [WORD CS:PARAMBLOCK],BX
		PUSH CS
		POP DS
		PUSH CS
		POP ES
		MOV AX,4B01H
		MOV BX,OFFSET PARAMBLOCK
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		PUSHF
		INC [BYTE CS:EXITINFO]
		CMP [BYTE CS:EXITINFO],02
		JZ FIN
		POPF
		JNC CHECKPRXCMCOM

		MOV DX,OFFSET NOTMEMO
		CALL PRINT
		MOV [BYTE CS:NOTFUCKINGDEL],01H
		JMP FIN1

CHECKPRXCMCOM:
                MOV AX,SEGUNDAPARTE
                MOV DS,AX
                MOV AX,[WORD CS:CHILDSSSP]
                MOV [WORD DS:CHILDSSSP2],AX
                MOV AX,[WORD CS:CHILDSSSP+02H]
                MOV [WORD DS:CHILDSSSP2+02H],AX
                MOV AX,[WORD CS:CHILDCSIP]
                MOV [WORD DS:CHILDCSIP2],AX
                MOV AX,[WORD CS:CHILDCSIP+02H]
                MOV [WORD DS:CHILDCSIP2+02H],AX
                XOR AX,AX
                MOV BX,AX
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DS,[WORD CS:CHILDCSIP+02]

		MOV AL,[BX+SI]

CHECK4JUMP:
		CMP AL,0B8H
		JE CHECKPKLITE115COM

		CMP AL,0EBH
		JE CHECKENCRIPTOR100BETA
CHECKTHEREST:
		CMP AL,0E9H
		JE CHECK4ALL

		CMP AL,0E8H
		JNE CHECKPRXCM31EXE
CHECK4ALL:
                MOV BX,[WORD DS:SI+01H]
                ADD BX,SI
                ADD BX,0003H
                MOV AX,[WORD DS:BX]
                CMP AL,0EBH
                JNZ CHECKCOMUN
                XOR AL,AL
                XCHG AH,AL
                ADD BX,AX
                ADD BX,0002
                JMP CHECKTINY

CHECKCOMUN:
                XOR BX,BX
                CMP SI,0000H
		JZ CHECKPRXCM20EXE
		MOV DX,[BX+SI+1]
		ADD DX,0103H
		MOV [WORD CS:OFFSALTO],DX
		MOV SI,DX

		PUSH CS
		POP ES
		MOV DI,OFFSET PRXCM4ID
		MOV CX,0092
		CLD
		REP CMPSB
		JNZ CHECKMRHDKILLERPROT

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM4OK
		CALL PRINT
		CALL PAGK

		JMP UNPRXCM4 ; 8-)

FIN1:

SHOWIFOVERLAY:
		MOV AX,25F0H
		LDS DX,[DWORD CS:INTF0IP]
		INT 21H

		CLI
		MOV SS,[WORD CS:INITSSSP]
		MOV SP,[WORD CS:INITSSSP+02H]
		STI

		MOV AL,[BYTE CS:STATE21]
		OUT 21H,AL
		CMP [BYTE CS:OVERLAY],01H
		JNE READYTODEL
		CALL SHOWOVERLAY
READYTODEL:
		CMP [BYTE CS:NOTFUCKINGDEL],01H
		JE PUTDONE
		PUSH CS
		POP DS
		MOV AH,09H
		MOV DX,OFFSET FUCKED
		INT 21H

		PUSH CS
		POP DS
		MOV AH,41H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		PUSH CS
		POP ES
		MOV AH,56H
		MOV DX,OFFSET TEMPPARAMETERS
		MOV DI,OFFSET LINEPARAMETERS
		INT 21H

		MOV AH,09H
		PUSH CS
		POP DS
		MOV DX,OFFSET DONE
		INT 21H
PUTDONE:
		MOV [BYTE CS:EXITORCONT],01H
FIN2:
                CALL DTANORMAL
		MOV AX,4C00H
		INT 21H
FIN:
		CMP [BYTE CS:EXITORCONT],01H
		JE RETRYCHECK
                CLI
                MOV SS,[WORD CS:INITSSSP]
                MOV SP,[WORD CS:INITSSSP+02H]
                STI
                MOV AX,4C00H
		INT 21H

RETRYCHECK:
		MOV [BYTE CS:EXITINFO],00H
		MOV [BYTE CS:EXITORCONT],00H
		MOV [BYTE CS:EXEMARK],00H
		PUSH CS
		POP ES
		MOV DI,OFFSET INITSSSP
		MOV SI,OFFSET EXEHEADORIG
		SUB DI,SI
		MOV CX,DI
		XOR AX,AX
		XCHG SI,DI
		CLD
		REP STOSB
		MOV DI,OFFSET RETFLOOP
		MOV SI,OFFSET CHILDSSSP
		SUB DI,SI
		MOV CX,DI
		XOR AX,AX
		XCHG SI,DI
		CLD
		REP STOSB


		JMP OPENFILE2
SHOWOVERLAY:
		MOV DX,OFFSET OVERLAYMSG
		CALL PRINT
		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		LDS DX,[DWORD CS:POINTDTATEMP]
		MOV BX,DX
		ADD BX,001EH
		XOR SI,SI

FILEZ:
		MOV DL,[BYTE BX+SI]
		CMP DL,00
		JZ ENDFILEZ
		MOV AH,02
		INT 21H
		INC SI
		JMP FILEZ
ENDFILEZ:
		MOV DX,OFFSET COPYMSG
		CALL PRINT

PAGK2:		 ; Press And Get Key 2 :)

GETKEY2:
		MOV AH,08H
		INT 21H
		CMP AL,79H
		JE LETCONT2
		CMP AL,59H
		JE LETCONT2
		CMP AL,4EH
		JE DONTCONT2
		CMP AL,6EH
		JE DONTCONT2
		JMP GETKEY2
DONTCONT2:
		CALL PRINTCHAR
		RETN
LETCONT2:
		CALL PRINTCHAR

		MOV AH,62H
		INT 21H
		MOV ES,BX

		MOV AH,49h
		INT 21H

		MOV ES,[WORD CS:PID3]

		MOV AX,ES
		MOV BX,XT
		SUB BX,AX

		MOV AH,4AH
		INT 21H

		MOV AH,48H
		MOV BX,0500H
		INT 21H

		JNC MEMOOK

		MOV DX,OFFSET NOTMEMO
		CALL PRINT

		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		XOR CX,CX
		INT 21H


		MOV AH,41H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV AX,3D02H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV BX,[WORD CS:HANDLE]
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H
		MOV AH,3EH
		INT 21H
		MOV AX,4301H
		MOV DX,OFFSET LINEPARAMETERS
		MOV CX,[WORD CS:ATRIB]
		INT 21H


		MOV [BYTE CS:EXITORCONT],00H
		POP AX
		MOV AX,OFFSET FIN2
		PUSH AX
		RET

MEMOOK:
		MOV [WORD CS:RESERSEG],AX

		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		XOR CX,CX
		INT 21H

		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		MOV AX,3D00H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE2],AX

		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		MOV AX,4200H
		MOV BX,[WORD CS:HANDLE2]
		MOV CX,[WORD CS:CXHIGH]
		MOV DX,[WORD CS:DXLOW]
		INT 21H
READONCEAGAIN:
		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE2]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		CMP AX,4000H
		JB WRITELASTBLOCK

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		JMP READONCEAGAIN



WRITELASTBLOCK:
		MOV CX,AX
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H


		MOV BX,[WORD CS:HANDLE]
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE2]
		INT 21H

		PUSH CS
		POP DS
		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		MOV CX,[WORD CS:ATRIB]
		INT 21H

		MOV AH,49H
		MOV ES,[WORD CS:RESERSEG]
		INT 21H
		RETN







		RET

CHECKEXE:
		JMP CHECKPRXCMEXE
CHECKPROTECT5COM:
                MOV [BYTE CS:COMSTYLE],01H
CHECKSUBADDXOR:
		MOV SI,DX
BIROUTINE:
		MOV AL,[BYTE DS:SI]
		CMP AL,0B8H
                JZ CHECKPROTECT55COM
		CMP [BYTE DS:SI+0003H],81H
		JNZ CHECKROTATE
		MOV [WORD CS:CODEPOINTER],SI
		ADD [WORD CS:CODEPOINTER],07H
		MOV BL,[BYTE DS:SI+0004H]
		SUB BL,AL
		CMP BL,30H
		JZ SUBOK
		CMP BL,08H
		JZ ADDOK
		CMP BL,38H
		JZ XOROK
                JMP CHECKPROTECT55COM


SUBOK:
		MOV AX,[WORD DS:SI+0001H]
		MOV BX,[WORD DS:SI+0005H]
		SUB AX,BX
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS
		CMP AX,0148H
		JZ INTERPRETAR
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER
ADDOK:
		MOV AX,[WORD DS:SI+0001]
		MOV BX,[WORD DS:SI+0005]
		ADD AX,BX
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS
		CMP AX,0148H
		JZ INTERPRETAR
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER
XOROK:
		MOV AX,[WORD DS:SI+0001]
		MOV BX,[WORD DS:SI+0005]
		XOR AX,BX
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS
		CMP AX,0148H
		JZ INTERPRETAR
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER
EXECUENTAS:
		MOV [WORD CS:REGVAL1],AX
		MOV AL,[BYTE DS:SI]
		MOV [BYTE CS:TYPEREG1],AL
		JMP UNDERSTAND

CHECKROTATE:
CHECKROLROR:
		CMP [BYTE DS:SI+0003H],0D1H
                JNZ CHECKPROTECT55COM
		MOV [WORD CS:CODEPOINTER],SI
		ADD [WORD CS:CODEPOINTER],05H
		MOV BL,[BYTE DS:SI+0004H]
		SUB BL,AL
		CMP BL,08H
		JZ ROLOK
		CMP BL,10H
		JZ ROROK
                JMP CHECKPROTECT55COM
ROLOK:
		MOV AX,[WORD DS:SI+0001H]
		ROL AX,1
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS

		CMP AX,0148H
		JZ INTERPRETAR
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER
ROROK:
		MOV AX,[WORD DS:SI+0001H]
		ROR AX,1
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS

		CMP AX,0148H
		JZ INTERPRETAR
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER

CHECKERROR:	MOV DX,OFFSET NOTOUCHED
		CALL PRINT
		CALL DTANORMAL

		JMP FIN
PUTREGISTER:
		MOV AL,[BYTE DS:SI]
		AND AL,07H
		MOV [BYTE CS:REG],AL
		MOV [BYTE CS:COUNTER148],01H
		JMP UNDERSTAND
INTERPRETAR:
		MOV AL,[BYTE DS:SI]
		AND AL,07H
		MOV [BYTE CS:REG148],AL
UNDERSTAND:
		MOV SI,[WORD CS:CODEPOINTER]
VEREMOS:
		XOR DI,DI
		MOV BX,OFFSET INSTLIBR1-1

		JMP SEEINST
INSTLIBR1:
		DB 0BBH,0B9H,0BAH,0BEH,0BFH,0BDH,000H
INAL21LIB:
		DB 050H,0E4H,021H,050H,0E9H,00EH,000H
OUT21LIB1:
		DB 0E6H,021H,0E9H,001H,000H
OUT21LIB2:
		DB 058H,0E6H,021H,0E9H,006H,000H
SEEINST:

ESMOV:
		MOV AL,[BYTE DS:SI]

REPETIR:
		INC DI
		MOV CL,[BYTE CS:BX+DI]
		OR CL,CL
		JZ ESJUMP
		CMP CL,AL
		JNZ REPETIR

VEAMOS:
		JMP SEE2NDREG ; A VER EL 2DO REGISTRO
ESJUMP:
		CMP AL,0EBH
		JNZ OUT21LIB
		MOV AL,[BYTE DS:SI+01H]
		CMP AL,80H
		JAE RETRO
AVANCE:
		XOR AH,AH
		ADD SI,AX
		ADD SI,0002H
		JMP VEREMOS
RETRO:
		NEG AL
		XOR AH,AH
		SUB SI,AX
		ADD SI,0002H
		JMP VEREMOS
OUT21LIB:
		PUSH SI
		PUSH DI
		MOV DI,OFFSET OUT21LIB1
		MOV CX,0005H
		CLD
		REP CMPSB
		JNZ OUT21LIBTWO
		POP DI
		POP SI
		ADD SI,0006H
		JMP VEREMOS
OUT21LIBTWO:
		POP DI
		POP SI
		PUSH SI
		PUSH DI
		MOV DI,OFFSET OUT21LIB2
		MOV CX,0006H
		CLD
		REP CMPSB
		JNZ MOVALFF
		POP DI
		POP SI
		ADD SI,000CH
		JMP VEREMOS
MOVALFF:
		POP DI
		POP SI
		CMP AL,0B0H
		JNZ CHECKINAL21
		CMP [BYTE DS:SI+01H],0FFH
		JNZ CHECKERROR
		ADD SI,0002H
		JMP VEREMOS
CHECKINAL21:
		PUSH SI
		PUSH DI
		MOV DI,OFFSET INAL21LIB
		MOV CX,0007H
		CLD
		REP CMPSB
		JNZ CHECKPOPAXONLY
		POP DI
		POP SI
		ADD SI,0015H
		JMP VEREMOS

CHECKPOPAXONLY:
		POP DI
		POP SI
		CMP AL,058H
		JNZ CHECKINDEXED
		ADD SI,0001H
		JMP VEREMOS
SEE2NDREG:
CHECKSUBADDXOR2:
		CMP AL,0B8H
                JZ CHECKPROTECT5COM
		CMP [BYTE DS:SI+0003H],81H
		JNZ CHECKROTATE22
		MOV BL,[BYTE DS:SI+0004H]
		SUB BL,AL
		CMP BL,30H
		JZ SUBOK2
		CMP BL,08H
		JZ ADDOK2
		CMP BL,38H
		JZ XOROK2
                JMP CHECKPROTECT5COM

SUBOK2:
		MOV AX,[WORD DS:SI+0001H]
		MOV BX,[WORD DS:SI+0005H]
		SUB AX,BX
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS2
		CMP AX,0148H
		JZ PUTREGISTER31
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER31
ADDOK2:
		MOV AX,[WORD DS:SI+0001]
		MOV BX,[WORD DS:SI+0005]
		ADD AX,BX
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS2
		CMP AX,0148H
		JZ PUTREGISTER31
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER31
XOROK2:
		MOV AX,[WORD DS:SI+0001]
		MOV BX,[WORD DS:SI+0005]
		XOR AX,BX
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS2
		CMP AX,0148H
		JZ PUTREGISTER31
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER31

CHECKROTATE22:
CHECKROLROR2:
		CMP [BYTE DS:SI+0003H],0D1H
                JNZ CHECKPROTECT55COM
		MOV BL,[BYTE DS:SI+0004H]
		SUB BL,AL
		CMP BL,08H
		JZ ROLOK2
		CMP BL,10H
		JZ ROROK2
                JMP CHECKPROTECT55COM
ROLOK2:
		MOV AX,[WORD DS:SI+0001H]
		ROL AX,1
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS2
		CMP AX,0148H
		JZ PUTREGISTER22
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER22
ROROK2:
		MOV AX,[WORD DS:SI+0001H]
		ROR AX,1
		CMP [BYTE CS:EXEMARK],01H
		JZ EXECUENTAS2
		CMP AX,0148H
		JZ PUTREGISTER22
		MOV [WORD CS:VALUEREG],AX
		JMP PUTREGISTER22
EXECUENTAS2:
		MOV [WORD CS:REGVAL2],AX
		MOV AL,[BYTE DS:SI]
		MOV [BYTE CS:TYPEREG2],AL
		CMP [BYTE DS:SI+0003H],0D1H
		JZ PUTREGISTER22

PUTREGISTER31:
		ADD SI,0007H
		JMP PUTREGISTER3

PUTREGISTER22:
		ADD SI,0005H
PUTREGISTER3:
		CMP [BYTE CS:COUNTER148],01H
		JNZ NOPUT148REG ; Pone el registro que no es 148h
		MOV AL,[BYTE DS:SI]
		AND AL,07H
		MOV [BYTE CS:REG148],AL
		JMP SEARCHINDEXED
NOPUT148REG:
		MOV AL,[BYTE DS:SI]
		AND AL,07H
		MOV [BYTE CS:REG],AL
SEARCHINDEXED:
		MOV [BYTE CS:ACTIVO],01H
		JMP VEREMOS
CHECKINDEXED:
		CMP [BYTE CS:ACTIVO],01H
                JNZ CHECKPROTECT55COM
		MOV AL,[BYTE DS:SI]
		CMP AL,08BH
		JE CHECKINDEXEDMOV
		CMP AL,087H
		JE CHECKINDEXEDMOV
                JMP CHECKPROTECT55COM
CHECKINDEXEDMOV:
		MOV AH,[BYTE DS:SI+0001H]
		CMP AH,04H
		JE CHECKINDSIDIBX
		CMP AH,05H
		JE CHECKINDSIDIBX
		CMP AH,07H
		JE CHECKINDSIDIBX
		CMP AH,084H
		JE CHECKINDNUMBA
		CMP AH,085H
		JE CHECKINDNUMBA
		CMP AH,087H
		JE CHECKINDNUMBA
                JMP CHECKPROTECT55COM
CHECKINDSIDIBX:
		ADD SI,0002H
SEEINDEX:
		MOV BX,[SI]
		CMP BL,089H
		JE CHECKIFSIDIBX
		CMP BL,087H
		JE CHECKIFSIDIBX
		INC SI
		JMP SEEINDEX
CHECKIFSIDIBX:
		CMP BH,AH
		JE FOUNDOK ; Por fin!!!!!!!!!!!!!
		INC SI
		JMP SEEINDEX
CHECKINDNUMBA:
		ADD SI,0002H
		MOV BX,[SI]
SEEINDEX2:
		ADD SI,0002H
SEEIND:
		MOV CX,[SI]
		CMP CL,089H
		JE CHECKIFSIDIBXINDEX
		CMP CL,087H
		JE CHECKIFSIDIBXINDEX
		INC SI
		JMP SEEIND
CHECKIFSIDIBXINDEX:
		CMP CH,AH
		JE CONTFIND
		INC SI
		JMP SEEIND
CONTFIND:
		MOV DX,[SI+0002H]
		CMP DX,BX
		JE FOUNDOK2
		INC SI
		JMP SEEIND
FOUNDOK2:
		CMP [BYTE EXEMARK],01H
		JZ SEEIFSIDIBXINDNUMBA
		ADD [WORD CS:VALUEREG],DX
FOUNDOK:
		CMP [BYTE EXEMARK],01H
		JZ SEEIFSIDIBXIND
OHYES:
		MOV SI,[WORD CS:VALUEREG]
CHECKJZNZ:
		MOV AL,[BYTE DS:SI-0002H]
		CMP AL,075H
		JE PUTJNZBREAK ; :-)
		CMP AL,0EBH
		JE CHECKJZ
                JMP CHECKPROTECT55COM
CHECKJZ:
		MOV AX,[WORD DS:SI-0004]
		CMP AX,0274H
                JNZ CHECKPROTECT55COM
		JMP PUTJZBREAK
PUTJNZBREAK:
		MOV [WORD CS:BREAKJZNZ],"NZ"
		JMP PRO5COMOK
PUTJZBREAK:
		MOV [WORD CS:BREAKJZNZ],"JZ"

PRO5COMOK:
		CMP [BYTE EXEMARK],01H
		JZ PRO5EXEOK

		PUSH DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PROTECT5COMOK
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		POP DS
		JMP UNPRXCM5COM
SEEIFSIDIBXIND:
		MOV AL,[SI+0001H]
		CMP AL,04 ; SI?
		JZ CALCSI
		CMP AL,05 ; DI?
		JZ CALCDI
		CMP AL,07 ; BX?
		JZ CALCBX
                JMP CHECKPROTECT55COM
CALCSI:
		CMP [BYTE CS:TYPEREG1],0BEH
		JZ GETVALUE
		CMP [BYTE CS:TYPEREG2],0BEH
		JZ GETVALUE2
                JMP CHECKPROTECT55COM

CALCDI:
		CMP [BYTE CS:TYPEREG1],0BFH
		JZ GETVALUE
		CMP [BYTE CS:TYPEREG2],0BFH
		JZ GETVALUE2
                JMP CHECKPROTECT55COM


CALCBX:
		CMP [BYTE CS:TYPEREG1],0BBH
		JZ GETVALUE
		CMP [BYTE CS:TYPEREG2],0BBH
		JZ GETVALUE2
                JMP CHECKPROTECT55COM

GETVALUE:
		MOV AX,[WORD CS:REGVAL1]
		MOV [WORD CS:VALUEREG],AX
		JMP OHYES
GETVALUE2:
		MOV AX,[WORD CS:REGVAL2]
		MOV [WORD CS:VALUEREG],AX
		JMP OHYES


SEEIFSIDIBXINDNUMBA:
		MOV AL,[SI+0001H]
		MOV BX,[SI+0002H]
		AND AL,07H
		CMP AL,04 ; SI?
		JZ CALCSI2
		CMP AL,05 ; DI?
		JZ CALCDI2
		CMP AL,07 ; BX?
		JZ CALCBX2
                JMP CHECKPROTECT55COM
CALCSI2:
		CMP [BYTE CS:TYPEREG1],0BEH
		JZ GETVALUE3
		CMP [BYTE CS:TYPEREG2],0BEH
		JZ GETVALUE32
                JMP CHECKPROTECT55COM

CALCDI2:
		CMP [BYTE CS:TYPEREG1],0BFH
		JZ GETVALUE3
		CMP [BYTE CS:TYPEREG2],0BFH
		JZ GETVALUE32
                JMP CHECKPROTECT55COM


CALCBX2:
		CMP [BYTE CS:TYPEREG1],0BBH
		JZ GETVALUE3
		CMP [BYTE CS:TYPEREG2],0BBH
		JZ GETVALUE32
                JMP CHECKPROTECT55COM

GETVALUE3:
		MOV AX,[WORD CS:REGVAL1]
		ADD AX,BX
		MOV [WORD CS:VALUEREG],AX
		JMP OHYES
GETVALUE32:
		MOV AX,[WORD CS:REGVAL2]
		ADD AX,BX
		MOV [WORD CS:VALUEREG],AX
		JMP OHYES
PRO5EXEOK:
		JMP UNPRXCM5COM





CHECKPRXCM5UNREGEXE:
		JMP CONT5UNREG
PRX5UNREG:
		DB 01EH,0EH,0EH,1FH,07H
PRX5UNREG2:
		DB 01EH,0EH,0EH,07H,1FH
PRX5UNREG3:
		DB 00EH,07H,1EH,0EH,1FH
CONT5UNREG:
		MOV [BYTE CS:EXEMARK],01H
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET PRX5UNREG
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,0005H
		REP CMPSB
		JZ PRXCM5CHECKOK
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET PRX5UNREG2
		CLD
		MOV CX,0005H
		REP CMPSB
		JZ PRXCM5CHECKOK
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET PRX5UNREG3
		CLD
		MOV CX,0005H
		REP CMPSB
		JZ PRXCM5CHECKOK
                JMP CHECKPROTECT55COM

PRXCM5CHECKOK:

		MOV SI,0005
		XOR DI,DI
		JMP BIROUTINE


HELP:
		CALL HELPRINT
		MOV AX,4C00H
		INT 21H
MSGERR:
		MOV DX,OFFSET NOFOUND
		CALL PRINT
		JMP HELP
		MOV AX,4C00H
		INT 21H
CHECKPRXCMEXE:

		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET PRXCMID2
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,0007H
		REP CMPSB
		JNZ CHECKPRXCM5UNREGEXE

		ADD SI,0002H
		MOV DI,OFFSET PRXCMID3
		CLD
		MOV CX,000CH
		REP CMPSB
		JNZ CHECKERROR

		INC SI
		MOV DI,OFFSET PRXCMID4
		CLD
		MOV CX,0003H
		REP CMPSB
		JNZ CHECKERROR

		PUSH DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM4EXEOK
		CALL PRINT
		CALL PAGK

		PUSH CS
		POP DS
		MOV AX,3D00H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0020H
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		POP DS

		MOV SI,[WORD CS:CHILDCSIP]
		MOV [WORD CS:DSEGMENT],DS
		MOV [WORD CS:OFFRUT4],SI
		PUSH CS
		POP DS
		CALL GETATTRIB

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BREAKLOOP
		INT 21H

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		MOV [BYTE CS:ISJUMPINST],00
		MOV [BYTE CS:RETFLOOP],00
		MOV [BYTE CS:LASTLOOP],00

		MOV AH,62H
		INT 21H

		MOV [WORD CS:PID],BX
		MOV ES,BX

		MOV DS,[WORD CS:DSEGMENT]

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		MOV SI,[WORD CS:OFFRUT4]
		ADD SI,0019H
		MOV [WORD DS:SI],0F0CDH
		PUSH ES
		POP DS
		XOR SI,SI
		XOR DI,DI
		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
BREAKLOOP:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFRUT4]
		ADD SI,001DH
S4L:						; Search for loop
		MOV AH,[BYTE DS:SI]
		CMP AH,0E2H ; Es un maldito loop?
		JE PUTBREAKONLOOP
		CMP AH,0E0H ; Es un maldito loopnz?
		JE PUTBREAKONLOOP
		CMP AH,07FH ; Un jump if greater (JG)?
		JE PUTBREAKONLOOP
		CMP AH,075H ; Un jnz ?
		JE PUTBREAKONLOOP
		INC SI
		JMP S4L
PUTBREAKONLOOP:
		MOV AL,[BYTE DS:SI+01H]
		CMP AL,0FDH
		JB CONTPUT1
NOLOOP:
		ADD SI,0002H
		JMP S4L
CONTPUT1:
		CMP AL,0C7H
		JB NOLOOP
CONTPUT:
		CMP AH,0E2H
		JE SIGAMOS
		CMP AH,0E0H
		JE SIGAMOS
		MOV [BYTE CS:ISJUMPINST],01H


SIGAMOS:
		MOV [BYTE CS:TEMPBYTE],AL
		MOV [WORD DS:SI],0F0CDH

		MOV [WORD ES:03C0H],OFFSET BREAKLOOP1
		CMP [BYTE CS:RETFLOOP],01H
		JNE NOLASTLOOP
		MOV [BYTE CS:RETFLOOP],00H
		CALL POPTEMP
		POPF
		IRET


NOLASTLOOP:
		CALL POPTEMP
		MOV DS,BX
		POPF
		IRET
BREAKLOOP1:
		PUSHF
		CALL PUSHTEMP
		CMP [BYTE CS:ISJUMPINST],00
		JNE CONTIBREAK

		DEC CX
CONTIBREAK:
		CMP CX,0000
		JZ ENDLOOP1

		MOV DS,[WORD CS:DSEGMENT]
		MOV AL,[BYTE CS:TEMPBYTE]
		NEG AL
		XOR AH,AH
		MOV BX,SP
		MOV SI,[WORD SS:BX+0002H]
		SUB SI,AX
		MOV [WORD SS:BX+0002H],SI
		PUSH CX
		CALL POPTEMP
		POP CX
		POPF
		IRET
ENDLOOP1:
		MOV [WORD CS:TEMPCX],0000H
		MOV BX,SP
		MOV SI,[WORD SS:BX+0002H]
		MOV DS,[WORD CS:DSEGMENT]

BLOQUENOPS:
		MOV BX,SI
		MOV AL,[BYTE DS:SI]
		CMP AL,0FDH
		JE CHECK4NOPS
		INC SI
		JMP BLOQUENOPS
CHECK4RET12:
		PUSH CS
		POP ES
		MOV DI,OFFSET RETORNO12
		MOV CX,0006H
		CLD
		REP CMPSB
		JZ RETORNARBIEN
		MOV SI,BX
		INC SI
		JMP BLOQUENOPS
RETORNARBIEN:
		MOV [BYTE CS:LASTLOOP],01H
		SUB SI,000EH
		JMP PUTBREAKRETFNOW ; POR FIN!!!!!!!!



CHECK4NOPS:
		PUSH CS
		POP ES
		MOV DI,OFFSET BLOCKNOPS
		MOV CX,0009
		CLD
		REP CMPSB
		JZ SEARCHRETF
		MOV SI,BX
		INC SI
		JMP BLOQUENOPS
SEARCHRETF:
		ADD SI,00011
		MOV [WORD DS:SI],0F0CDH
		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET BREAKONRETF
		CALL POPTEMP
		POPF
		IRET
BREAKONRETF:
		PUSHF
		CALL PUSHTEMP
		MOV BX,SP
		MOV SI,[WORD SS:BX+0002H]
		MOV DS,[WORD CS:DSEGMENT]
SEERETF:
		MOV AX,[WORD DS:SI]
		CMP AX,0E4FAH
		JE CHECKRETF
		CMP AX,0BB50H
		JE CHECK4RET12

		INC SI
		JMP SEERETF
CHECKRETF:
		CMP [WORD DS:SI+0CH],0CBFBH
		JE PUTBREAKRETFNOW
		INC SI
		JMP SEERETF
PUTBREAKRETFNOW:
		MOV [WORD DS:SI+0CH],0F0CDH
		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET SEEIFROUT
		CMP [BYTE CS:LASTLOOP],01H
		JE LASTLOOP1
		CALL POPTEMP
		POPF
		MOV DS,BX
		IRET
LASTLOOP1:
		MOV [WORD ES:03C0H],OFFSET PUTFUCKINGSHIT1
		CALL POPTEMP
		POPF
		MOV DS,BX
		IRET

SEEIFROUT:
		PUSHF
		CALL PUSHTEMP
		MOV BX,SP
		MOV AX,[WORD SS:BX+0008]
		CMP AX,0012H
		JE PUTFUCKINGSHIT1

		MOV SI,[WORD SS:BX+0002H]
		MOV DS,[WORD CS:DSEGMENT]
		SUB SI,0002H
		MOV [WORD SS:BX+0002H],SI

		MOV [WORD DS:SI],0CBFBH
		MOV DS,[WORD SS:BX+0AH]
		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:ISJUMPINST],00
		MOV [BYTE CS:RETFLOOP],01
		MOV [BYTE CS:LASTLOOP],00
		XOR SI,SI
		JMP S4L

PUTFUCKINGSHIT1:
		PUSHF
		CALL PUSHTEMP
		MOV BX,SP

		MOV DS,[WORD SS:BX+0004H]
		MOV SI,[WORD SS:BX+0002H]
		SUB SI,0002H
		MOV [WORD DS:SI],0CB53H
		MOV [WORD SS:BX+0002H],SI


		MOV DS,[WORD CS:TEMPAX]
		MOV [WORD CS:POINTCS],DS

		MOV [WORD CS:OFFRUT4],0026
		MOV BX,[WORD CS:OFFRUT4]
		ADD BX,0029
		MOV ES,[WORD CS:POINTCS]
		MOV [WORD ES:BX],0F0CDH
		XOR AX,AX
		MOV ES,AX

		MOV [WORD ES:03C0H],OFFSET BREAK0EXE
		CALL POPTEMP
		POPF
		IRET




BREAK0EXE:

		MOV SI,0200H
		REP MOVSW
		CALL PUSHTEMP
		MOV BX,[WORD CS:OFFRUT4]
		MOV DS,[WORD CS:POINTCS]
		MOV [WORD DS:BX+4FH],0F0CDH
		MOV [WORD ES:03C0H],OFFSET BREAK1EXE
		CALL POPTEMP
		IRET

BREAK1EXE:
		CALL PUSHTEMP
		MOV BX,[WORD CS:OFFRUT4]
		MOV DS,[WORD CS:POINTCS]
		MOV [WORD DS:BX+0055H],83CDH
		MOV [WORD DS:BX+0057H],03EBH

		LDS DX,[DWORD ES:0000H]
		MOV [WORD CS:OLDINT00],DX
		MOV [WORD CS:OLDINT00+02H],DS
		LDS DX,[DWORD ES:0200H]
		MOV [WORD ES:0000],DX
		MOV [WORD ES:0002],DS
		MOV DS,[WORD CS:POINTCS]
		MOV BX,[WORD ES:020CH]
		MOV [WORD DS:BX+002FH],0F0CDH
		MOV [WORD ES:03C0H],OFFSET BREAK2EXE
		CALL POPTEMP
		IRET
BREAK2EXE:
		CALL PUSHTEMP
		MOV BX,[WORD CS:OFFRUT4]
		MOV DS,[WORD CS:POINTCS]
		MOV [WORD DS:BX+00E4H],082CDH
		MOV [WORD ES:03C0H],OFFSET BREAK3EXE
		MOV [WORD DS:BX+00D8H],0F0CDH
		MOV [BYTE DS:BX+0060H],90H
		MOV [BYTE DS:BX+006DH],90H
		MOV [BYTE DS:BX+007DH],90H
		MOV [BYTE DS:BX+0083H],90H
                MOV [WORD DS:BX+0130H],09090H
                MOV [WORD DS:BX+069H],09090H
                MOV [WORD DS:BX+074H],09090H
                MOV [WORD DS:BX+081H],09090H

                MOV DS,[WORD ES:0002H]
		MOV [WORD DS:0171H],0F0CDH
		CALL POPTEMP
		XOR BL,BL
		IRET
BREAK3EXE:
		CALL PUSHTEMP
		MOV [WORD CS:SIZEEXE1],BP
		MOV [WORD CS:SIZEEXE2],CX
		MOV [WORD ES:03C0H],OFFSET BREAK4EXE
		MOV DS,[WORD ES:0002H]
		MOV [WORD DS:0171H],0F631H
		CALL POPTEMP
		XOR SI,SI
		IRET

BREAK4EXE:
		MOV DI,0200H
		REP MOVSW
		CALL PUSHTEMP
		MOV BX,[WORD CS:OFFRUT4]
		MOV DS,[WORD CS:POINTCS]
		MOV [WORD DS:BX+011CH],0F0CDH
		MOV [WORD ES:03C0H],OFFSET BREAK5EXE
		MOV AL,[BYTE DS:BX+00F7H]
		CMP AL,00F9H
		JZ NOHAYRELOC
HAYRELOC:
		INC [BYTE CS:RELOC]
		MOV [WORD DS:BX+0107H],09090H
		MOV [WORD DS:BX+0109H],09090H
		MOV [BYTE DS:BX+010BH],90H
NOHAYRELOC:
		CALL POPTEMP
		IRET
BREAK5EXE:
		POP AX ; reestablezco ip
		POP AX ;     ' '      cs
		POP AX ;     ' '      Flags  :)
		POP AX ;     ' '      ip ORIGINAL
		MOV [WORD CS:EXEIP],AX
		POP AX ;     ' '      CS ORIGINAL
		MOV [WORD CS:EXECS],AX
		MOV [WORD CS:EXESS],SS
		MOV [WORD CS:EXESP],SP

		CLI
		MOV SS,[WORD CS:INITSSSP]
		MOV SP,[WORD CS:INITSSSP+02H]
		STI

		CMP [BYTE CS:RELOC],01H
		JB NORELOCAT
		MOV [WORD CS:EXEHEAD+0005H],0100H
		MOV [WORD CS:EXEHEAD+0017H],1C00H
		MOV [WORD CS:EXEHEAD+001BH],0700H
		MOV [WORD CS:EXEHEAD+001DH],0000H
NORELOCAT:
		MOV AX,[WORD CS:EXESP]
		MOV BX,[WORD CS:EXEIP]
		ADD AX,0002
		MOV [WORD CS:EXEHEAD+0010H],AX
		MOV [WORD CS:EXEHEAD+0014H],BX
		MOV AX,[WORD CS:EXECS]
		MOV BX,[WORD CS:EXESS]
		MOV CX,DS
		SUB AX,CX
		SUB AX,0010H
		SUB BX,CX
		SUB BX,0010H
		MOV [WORD CS:EXEHEAD+000EH],BX
		MOV [WORD CS:EXEHEAD+0016H],AX
		MOV [WORD CS:EXEHEAD],"ZM"
		MOV AX,25F0H
		LDS DX,[DWORD CS:INTF0IP]
		INT 21H; Last Break Point
SAVEFUCKEXE:
		MOV AX,[WORD CS:SIZEEXE1]
		INC AX
		MOV BX,0010H
		MUL BX
		MOV [WORD CS:HIGHSIZE],DX
		MOV [WORD CS:LOWSIZE],AX
SAVE4LZ:
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV CX,0020H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		PUSH CS
		POP DS
		MOV DX,OFFSET EXEHEAD
		MOV CX,0020H
		CALL WRITEEXE


		MOV CX,[WORD CS:PID]
		ADD CX,0010H
		MOV DS,CX
		MOV DX,0000H
		CMP [WORD CS:HIGHSIZE],0001H
		JNB BLOCKMAYOR
		MOV CX,[WORD CS:LOWSIZE]
		CALL WRITEEXE
		JMP CLOSE
BLOCKMAYOR:
		DEC [WORD CS:HIGHSIZE]
		MOV CX,8000H
		CALL WRITEEXE
		ADD DX,8000H
		MOV CX,8000H
		CALL WRITEEXE
		MOV AX,DS
		ADD AX,1000H
		MOV DS,AX
		MOV DX,0000
		CMP [WORD CS:HIGHSIZE],0001H
		JNB BLOCKMAYOR
		MOV CX,[WORD CS:LOWSIZE]
		CALL WRITEEXE
		JMP CLOSE



WRITEEXE:
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		RETN
CLOSE:
		MOV AH,3EH
		INT 21H

		XOR AX,AX
		MOV ES,AX
		PUSH CS
		POP DS
		MOV SI,OFFSET BACKUPINT
		MOV DI,0
		MOV CX,4*0100H
		CLD
		REP MOVSB

SETSIZE:
		MOV AH,2FH
		INT 21H

		PUSH CS
		POP DS
		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV DX,[WORD ES:009CH]
		MOV AX,[WORD ES:009AH]
		MOV BX,0200H
		XOR CX,CX
		DIV BX
		CMP DX,0000
		JE HEADMUL512
		INC AX
HEADMUL512:
		MOV [WORD CS:EXEHEAD+0004H],AX
		MOV [WORD CS:EXEHEAD+0002H],DX

		CMP [BYTE CS:SCRE2B],01H
		JE SETATTRIBEXE

		MOV SI,OFFSET EXEHEADORIG+000AH
		MOV DI,OFFSET EXEHEAD+000AH
		CLD
		MOV CX,0004H
		PUSH CS
		POP ES
		REP MOVSB


SETATTRIBEXE:
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX
		PUSH CS
		POP DS
		MOV CX,001CH
		MOV DX,OFFSET EXEHEAD
		CALL WRITEEXE
SETATTRIBEXE1:
		MOV BX,[WORD CS:HANDLE]
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H
		MOV AH,3EH
		INT 21H

                PUSH CS
                POP DS
                MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		MOV CX,[WORD CS:ATRIB]
		INT 21H

		PUSH CS
		POP DS

		JMP FIN1
UNPRXCM5COM:
FUCKCOM5:
		MOV [WORD CS:DSEGMENT],DS
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BRK50
		INT 21H
FUCKPRX5:
		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		MOV AH,62H
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV ES,BX

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
PUTJZNZ:
		MOV SI,[WORD CS:VALUEREG]
		CMP [WORD CS:BREAKJZNZ],"NZ"
		JNZ PUTJZ
		MOV AL,[BYTE DS:SI-0001H]
		MOV [BYTE CS:NZNUMBA],AL
		MOV [WORD DS:SI-0002H],0F0CDH
		JMP RUNPROGRAM
PUTJZ:
		MOV [WORD DS:SI-0004H],0F0CDH
RUNPROGRAM:
		MOV AX,ES
		MOV DS,AX
		XOR SI,SI
		XOR DI,DI
		XOR AX,AX
		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]

BRK50:
		PUSHF
		CALL PUSHTEMP
		CMP [WORD CS:BREAKJZNZ],"JZ"
		JE PUTJZBREAK2
		POPF

		JZ GOANDFUCK2
		PUSHF
		MOV AL,[BYTE CS:NZNUMBA]
		CMP AL,80H
		JAE RETRO2
AVANCE2:
		XOR AH,AH
		MOV SI,[WORD CS:VALUEREG]
		SUB SI,0002H
		ADD SI,AX
		ADD SI,0002H
		JMP VEREMOS2
RETRO2:
		NEG AL
		XOR AH,AH
		MOV SI,[WORD CS:VALUEREG]
		SUB SI,0002H
		SUB SI,AX
		ADD SI,0002H
VEREMOS2:

		POPF
		MOV [WORD CS:SIMULATEDJUMP],SI
		MOV [WORD CS:SIMULATEDJUMP+0002H],DS
		POP AX
		POP AX
		POP AX
		CALL POPTEMP
		JMP [DWORD CS:SIMULATEDJUMP]
SIMULATEDJUMP:
		DB 000H,000H,000H,000H
PUTJZBREAK2:
		POPF
		JZ GOANDFUCK
		CALL POPTEMP
		IRET
GOANDFUCK:
		PUSHF
		POP CX

		POP AX
		ADD AX,0002H
		PUSH AX
		PUSH CX
		POPF
GOANDFUCK2:
		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:VALUEREG]
		CMP [BYTE CS:EXEMARK],01H
		JNE NOTEXEPHILE
		CMP [WORD DS:BX+56H],01CDH
		JZ PRXCM5REGD

		PUSH DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PROTECT5EXEOK
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		POP DS

NOTEXEPHILE:
		MOV [WORD DS:BX+02BH],020CH
		MOV [WORD DS:BX+035H],020EH
		MOV [WORD DS:BX+049H],0204H
		MOV [WORD DS:BX+04FH],0206H
		MOV AX,[WORD DS:BX+05BH]
		MOV [WORD CS:TEMPBYTE],AX

		MOV [WORD DS:BX+056H],083CDH
		MOV [WORD DS:BX+058H],0E2ABH
		MOV [BYTE DS:BX+05AH],0FBH
		MOV [WORD DS:BX+05BH],0F0CDH

		MOV [WORD DS:BX+0BBH],081CDH

		MOV [WORD DS:BX+06BH],0204H
		MOV [WORD DS:BX+07EH],0206H
		MOV [WORD DS:BX+083H],020CH
		MOV [WORD DS:BX+087H],020EH
COMMON:
		MOV [WORD ES:03C0H],OFFSET BRK51
		CALL POPTEMP
		IRET
BRK51:
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD CS:TEMPBYTE]
		MOV BX,[WORD CS:VALUEREG]
		MOV [WORD DS:BX+05BH],AX
		PUSHF
		POP CX
		POP AX
		CMP [BYTE CS:REGD],01H
		JNE UNREGD
		ADD AX,003BH
		JMP CONTREGDORUNREGD
UNREGD:
		ADD AX,003AH
CONTREGDORUNREGD:
		PUSH AX
		CMP [BYTE CS:EXEMARK],01H
		JZ BREAK51EXE
		MOV [WORD DS:BX+0E7H],0204H
		MOV [WORD DS:BX+0F1H],0284H
		MOV [WORD DS:BX+0F8H],0204H
		MOV [WORD DS:BX+0110H],0284H
		MOV [WORD DS:BX+015CH],0A1CDH
		MOV [WORD DS:BX+014FH],0F0CDH
		MOV [BYTE DS:BX+0151H],090H
		JMP BREAK51CONT
BREAK51EXE:
		MOV [WORD DS:BX+00EFH],0204H
		MOV [WORD DS:BX+00F9H],0220H
		MOV [WORD DS:BX+0100H],0204H
		MOV [WORD DS:BX+0118H],0220H
		MOV [BYTE DS:BX+016EH],0088H
		MOV [WORD DS:BX+0160H],0F0CDH
		MOV [BYTE DS:BX+0162H],090H
BREAK51CONT:
		MOV [WORD ES:03C0H],OFFSET BRK52
		PUSH CX
		POPF
		CALL POPTEMP
		IRET

BRK52:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		CMP [BYTE CS:EXEMARK],01H
		JE BRK52EXE

		MOV AX,CX
		MOV BX,0002H
		MUL BX
		MOV [WORD CS:FILESIZECOM],AX
		MOV AX,[WORD DS:BX+0161H]
		MOV [WORD CS:TEMPBYTE],AX
		MOV BX,[WORD CS:VALUEREG]
		MOV [WORD DS:BX+015DH],83CDH
		MOV [WORD DS:BX+015FH],0FBE2H
		MOV [WORD DS:BX+0161H],0F0CDH
		JMP ENDBRK52
DATAROUT:
		DB 0CDH,083H,0E2H,0FBH,08CH,0D8H,040H,08EH,0D8H,08EH
		DB 0C0H,0B9H,008H,000H,033H,0F6H,033H,0FFH,02EH,0FFH
		DB 08EH,0D3H,001H,075H,0E6H,0CDH,0F0H
BRK52EXE:
		MOV AX,DS
		MOV ES,AX
		PUSH CS
		POP DS
		MOV SI,OFFSET DATAROUT
		MOV DI,[WORD CS:VALUEREG]
		ADD DI,016EH
		MOV CX,001BH
		CLD
		REP MOVSB
		MOV CX,[WORD ES:BP+01D3H]
		MOV [WORD CS:SIZEEXE1],CX
ENDBRK52:
		PUSHF
		XOR AX,AX
		MOV ES,AX
		POPF
		MOV [WORD ES:03C0H],OFFSET BRK53
		CALL POPTEMP
		POPF
		AND AH,01H
		IRET
BRK53:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		CMP [BYTE CS:EXEMARK],01
		JZ BRK53EXE
		POPF

		MOV AX,[WORD CS:TEMPBYTE]
		MOV BX,[WORD CS:VALUEREG]
		MOV [WORD DS:BX+0161H],AX
		PUSHF
		POP CX
		POP AX
		ADD AX,0016H
		PUSH AX
		PUSH CX
		POPF
		MOV [WORD DS:BX+016EH],0F0CDH
		MOV [WORD DS:BX+0170H],09090H
		MOV [BYTE DS:BX+0172H],090H
		JMP ENDBRK53
BRK53EXE:
		MOV BX,[WORD CS:VALUEREG]
		MOV [BYTE DS:BX+01ADH],81H
		MOV [WORD DS:BX+01F4H],0204H
		MOV [WORD DS:BX+0206H],0220H
		MOV [WORD DS:BX+0287H],0F0CDH
		MOV [WORD DS:BX+0190H],09090H
		MOV [WORD DS:BX+0192H],09090H
		MOV [WORD DS:BX+0194H],09090H
		MOV [WORD DS:BX+0196H],09090H
		MOV [BYTE DS:BX+0198H],090H
		MOV [WORD DS:BX+0190H],0F0CDH

		POPF
		POP AX
		ADD AX,0016H
		PUSH AX

ENDBRK53:
		MOV [WORD ES:03C0H],OFFSET BRK54
		CALL POPTEMP
		IRET
BRK54:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]

		MOV BX,[WORD CS:VALUEREG]
		CMP [BYTE CS:EXEMARK],01
		JZ BRK54EXE

		MOV [BYTE DS:BX+0187H],81H
		MOV [WORD DS:BX+01AEH],0204H
		MOV [WORD DS:BX+01C0H],0284H
		MOV [WORD DS:BX+01F6H],0F0CDH
		JMP ENDBRK54
BRK54EXE:
		MOV CX,[WORD DS:BP+01E9H]
		OR CX,CX
		JZ ENDBRK54EXE

		MOV [WORD CS:CANTRELOC],CX
		MOV [WORD DS:BX+0241H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET BRKINTERMEDIO
		CALL POPTEMP
		POPF
		IRET
BRKINTERMEDIO:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		ADD SI,BP
		ADD SI,01E3H
		MOV [WORD CS:OFFSETRELOC],SI
		MOV [WORD ES:03C0H],OFFSET BRK55EXE
		XOR DI,DI

		MOV AX,DS
		MOV ES,AX
		MOV BX,[WORD CS:VALUEREG]
		MOV DI,0243H
		ADD DI,BX
		MOV CX,0011H
		MOV AL,090H
		REP STOSB
		POPF
		CALL POPTEMP
		IRET

ENDBRK54:
		MOV [WORD ES:03C0H],OFFSET BRK55
		POPF
		CALL POPTEMP
		IRET
ENDBRK54EXE:
		MOV [WORD ES:03C0H],OFFSET BRK55EXE
		POPF
		CALL POPTEMP
		IRET
BRK55:
		POP AX
		POP AX
		POP AX
		POP AX
		POP AX
		MOV AX,25F0H
		LDS DX,[DWORD CS:INTF0IP]
		INT 21H; Last Break Point
		JMP SAVEFUCK2
BRK55EXE:
		POP AX ; reestablezco ip
		POP AX ;     ' '      cs
		MOV [WORD CS:TEMPBYTE],AX
		POP AX ;     ' '      Flags  :)
		POP AX ;     ' '      ip ORIGINAL
		MOV [WORD CS:EXEIP],AX
		POP AX ;     ' '      CS ORIGINAL
		MOV [WORD CS:EXECS],AX
		MOV [WORD CS:EXESS],SS
		MOV [WORD CS:EXESP],SP

		CLI
		MOV SS,[WORD CS:INITSSSP]
		MOV SP,[WORD CS:INITSSSP+02H]
		STI

		MOV CX,[WORD CS:CANTRELOC]
		MOV [WORD CS:EXEHEAD+0006H],CX
		MOV [WORD CS:EXEHEAD+0017H],1C00H

		PUSH DS
		PUSH CS
		POP DS
		MOV AX,3D00H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX


		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0020H
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		POP DS

		MOV AX,[WORD CS:EXESP]
		MOV BX,[WORD CS:EXEIP]
		MOV [WORD CS:EXEHEAD+0010H],AX
		MOV [WORD CS:EXEHEAD+0014H],BX
		MOV AX,[WORD CS:EXECS]
		MOV BX,[WORD CS:EXESS]
		MOV CX,DS
		SUB AX,CX
		SUB AX,0010H
		SUB BX,CX
		SUB BX,0010H
		MOV [WORD CS:EXEHEAD+000EH],BX
		MOV [WORD CS:EXEHEAD+0016H],AX
		MOV [WORD CS:EXEHEAD],"ZM"
		PUSH DS
		MOV AX,25F0H
		LDS DX,[DWORD CS:INTF0IP]
		INT 21H; Last Break Point
		POP DS
SAVEFUCKEXE2:
		MOV AX,[WORD CS:SIZEEXE1]
		MOV BX,0010H
		MUL BX
		MOV [WORD CS:HIGHSIZE],DX
		MOV [WORD CS:LOWSIZE],AX
SAVELZEXE:
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV CX,0020H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		PUSH CS
		POP DS
		MOV DX,OFFSET EXEHEAD
		MOV CX,001CH
		CMP [WORD CS:CANTRELOC],0001H
		JAE SEGUIR
		MOV CX,0020H
SEGUIR:
		CALL WRITEEXE
		CMP [WORD CS:CANTRELOC],0001H
		JB SAVEMODULE
		POP DS
		MOV AX,[WORD CS:CANTRELOC]
		MOV BX,0004H
		MUL BX
		MOV CX,AX
		MOV DX,[WORD CS:OFFSETRELOC]
		PUSH DS
		MOV AX,[WORD CS:TEMPBYTE]
		MOV DS,AX
		CALL WRITEEXE

FIXHEADLENGH:
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		PUSH CS
		POP DS
		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV AH,2FH
		INT 21H

		MOV AX,[WORD ES:009AH]
		MOV BX,0010H
		XOR DX,DX
		DIV BX
		MUL BX
		ADD AX,0010H
		SUB AX,[WORD ES:009AH]
		PUSH AX

		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		POP CX
		CMP CX,0010H
		JNE FOLLOW2
		XOR CX,CX
FOLLOW2:
		MOV DX,OFFSET HEADFILL
		CALL WRITEEXE

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		PUSH CS
		POP DS
		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV AH,2FH
		INT 21H

		MOV AX,[WORD ES:009AH]
		MOV BX,0010H
		XOR DX,DX
		DIV BX
		MOV [WORD CS:EXEHEAD+0008H],AX

		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV CX,001CH
		MOV DX,OFFSET EXEHEAD
		CALL WRITEEXE

		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		POP DS


SAVEMODULE:
		MOV CX,[WORD CS:PID]
		ADD CX,0010H
		MOV DS,CX
		MOV DX,0000H
		CMP [WORD CS:HIGHSIZE],0001H
		JNB BLOCKMAYOR2
		MOV CX,[WORD CS:LOWSIZE]
		CALL WRITEEXE
		JMP CLOSE2
BLOCKMAYOR2:
		DEC [WORD CS:HIGHSIZE]
		MOV CX,8000H
		CALL WRITEEXE
		ADD DX,8000H
		MOV CX,8000H
		CALL WRITEEXE
		MOV AX,DS
		ADD AX,1000H
		MOV DS,AX
		MOV DX,0000
		CMP [WORD CS:HIGHSIZE],0001H
		JNB BLOCKMAYOR2
		MOV CX,[WORD CS:LOWSIZE]
		CALL WRITEEXE
		JMP CLOSE2



CLOSE2:
		MOV AH,3EH
		INT 21H

		XOR AX,AX
		MOV ES,AX
		PUSH CS
		POP DS
		MOV SI,OFFSET BACKUPINT
		MOV DI,0
		MOV CX,4*0100H
		CLD
		REP MOVSB
		JMP SETSIZE

UNPRXCM4:
		MOV DS,[WORD CS:CHILDCSIP+2]
		MOV SI,[WORD CS:CHILDCSIP]
		XOR BX,BX
		MOV AX,[WORD BX+SI+01]
		ADD AX,0103H
		MOV [WORD CS:OFFRUT4],AX
		PUSH DS
		CALL GETATTRIB
		JMP FUCKCOMS
GETATTRIB:
		PUSH ES
		PUSH BX
		PUSH CS
		POP DS
		MOV AX,4300H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21h

		MOV [WORD CS:ATRIB],CX

		MOV AX,3D00H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21h
		MOV [WORD CS:HANDLE],AX

		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0020H
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV AX,5700H
		INT 21H
		MOV [WORD CS:TIME],CX
		MOV [WORD CS:DATE],DX
		MOV AH,3EH
		INT 21H
CHANGEATTRIB:
		MOV AX,4301H
		MOV DX,OFFSET LINEPARAMETERS
		XOR CX,CX
		INT 21h
		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		XOR CX,CX
		INT 21h
		MOV AX,3C00H
		MOV CX,0020H
		PUSH CS
		POP DS
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV BX,AX
		MOV AH,3EH
		INT 21H
		MOV AH,2FH
		INT 21H
		MOV [WORD CS:POINTDTATEMP],BX
		MOV [WORD CS:POINTDTATEMP+02H],ES
		CMP [WORD CS:EXEHEADORIG],"ZM"
		JZ SEEOVERLAY
		CMP [WORD CS:EXEHEADORIG],"MZ"
		JZ SEEOVERLAY
NOHEADER:
		POP BX
		POP ES
		RETN
SEEOVERLAY:
		MOV AH,4EH
		MOV CX,00FFH
		PUSH CS
		POP DS
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H

		CLC
		MOV AX,[WORD CS:EXEHEADORIG+04H]
		CMP [WORD CS:EXEHEADORIG+02H],0000
		JE NOPARTIAL
		DEC AX
NOPARTIAL:
		XOR DX,DX
		MOV BX,0200H
		MUL BX
		CLC
		ADD AX,[WORD CS:EXEHEADORIG+02H]
		ADC DX,0000H
		MOV BX,DX
		LDS DX,[DWORD CS:POINTDTATEMP]
		XCHG BX,DX
		CMP DX,[WORD DS:BX+1CH]
		JE CHECKLSB
		JMP CALCULPOS

CHECKLSB:
		CMP AX,[WORD DS:BX+1AH]
		JE RETURN
		JMP CALCULPOS
RETURN:
		JMP NOHEADER
CALCULPOS:
		MOV [WORD CS:CXHIGH],DX
		MOV [WORD CS:DXLOW],AX
		MOV [BYTE CS:OVERLAY],01H
		JMP RETURN

FUCKCOMS:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BREAK0
		INT 21H
FUCKPROGRAM:
		POP DS
		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		MOV AX,DS
		MOV [WORD CS:DSEGMENT],AX
		MOV ES,AX
		XOR AX,AX
		XOR CX,CX
		XOR DX,DX
		MOV BX,[WORD CS:OFFRUT4]
		ADD BX,0021
		MOV [WORD DS:BX],0F0CDH
		XOR BX,BX
		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]

BREAK0:
                PUSHF
                MOV [WORD CS:FILESIZECOM],BP
		MOV SI,0200H
		REP MOVSW
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:OFFRUT4]
		MOV [WORD DS:BX+4FH],0F0CDH
		MOV [WORD ES:03C0H],OFFSET BREAK1
		CALL POPTEMP
                POPF
		IRET

BREAK1:
                PUSHF
                CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:OFFRUT4]
		MOV [WORD DS:BX+0055H],83CDH
		MOV [WORD DS:BX+0057H],03EBH
		MOV [WORD ES:0202H],DS
		MOV [WORD ES:0206H],DS
		MOV [WORD ES:020AH],DS
		MOV [WORD ES:020EH],DS

		LDS DX,[DWORD ES:0000H]
		MOV [WORD CS:OLDINT00],DX
		MOV [WORD CS:OLDINT00+02H],DS
		LDS DX,[DWORD ES:0200H]
		MOV [WORD ES:0000],DX
		MOV [WORD ES:0002],DS
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:BX+01C9H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET BREAK2
		CALL POPTEMP
                POPF
		IRET
BREAK2:
                PUSHF
                CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:OFFRUT4]
		MOV [WORD DS:BX+00C5H],082CDH
		MOV [WORD ES:03C0H],OFFSET BREAK3
		MOV [WORD DS:BX+00B9H],0F0CDH
		MOV [BYTE DS:BX+0060H],90H
		MOV [BYTE DS:BX+006BH],90H
		MOV [BYTE DS:BX+007BH],90H
		MOV [BYTE DS:BX+0081H],90H
                MOV [WORD DS:BX+0EBH],09090H
                MOV [WORD DS:BX+067H],09090H
                MOV [WORD DS:BX+074H],09090H
                MOV [WORD DS:BX+07FH],09090H
                MOV [WORD DS:BX+0C8H],09090H

		CALL POPTEMP
                POPF
		XOR BL,BL
		IRET
BREAK3:
		MOV DI,0200H
		REP MOVSW
                PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:OFFRUT4]
		MOV [WORD DS:BX+00DCH],0F0CDH
		MOV [WORD ES:03C0H],OFFSET BREAK4
		CALL POPTEMP
                POPF
		IRET
BREAK4:
		POP AX
		POP AX
		POP AX
		POP AX
		POP AX
		MOV AX,25F0H
		LDS DX,[DWORD CS:INTF0IP]
		INT 21H; Last Break Point
SAVEFUCK:
		ADD [WORD CS:FILESIZECOM],000FH
SAVEFUCK2:

		MOV AX,3D02H
		PUSH CS
		POP DS
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

                CMP [BYTE CS:EXE2COMMSOK],01H
                JZ WRITEMODULE
                CMP [WORD CS:EXEHEADORIG],"MZ"
		JZ WRITEHEADER
		CMP [WORD CS:EXEHEADORIG],"ZM"
		JZ WRITEHEADER
		JMP WRITEMODULE
WRITEHEADER:
		MOV [BYTE CS:EXEMARK],01H
		MOV [BYTE CS:HEADORIG],01H

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0020H
		PUSH CS
		POP DS
		MOV DX,OFFSET EXEHEADORIG
		INT 21H


WRITEMODULE:
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,[WORD CS:FILESIZECOM]
		LDS DX,[DWORD CS:CHILDCSIP]
		INT 21H
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		INT 21H

		MOV AH,3EH
		INT 21H
		XOR AX,AX
		MOV ES,AX
		PUSH CS
		POP DS
		MOV SI,OFFSET BACKUPINT
		MOV DI,0
		MOV CX,4*0100H
		CLD
		REP MOVSB
SETATTRIB:
		CMP [BYTE CS:EXEMARK],01H
		JNE SETCOM
		PUSH CS
		POP DS
		PUSH CS
		POP ES
		MOV SI,OFFSET EXEHEADORIG
		MOV DI,OFFSET EXEHEAD
		MOV CX,001CH
		CLD
		REP MOVSB
		JMP SETSIZE
SETCOM:
		MOV AX,3D00H
		PUSH CS
		POP DS
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV BX,AX
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H

		MOV AH,3EH
		INT 21H
		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		MOV CX,[WORD CS:ATRIB]
		INT 21H

		PUSH CS
		POP DS

		JMP FIN1

PUSHTEMP:
		MOV [WORD CS:TEMPAX],AX
		MOV [WORD CS:TEMPBX],BX
		MOV [WORD CS:TEMPCX],CX
		MOV [WORD CS:TEMPDX],DX
		MOV [WORD CS:TEMPDS],DS
		MOV [WORD CS:TEMPES],ES
		MOV [WORD CS:TEMPSI],SI
		MOV [WORD CS:TEMPDI],DI
		XOR AX,AX
		MOV ES,AX
		RETN
POPTEMP:
		MOV AX,[WORD CS:TEMPAX]
		MOV BX,[WORD CS:TEMPBX]
		MOV CX,[WORD CS:TEMPCX]
		MOV DX,[WORD CS:TEMPDX]
		MOV DS,[WORD CS:TEMPDS]
		MOV ES,[WORD CS:TEMPES]
		MOV SI,[WORD CS:TEMPSI]
		MOV DI,[WORD CS:TEMPDI]
		RETN

HELPRINT:
		MOV DX,OFFSET HELPTEXT
		CALL PRINT
		CMP [BYTE CS:BYTEREGISTERED],01H
		JE HELPREGD

		MOV DX,OFFSET HELPNOPATENT
		CALL PRINT
		RET
HELPREGD:
		MOV DX,OFFSET HELPWITHKEY
		CALL PRINT
		MOV DX,OFFSET KEYREPPLY
		CALL PRINT
		RET


INTRO:
		MOV DX,OFFSET INTROTITLE
		CALL PRINT

		MOV AX,3D02H
		MOV DX,OFFSET KEYNAME
		INT 21H
		JC SHOWNOPATENT
		MOV [WORD CS:HANDLE],AX

		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE]
		MOV CX,155
		MOV DX,OFFSET KEYREPPLY
		INT 21H
		CMP AX,155
		JB SHOWNOPATENT

		MOV SI,OFFSET KEYREPPLY
		MOV DI,OFFSET KEYID
		MOV CX,154
		PUSH CS
		POP DS
		PUSH CS
		POP ES
		CLD
		REP CMPSB
		JNZ SHOWNOPATENT

		LODSB
		CMP AL,0E0H
		JE KEYOK
		CMP AL,0E1H
		JE KEYOK
		CMP AL,0E2H
		JE KEYOK
		CMP AL,0E3H
		JE KEYOK
		JMP SHOWNOPATENT
KEYOK:
		MOV [BYTE CS:KEYTYPE],AL

		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE]
		MOV CX,42
		MOV DX,OFFSET KEYREPPLY
		INT 21H
		CMP AX,0042
		JNE SHOWNOPATENT

		MOV SI,OFFSET KEYREPPLY
		MOV DI,SI
		MOV CX,0042
		MOV BL,[BYTE CS:KEYTYPE]
DECRYPT:
		LODSB
		XOR AL,BL
		STOSB
		SUB BL,22h
		LOOP DECRYPT

		MOV SI,OFFSET KEYREPPLY
		MOV DI,SI
		MOV CX,0040
		MOV BL,[BYTE CS:KEYTYPE]
		XOR DX,DX
		XOR AX,AX
CHECKSUM:
		LODSB
		ADD DX,AX
		LOOP CHECKSUM

		CMP DX,[WORD CS:SI]
		JNE SHOWNOPATENT

		MOV [BYTE CS:BYTEREGISTERED],01H

		CMP [BYTE CS:KEYTYPE],0E0H
		JE SHOWREGISTERED
		CMP [BYTE CS:KEYTYPE],0E1H
		JE SHOWBETATESTER
		CMP [BYTE CS:KEYTYPE],0E2H
		JE SHOWDISTROSITE
		CMP [BYTE CS:KEYTYPE],0E3H
		JE SHOWSPECIAL
SHOWREGISTERED:
		MOV DX,OFFSET REGISTERED
		CALL PRINT
		RETN
SHOWBETATESTER:
		MOV DX,OFFSET BETA
		CALL PRINT
		RETN
SHOWDISTROSITE:
		MOV DX,OFFSET DISTROSITE
		CALL PRINT
		RETN
SHOWSPECIAL:
		MOV DX,OFFSET SPECIAL
		CALL PRINT
		RETN
SHOWNOPATENT:
		MOV DX,OFFSET NOPATENT
		CALL PRINT
		RETN
PRINT:
		PUSH CS
		POP  DS
		MOV AH,09H
		INT 21H
                RETN

PAGK: ; Press And Get Key :)

		PUSH CS
		POP  DS
		MOV AH,09H
		MOV DX,OFFSET REMOVE
		INT 21H
GETKEY:
		MOV AH,08H
		INT 21H
		CMP AL,79H
		JE LETCONT
		CMP AL,59H
		JE LETCONT
		CMP AL,4EH
		JE DONTCONT
		CMP AL,6EH
		JE DONTCONT
		JMP GETKEY
LETCONT:
		CALL PRINTCHAR
		RETN
DONTCONT:
		CALL PRINTCHAR
		POP AX
		MOV DX,OFFSET CARRIAGE
		CALL PRINT
		JMP FIN2

PRINTCHAR:
		MOV AH,02H
		MOV DL,AL
		INT 21H
		RETN

DTANORMAL:
		MOV AH,1AH
		LDS DX,[DWORD CS:DTAPOINTERS]
		INT 21H
		RETN

PRXCM5REGD:
		MOV [BYTE CS:REGD],01H
		PUSH DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PROTECT5REGDEXEOK
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		POP DS

		MOV [WORD DS:BX+02BH],0204H
		MOV [WORD DS:BX+035H],0206H
		MOV [WORD DS:BX+049H],020CH
		MOV [WORD DS:BX+04FH],020EH
		MOV AX,[WORD DS:BX+05BH]
		MOV [WORD CS:TEMPBYTE],AX

                MOV [WORD DS:BX+056H],081CDH
                MOV [WORD DS:BX+05BH],0F0CDH

                MOV [WORD DS:BX+06CH],020CH
                MOV [WORD DS:BX+07FH],020EH
                MOV [WORD DS:BX+084H],0204H
                MOV [WORD DS:BX+088H],0206H
                ;MOV [WORD CS:JMPFAR+02H],@CURSEG
		MOV [WORD CS:JMPFAR],OFFSET JUMPEDDATA2
		MOV SI,00BDH
		ADD SI,BX

		MOV DI,OFFSET JUMPEDDATA2+02H

		PUSHF
		PUSH DS
		PUSH ES
		PUSH CS
		POP ES
		MOV CX,0006H
		CLD
		REP MOVSB

		MOV CX,0005H
		MOV SI,OFFSET JMPINST
		MOV DI,00BCH
		ADD DI,BX
		PUSH DS
		POP ES
		PUSH CS
		POP DS
		CLD
		REP MOVSB


		POP ES
		POP DS
		POPF
		JMP COMMON
JMPINST:
		DB 0EAH
JMPFAR:
		DB 00,00,00,00
JUMPEDDATA2:
		DB 0CDH,83H,0,0,0,0,0,0
CHECKSCRE2B:
		PUSH CS
		POP ES
		MOV SI,0100H
		MOV DI,OFFSET SCRE2B102A
		MOV CX,000AH
		CLD
		REP CMPSB
		JNE CHECKEXE

		MOV DX,DS
		ADD DX,[WORD DS:010CH]
		MOV DS,DX
		XOR SI,SI
		MOV DI,OFFSET SCRE2B102B
		MOV CX,050
		CLD
		REP CMPSB
		JNE CHECKEXE

		MOV SI,003CH
		MOV DI,OFFSET SCRE2B102C
		MOV CX,0015
		CLD
		REP CMPSB
		JNE CHECKEXE

		MOV SI,0070H
		MOV DI,OFFSET SCRE2B102D
		MOV CX,0027
		CLD
		REP CMPSB
		JNE CHECKEXE

		PUSH DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET SCRE2B102OK
		CALL PRINT
		CALL PAGK

		MOV [BYTE CS:SCRE2B],01H
		CALL GETATTRIB

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BREAKSCR0
		INT 21H
		POP DS

		MOV [WORD CS:TEMPBYTE],DS
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV AX,DS
		SUB AX,BX
		SUB AX,0010H
		MOV [WORD CS:SIZEEXE1],AX
		MOV [WORD DS:0011H],0F0CDH

		PUSH DS
		PUSH CS
		POP DS

		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H

		POP DS

		MOV AX,[WORD CS:DTA+001AH]
		MOV CX,AX
		MOV BX,0010H
		XOR DX,DX
		DIV BX
		XOR DX,DX
		MUL BX
		SUB CX,AX
		DIV BX
		CMP CX,0000
		JE ENTERO
		INC AX
ENTERO:
		MOV CX,[WORD DS:0032H]
		CMP CX,0FFFFH
		JE PUTALLMEM
		SUB CX,AX
		SUB CX,0010H
PUTALLMEM:
		MOV [WORD CS:EXEHEAD+000CH],CX
		MOV CX,[WORD DS:003AH]
		SUB CX,AX
		SUB CX,0010H
		MOV [WORD CS:EXEHEAD+000AH],CX

STARTSCRE2B:
		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		MOV AX,[WORD CS:PID]
		MOV DS,AX
		MOV ES,AX
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI
		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]

BREAKSCR0:
		PUSHF
		PUSH AX
		CALL PUSHTEMP
		POP AX

		MOV [WORD CS:EXEHEAD+0006H],AX
		MOV [WORD CS:EXEHEAD+0017H],1C00H
		MOV [WORD CS:CANTRELOC],AX
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		CMP [WORD CS:CANTRELOC],0001H
		JB NOHAYRELOCA
		MOV CX,001CH
		JMP SAVEHEADER
NOHAYRELOCA:
		MOV CX,0020H
SAVEHEADER:
		PUSH CS
		POP DS
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV DX,OFFSET EXEHEAD
		INT 21H

		MOV AX,[WORD CS:CANTRELOC]
		MOV BX,0004H
		MUL BX
		MOV CX,AX

		MOV DS,[WORD CS:TEMPBYTE]
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV DX,SI
		INT 21H

FIXFUCKINGHEAD:
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		PUSH CS
		POP DS

		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV ES,[WORD CS:PID]

		MOV AX,[WORD ES:009AH]
		MOV BX,0010H
		XOR DX,DX
		DIV BX
		MUL BX
		ADD AX,0010H
		SUB AX,[WORD ES:009AH]
		PUSH AX

		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		POP CX
		CMP CX,0010H
		JNE FOLLOWSCRE2B
		XOR CX,CX
FOLLOWSCRE2B:
		MOV DX,OFFSET HEADFILL
		CALL WRITEEXE

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		PUSH CS
		POP DS
		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		MOV AH,2FH
		INT 21H

		MOV AX,[WORD ES:009AH]
		MOV BX,0010H
		XOR DX,DX
		DIV BX
		MOV [WORD CS:EXEHEAD+0008H],AX

		MOV AX,[WORD CS:SIZEEXE1]
		MOV BX,0010H
		MUL BX
		MOV [WORD CS:HIGHSIZE],DX
		MOV [WORD CS:LOWSIZE],AX

		MOV DS,[WORD CS:TEMPBYTE]
		MOV [WORD DS:0086H],0F0CDH
		MOV AL,090H
		PUSH DS
		POP ES
		MOV DI,0015H
		MOV CX,0013
		CLD
		REP STOSB

		XOR AX,AX
		MOV ES,AX

		MOV [WORD ES:03C0H],OFFSET BREAKSCR1

		CALL POPTEMP
		POPF
		MOV CX,AX

		IRET
BREAKSCR1:
		POP AX
		POP AX
		POP AX
		MOV AX,25F0H
		LDS DX,[DWORD CS:INTF0IP]
		INT 21H; Last Break Point
		MOV DS,[WORD CS:TEMPBYTE]

		MOV AX,[WORD DS:008DH]
		MOV BX,[WORD DS:008FH]
		MOV [WORD CS:EXEHEAD+0010H],AX
		MOV [WORD CS:EXEHEAD+0014H],BX
		MOV AX,[WORD DS:0091H]
		MOV BX,[WORD DS:008BH]

		MOV CX,[WORD CS:PID]
		SUB AX,CX
		SUB AX,0010H
		SUB BX,CX
		SUB BX,0010H
		MOV [WORD CS:EXEHEAD+000EH],BX
		MOV [WORD CS:EXEHEAD+0016H],AX

		JMP SAVEMODULE
CHECKPRXCM3XCOM:
		PUSH CS
		POP ES
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET PROTECT3XGEN
		MOV CX,0044
		CLD
		REP CMPSB
		JNZ CHECKPROTECT5COM
		MOV SI,[WORD CS:OFFSALTO]
		MOV AX,[WORD DS:SI+002CH]
		MOV SI,AX
		MOV AX,[WORD DS:SI+001CH]
		CMP AX,00FFH
		JZ PRXCM31COMOK
		CMP AX,0100H
		JZ PRXCM30COMOK
		JMP CHECKERROR
PRXCM31COMOK:
		PUSH DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM31COM
		CALL PRINT
		CALL PAGK
PRXCM3XGENERIC:
		CALL GETATTRIB
		POP DS
		MOV BX,[WORD CS:OFFSALTO]
		MOV [WORD DS:BX+0FH],0204H
		MOV [WORD DS:BX+14H],0206H
		MOV [WORD DS:BX+19H],020CH
		MOV [WORD DS:BX+1EH],020EH
		MOV [WORD DS:BX+25H],0206H
		MOV [WORD DS:BX+2AH],0204H
		MOV [WORD DS:BX+30H],020EH
		MOV [WORD DS:BX+35H],020CH
		MOV [WORD DS:BX+3AH],81CDH
		PUSH DS

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BRKPRX31COM0
		INT 21H

		POP DS
		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		MOV AX,DS
		MOV [WORD CS:DSEGMENT],AX
		MOV ES,AX
		XOR AX,AX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI
		MOV BX,[WORD CS:OFFSALTO]
		ADD BX,016BH
		MOV [WORD DS:BX],0F0CDH
		MOV [WORD DS:BX+02H],09090H
		MOV [WORD DS:BX+04H],09090H



		XOR BX,BX
		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]

BRKPRX31COM0:
		PUSHF
		CALL PUSHTEMP

		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:OFFSALTO]
		MOV [BYTE DS:BX+0143H],0CFH
		MOV [WORD DS:BX+79H],0204H
		MOV [BYTE DS:BX+90H],090H
		MOV [WORD DS:BX+0BAH],081CDH
		MOV [WORD DS:BX+0D6H],020CH
		MOV [WORD DS:BX+0DEH],0204H
		MOV AX,[WORD DS:BX+097H]
		MOV [WORD CS:FILESIZECOM],AX
		MOV [WORD DS:BX+141H],0F0CDH

		MOV [WORD ES:03C0H],OFFSET BRKPRX31COM1

		CALL POPTEMP
		POPF
		IRET
BRKPRX31COM1:
		POP AX
		POP AX
		POP AX
		MOV AX,25F0H
		LDS DX,[DWORD CS:INTF0IP]
		INT 21H; Last Break Point
		JMP SAVEFUCK2
PRXCM30COMOK:
		PUSH DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM30COM
		CALL PRINT
		CALL PAGK
		JMP PRXCM3XGENERIC
CHECKPRXCM31EXE:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET PRXCM31EXEID
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,88
		REP CMPSB
		JNZ CHECKPRXCM30EXE


		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM31EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		XOR BX,BX
		MOV [WORD DS:BX+4BH],0204H
		MOV [WORD DS:BX+55H],020CH
		MOV [WORD DS:BX+5CH],0204H
		MOV [WORD DS:BX+5FH],020CH
		MOV [WORD DS:BX+85H],081CDH

		MOV [WORD DS:BX+1FFH],0F0CDH
		MOV [WORD DS:BX+201H],9090H
		MOV [WORD DS:BX+203H],9090H




		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BRKPRX31EXE0
		INT 21H

		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
BRKPRX31EXE0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV [BYTE DS:01D4H],0CFH
		MOV [WORD DS:00DDH],0204H
		MOV [BYTE DS:00ECH],090H
		MOV [WORD DS:012EH],081CDH
		MOV [BYTE DS:01B2H],090H
                MOV [WORD DS:01B7H],09090H
                MOV [BYTE DS:01B9H],090H
		MOV [WORD DS:01D1H],0F0CDH
		MOV AX,[WORD DS:0014H]
		MOV [WORD CS:SIZEEXE1],AX

		MOV [WORD ES:03C0H],OFFSET BRKPRX31EXE1


		CALL POPTEMP
		POPF

		IRET
BRKPRX31EXE1:
		JMP BRK55EXE
CHECKPRXCM30EXE:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET PRXCM30EXEID
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,88
		REP CMPSB
		JNZ CHECKLZEXE091
		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM30EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		XOR BX,BX
		MOV [WORD DS:BX+4CH],0204H
		MOV [WORD DS:BX+54H],0206H
		MOV [WORD DS:BX+5CH],020CH
		MOV [WORD DS:BX+64H],020EH
		MOV [WORD DS:BX+70H],0206H
		MOV [WORD DS:BX+75H],0204H
		MOV [WORD DS:BX+7BH],020EH
		MOV [WORD DS:BX+80H],020CH
		MOV [WORD DS:BX+85H],081CDH

		MOV [WORD DS:BX+1FFH],0F0CDH
		MOV [WORD DS:BX+201H],9090H
		MOV [WORD DS:BX+203H],9090H




		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BRKPRX30EXE0
		INT 21H

		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
BRKPRX30EXE0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV [BYTE DS:01D4H],0CFH
		MOV [WORD DS:00DDH],0204H
		MOV [BYTE DS:00ECH],090H
		MOV [WORD DS:012EH],081CDH
		MOV [BYTE DS:01B2H],090H
                MOV [WORD DS:01B7H],09090H
                MOV [BYTE DS:01B9H],090H
		MOV [WORD DS:01D1H],0F0CDH
		MOV AX,[WORD DS:0016H]
		MOV [WORD CS:SIZEEXE1],AX
		MOV [WORD ES:03C0H],OFFSET BRKPRX30EXE1
		CALL POPTEMP
		POPF

		IRET
BRKPRX30EXE1:
		JMP BRK55EXE
CHECKPRXCM20COM:
		PUSH CS
		POP ES
		MOV SI,0103H
		MOV DI,OFFSET PRXCM20COMID1
		MOV CX,0008H
		CLD
		REP CMPSB
		JZ SECONDCHECK
		JMP CHECKPRXCM1XCOM
SECONDCHECK:
		MOV SI,0150H
		MOV DI,OFFSET PRXCM20COMID2
		MOV CX,0018
		CLD
		REP CMPSB
		JZ CHECK20OK
		JMP CHECKERROR
CHECK20OK:
		MOV [WORD CS:DSEGMENT],DS
		MOV AX,[WORD DS:0101H]
		MOV [WORD CS:OFFSALTO],AX
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM20COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:0178H]
		MOV [WORD CS:TEMPBYTE],AX
		MOV [WORD DS:0178H],0F0CDH


		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BRKPRX20COM0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
BRKPRX20COM0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD CS:TEMPBYTE]
		MOV [WORD DS:0178H],AX
		MOV BX,[WORD CS:OFFSALTO]
		MOV [WORD DS:BX+56H],0F0CDH
		MOV AX,[WORD DS:BX+0029H]
		MOV [WORD CS:FILESIZECOM],AX
		MOV BX,SP
		MOV [WORD SS:BX+0002H],0178H

		MOV [WORD ES:03C0H],OFFSET BRKPRX20COM1
		CALL POPTEMP
		POPF
		IRET
BRKPRX20COM1:
		POP AX
		JMP BRKPRX31COM1
CHECKPRXCM20EXE:
		MOV SI,00EAH
		MOV DI,OFFSET PRXCM20EXEID
		MOV CX,40
		CLD
		REP CMPSB
		JZ PRXCM20EXEOK
		JMP CHECKPRXCM11EXE
PRXCM20EXEOK:
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM20EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0132H],0F0CDH
		MOV [WORD DS:0134H],09090H
		MOV [WORD DS:0136H],09090H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BRKPRX20EXE0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
BRKPRX20EXE0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV [BYTE DS:007FH],90H
		MOV [WORD DS:015CH],0F0CDH
		MOV AX,[WORD DS:00A7H]
		MOV [WORD CS:SIZEEXE1],AX
		MOV [WORD ES:03C0H],OFFSET BRKPRX20EXE1
		CALL POPTEMP
		POPF
		IRET
BRKPRX20EXE1:
		JMP BRK55EXE
CHECKPRXCM1XCOM:
		MOV SI,0103H
		MOV DI,OFFSET PRXCM1XCOMID1
		MOV CX,0004
		CLD
		REP CMPSB
		JZ NDCHECK
JUMPNDRETURN:
		XOR BX,BX
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DS,[WORD CS:CHILDCSIP+02]
		MOV AL,[BX+SI]
                JMP CHECKTHEREST
NDCHECK:
		MOV SI,[WORD DS:0101H]
		MOV DI,OFFSET PRXCM1XCOMID2
		MOV CX,0010H
		CLD
		REP CMPSB
		JZ PRXCM1XCOMOK
                JMP JUMPNDRETURN

PRXCM1XCOMOK:
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM1XCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		MOV DS,[WORD CS:DSEGMENT]

		MOV BX,[WORD DS:0101H]
		MOV [WORD CS:OFFSALTO],BX

		MOV [WORD DS:BX+003DH],0F0CDH


		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BRKPRX1XCOM0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
BRKPRX1XCOM0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:OFFSALTO]
		MOV AX,[WORD DS:BX+0021H]
		MOV [WORD CS:FILESIZECOM],AX
		CALL POPTEMP
		POPF

		POP AX
		JMP BRKPRX31COM1
CHECKPRXCM11EXE:
		MOV SI,00CEH
		MOV DI,OFFSET PRXCM11EXEID
		MOV CX,40
		CLD
		REP CMPSB
		JZ PRXCM11EXEOK
		JMP CHECKPRXCM10EXE
PRXCM11EXEOK:
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM11EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]

		MOV AX,[WORD DS:0107H]
		MOV [WORD CS:TEMPBYTE],AX
		MOV [WORD DS:0107H],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BRKPRX11EXE0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
BRKPRX11EXE0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0129H],0F0CDH

		MOV AX,[WORD CS:TEMPBYTE]
		MOV [WORD DS:0107H],AX

		MOV AX,[WORD DS:008BH]
		MOV [WORD CS:SIZEEXE1],AX
		MOV [WORD ES:03C0H],OFFSET BRKPRX11EXE1
		MOV BX,SP
		MOV [WORD SS:BX+0002H],0107H
		CALL POPTEMP
		POPF
		IRET
BRKPRX11EXE1:
		JMP BRK55EXE
CHECKPRXCM10EXE:
		MOV SI,00CEH
		MOV DI,OFFSET PRXCM10EXEID
		MOV CX,43
		CLD
		REP CMPSB
		JZ PRXCM10EXEOK
		JMP CHECKUTILCODED
PRXCM10EXEOK:
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PRXCM10EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]

		MOV AX,[WORD DS:0107H]
		MOV [WORD CS:TEMPBYTE],AX
		MOV [WORD DS:0107H],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BRKPRX10EXE0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
BRKPRX10EXE0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0129H],0F0CDH

		MOV AX,[WORD CS:TEMPBYTE]
		MOV [WORD DS:0107H],AX

		MOV AX,[WORD DS:008BH]
		MOV [WORD CS:SIZEEXE1],AX
		MOV [WORD ES:03C0H],OFFSET BRKPRX10EXE1
		MOV BX,SP
		MOV [WORD SS:BX+0002H],0107H
		CALL POPTEMP
		POPF
		IRET
BRKPRX10EXE1:
		JMP BRK55EXE
CHECKLZEXE091:
		MOV SI,0136H
		MOV DI,OFFSET LZEXE091ID
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
                MOV CX,25
		REP CMPSB
		JNZ CHECKLZEXE090

		CLC
		MOV [WORD CS:DSEGMENT],DS
		MOV [WORD DS:00FCH],0F0CDH

                MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET LZEXE091
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET LZEXE91BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
LZEXE91BRK0:
		PUSHF
		MOV [WORD CS:PARAES],ES
		MOV [WORD CS:PARADI],DI
		CALL PUSHTEMP
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

                MOV BX,SP
                MOV AX,[WORD SS:BX+04]
                MOV [WORD CS:DSEGMENT],AX

                MOV DS,[WORD CS:DSEGMENT]

		MOV [WORD DS:0109H],0F0CDH
		MOV [WORD DS:010BH],09090H
		MOV [BYTE DS:010DH],90H
		MOV [WORD DS:011FH],0F0CDH
		MOV [BYTE DS:0121H],90H
		MOV [WORD ES:03C0H],OFFSET LZEXE91BRK1
		CALL POPTEMP
		MOV DS,[WORD CS:DSEGMENT]
		POPF
		IRET
LZEXE91BRK1:
		PUSHF
		CMP [BYTE CS:RELOCAPPLY],01H
		JZ SAVERELOC
		CALL PUSHTEMP
		LODSB
		OR AL,AL
		JZ CHECKAXEQUALONE

		MOV [BYTE CS:RELOCAPPLY],01H
		POP AX
		XOR AX,0040H
		PUSH AX
		CALL POPTEMP
		POPF
		LODSB
		IRET
CHECKAXEQUALONE:
		MOV BX,SP
		MOV [WORD SS:BX+0002H],0124H
		LODSW
		CMP AX,0001H
		JE NORMAL
		CMP AX,0000H
		JZ ITZERO
		MOV [BYTE CS:RELOCAPPLY],01H
ITZERO:
		POP AX
		XOR AX,0040H
		PUSH AX
		INC [WORD CS:TEMPSI]
		CALL POPTEMP
		POPF
		IRET
NORMAL:
		MOV [WORD DS:0150H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET LZEXE091ENDBRK
		INC [WORD CS:TEMPSI]
		CALL POPTEMP
		POPF
		IRET




SAVERELOC:
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPES]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV ES,AX
		MOV [WORD CS:DATAES],ES
		MOV [WORD CS:DATADI],DI
		PUSH CS
		POP DS
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0002H
		MOV DX,OFFSET DATADI
		INT 21H
		PUSH CS
		POP DS
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0002H
		MOV DX,OFFSET DATAES
		INT 21H
		MOV [BYTE CS:RELOCAPPLY],00H
		INC [WORD CS:CANTRELOC]
		CALL POPTEMP
		POPF
		IRET
LZEXE091ENDBRK:
		POP AX
		POP AX
		POP AX

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD CS:EXEHEADORIG+0006],AX
		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:0000H]
		MOV [WORD CS:EXEHEADORIG+0014H],AX
		MOV AX,[WORD DS:0002H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		CLC
		MOV [WORD CS:EXEHEADORIG+0016H],AX
		MOV [WORD CS:EXEHEADORIG+0010H],DI
		MOV AX,SI
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+000EH],AX
SAVECOMMON:
		CALL FIXHEADLENGTH
SAVECOMMON3:
                MOV AX,3D02H
		PUSH CS
		POP DS
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		MOV AX,[WORD CS:PID]
		ADD AX,0010H
		MOV DS,AX
WRITEONCEAGAIN:
		MOV AX,[WORD CS:PARAES]
		MOV BX,DS
		CMP AX,BX
		JE WRITETHEBLOCK

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0010H
		XOR DX,DX
		INT 21H

		MOV AX,DS
		INC AX
		MOV DS,AX
		JMP WRITEONCEAGAIN
WRITETHEBLOCK:
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,[WORD CS:PARADI]
		XOR DX,DX
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		CMP [BYTE CS:FAKEPK],01H
		JNE CONTSAVING
		CALL FAKEPKLITE
CONTSAVING:
		CMP [BYTE CS:SCRE2B],01H
		JE SETSIZE
		CMP [BYTE CS:EPW],01H
		JE HEADORIGOK
		CALL SETRESERVEDMEM

HEADORIGOK:

		PUSH CS
		POP DS
		PUSH CS
		POP ES
		MOV SI,OFFSET EXEHEADORIG
		MOV DI,OFFSET EXEHEAD
		MOV CX,001CH
		CLD
		REP MOVSB

		JMP SETSIZE

CHECKLZEXE090:
                MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET LZEXE090ID
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
                MOV CX,43
		REP CMPSB
		JNZ CHECKPKLITE100COM
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET LZEXE090
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		CLC
		MOV DS,[WORD CS:DSEGMENT]
		MOV [BYTE DS:003FH],0EBH
		MOV [WORD DS:0130H],0F0CDH
		MOV AX,[WORD DS:000AH]
		ADD [WORD CS:DSEGMENT],AX


		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET LZEXE90BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
LZEXE90BRK0:
		PUSHF
		MOV [WORD CS:PARAES],ES
		MOV [WORD CS:PARADI],DI
		CALL PUSHTEMP
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]

		MOV [WORD DS:014EH],0F0CDH
		MOV [BYTE DS:0150H],90H
		MOV [BYTE DS:0189H],042H
		MOV [WORD DS:018BH],0F0CDH
		MOV [WORD ES:03C0H],OFFSET LZEXE90BRK1
		CALL POPTEMP
		MOV DS,[WORD CS:DSEGMENT]
		POPF
		IRET
LZEXE90BRK1:
		PUSHF
		CALL PUSHTEMP
		CMP DX,0F001H
		JE ENDBRKLZ09

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
ENDBRKLZ09:
		MOV [WORD CS:TEMPSI],SI
		MOV [WORD CS:TEMPDI],DI
		CALL POPTEMP
		POPF
		JMP LZEXE091ENDBRK

		IRET
SAVERELOC2:
		MOV AX,[WORD CS:TEMPES]
		CMP [BYTE CS:EPW],01H
		JNZ SEGMENTNORMAL
		MOV AX,[WORD CS:TEMPAX]
		JMP SEGNORM2
SEGMENTNORMAL:
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
SEGNORM2:
		MOV ES,AX
		MOV [WORD CS:DATAES],ES
		CMP [BYTE CS:COMPRTYPE],01H
		JZ COMPACKCOMPR
                CMP [BYTE CS:COMPRTYPE],02H
                JZ TINYCOMPR1
                CMP [BYTE CS:COMPRTYPE],03H
                JZ TINYCOMPR2
                MOV DI,[WORD CS:TEMPDI]
		MOV [WORD CS:DATADI],DI
		JMP SAVERELOCOMMON
COMPACKCOMPR:
		MOV BX,[WORD CS:TEMPBX]
		MOV [WORD CS:DATADI],BX
		JMP SAVERELOCOMMON
TINYCOMPR1:
                MOV DI,[WORD CS:TEMPDI]
                ADD DI,0FDFEH
                MOV [WORD CS:DATADI],DI
		JMP SAVERELOCOMMON
TINYCOMPR2:
                MOV DI,[WORD CS:TEMPDI]
                ADD DI,[WORD CS:TEMPBX]
                MOV [WORD CS:DATADI],DI
		JMP SAVERELOCOMMON

SAVERELOCOMMON:

		PUSH CS
		POP DS
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0002H
		MOV DX,OFFSET DATADI
		INT 21H
		PUSH CS
		POP DS
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0002H
		MOV DX,OFFSET DATAES
		INT 21H
		INC [WORD CS:CANTRELOC]
                CMP [BYTE CS:LEJOS],01H
                JZ SALTARLEJOS
		RET
SALTARLEJOS:
                RETF
FIXHEADLENGTH:
		PUSH CS
		POP DS
		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

                MOV AH,2FH
		INT 21H

		MOV AX,[WORD ES:009AH]
		MOV BX,0010H
		XOR DX,DX
		DIV BX
		MUL BX
		ADD AX,0010H
		SUB AX,[WORD ES:009AH]
		PUSH AX

                MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

                MOV [WORD CS:HANDLE],AX

		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		POP CX
		CMP CX,0010H
		JNE WRITEFILL
		XOR CX,CX
WRITEFILL:
		MOV DX,OFFSET HEADFILL
		CALL WRITEEXE

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		PUSH CS
		POP DS
		MOV AH,4EH
		MOV CX,00FFH
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV AH,2FH
		INT 21H

		MOV AX,[WORD ES:009AH]
		MOV BX,0010H
		XOR DX,DX
		DIV BX
		MOV [WORD CS:EXEHEADORIG+0008H],AX

		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		CALL WRITEEXE
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		RET
CHECKCRUNCH11:
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET CRUNCH11ID1
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,4
		REP CMPSB
		JNZ CHECKCRUNCH12

		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0008H
		MOV DI,OFFSET CRUNCH11ID2
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,10
		REP CMPSB
		JNZ CHECKCRUNCH12
		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0020
		MOV DI,OFFSET CRUNCH11ID3
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,4
		REP CMPSB
		JNZ CHECKCRUNCH12
		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0025
		MOV DI,OFFSET CRUNCH11ID4
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,5
		REP CMPSB
		JNZ CHECKCRUNCH12

		MOV [WORD CS:DSEGMENT],DS


		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET CRUNCH11
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]

		MOV BX,[WORD CS:OFFSALTO]

		MOV [WORD DS:BX+0019H],0F0CDH

		MOV AX,[WORD DS:BX+0006]
		ADD AX,0003

		MOV [WORD CS:FILESIZECOM],AX


		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET CRUNCH11BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
CRUNCH11BRK0:
		JMP BRKPRX31COM1
CHECKCRUNCH12:
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET CRUNCH12ID1
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,10
		REP CMPSB
		JNZ CHECKCRUNCH13

		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0013
		MOV DI,OFFSET CRUNCH12ID2
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,4
		REP CMPSB
		JNZ CHECKCRUNCH13

		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0008+13
		MOV DI,OFFSET CRUNCH12ID3
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,10
		REP CMPSB
		JNZ CHECKCRUNCH13
		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0020+13
		MOV DI,OFFSET CRUNCH12ID4
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,4
		REP CMPSB
		JNZ CHECKCRUNCH13
		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0025+13
		MOV DI,OFFSET CRUNCH12ID5
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,5
		REP CMPSB
		JNZ CHECKCRUNCH13

		MOV [WORD CS:DSEGMENT],DS


		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET CRUNCH12
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]

		MOV BX,[WORD CS:OFFSALTO]

		MOV [WORD DS:BX+0029H],0F0CDH

		MOV AX,[WORD DS:BX+0019]
		ADD AX,0003

		MOV [WORD CS:FILESIZECOM],AX

		PUSH DS
		POP ES

		MOV DI,BX

		MOV AL,090H
		MOV CX,0013
		CLD
		REP STOSB



		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET CRUNCH12BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
CRUNCH12BRK0:
		JMP BRKPRX31COM1
CHECKCRUNCH13:
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET CRUNCH13ID1
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,10
		REP CMPSB
		JNZ CHECKPRXCM3XCOM

		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0013
		MOV DI,OFFSET CRUNCH13ID2
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,4
		REP CMPSB
		JNZ CHECKPRXCM3XCOM

		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0022
		MOV DI,OFFSET CRUNCH13ID3
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,12
		REP CMPSB
		JNZ CHECKPRXCM3XCOM
		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0036
		MOV DI,OFFSET CRUNCH13ID4
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,4
		REP CMPSB
		JNZ CHECKPRXCM3XCOM
		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0041
		MOV DI,OFFSET CRUNCH13ID5
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,5
		REP CMPSB
		JNZ CHECKPRXCM3XCOM

		MOV [WORD CS:DSEGMENT],DS


		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET CRUNCH13
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]

		MOV BX,[WORD CS:OFFSALTO]

		MOV [WORD DS:BX+0044],0F0CDH

		MOV AX,[WORD DS:BX+0020]
		ADD AX,0003

		MOV [WORD CS:FILESIZECOM],AX

		PUSH DS
		POP ES

		MOV DI,BX
		ADD DI,0003


		MOV AL,090H
		MOV CX,0010
		CLD
		REP STOSB



		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET CRUNCH13BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
CRUNCH13BRK0:
		JMP BRKPRX31COM1
CHECKBLIZT10B:
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET BLIZTID1
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,14
		REP CMPSB
		JNZ CHECKCRUNCH11

		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0016
		MOV DI,OFFSET BLIZTID2
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,19
		REP CMPSB
		JNZ CHECKCRUNCH11
		MOV [WORD CS:DSEGMENT],DS


		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET BLIZT10B
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]

		MOV BX,[WORD CS:OFFSALTO]

		MOV [WORD DS:BX+0045],0F0CDH

		MOV AX,[WORD DS:BX+0014]
		ADD AX,0003

		MOV [WORD CS:FILESIZECOM],AX


		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BLIZTBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
BLIZTBRK0:
		JMP BRKPRX31COM1
CHECKPKLITE115COM:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE115COMID
		MOV CX,0040
		CLD
		REP CMPSB
		JNZ CHECKPKLITE115EXE1
		MOV [WORD CS:DSEGMENT],DS


		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE115COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]


		MOV [WORD DS:0297H],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET PKLITE115COMBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
PKLITE115COMBRK0:
		SUB DI,0100H
		MOV [WORD CS:FILESIZECOM],DI
		JMP BRKPRX31COM1
CHECKPKLITE115EXE1:
		PUSH CS
		POP ES
		MOV SI,012AH
		MOV DI,OFFSET PKLITE115EXEID1; METODO CORTO
		MOV CX,0025
		CLD
		REP CMPSB
		JNZ CHECKPKLITE115EXE2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],01H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE115EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

INCLUDE "PKLBRKS.ASM"

COMMONJUMP:
                MOV SI,[WORD CS:CHILDCSIP]
                MOV DS,[WORD CS:CHILDCSIP+002]
                CMP [BYTE DS:SI+006H],005H
                JNZ COMMONJUMP2
                CMP [WORD DS:SI+007H],0000
                JNZ COMMONJUMP2
                MOV AX,DS
                ADD AX,0010H
                MOV [WORD DS:SI+007H],AX
COMMONJUMP2:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET PKLITE115EXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX

		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
PKLITE115EXEBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DX,[WORD CS:TEMPES]
		MOV AX,[WORD CS:TEMPDI]

		CMP DX,[WORD CS:PID]
		JNE ALLPARANORMAL
		ADD DX,0010H
		SUB AX,0100H

ALLPARANORMAL:
		MOV [WORD CS:PARAES],DX
		MOV [WORD CS:PARADI],AX

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
                MOV DX,OFFSET EXEHEAD
		INT 21H

		MOV [WORD ES:03C0H],OFFSET PKLITE115EXEBRK1

		CALL POPTEMP
		MOV BP,BX
		POPF
		IRET

PKLITE115EXEBRK1:
		PUSHF
		CALL PUSHTEMP
		CMP CX,0FFFFH
		JE NOMASRELOC

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
NOMASRELOC:
		MOV [WORD ES:03C0H],OFFSET PKLITE115EXEBRK2

		MOV [WORD CS:TEMPCX],0000
		CALL POPTEMP
		CMP [BYTE CS:PKTYPE],05
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],06
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],07
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],08
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],09
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],0Ah
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],0BH
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],0CH
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],0DH
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],0EH
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],0FH
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],10H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],11H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],12H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],13H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],14H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],15H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],16H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],17H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],18H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],19H
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],1AH
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],1BH
		JE NOPASANADA
		CMP [BYTE CS:PKTYPE],1CH
		JE NOPASANADA
		ADD AX,BX
		XCHG AX,DX
		LODSW
NOPASANADA:
		POPF
		IRET




PKLITE115EXEBRK2:
		PUSHF
		CALL PUSHTEMP
		CMP [BYTE CS:PKTYPE],05
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],06
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],07
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],08
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],09
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],0AH
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],0BH
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],0CH
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],0DH
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],0EH
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],0FH
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],10H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],11H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],12H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],13H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],14H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],15H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],16H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],17H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],18H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],19H
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],1AH
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],1BH
		JZ ESPECIAL1
		CMP [BYTE CS:PKTYPE],1CH
		JZ ESPECIAL1
		MOV AX,[WORD CS:TEMPAX]
		MOV DX,[WORD CS:TEMPDX]
TODOCOMUN:
		SUB DX,[WORD CS:PID]
		SUB DX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],DX
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV [WORD ES:03C0H],OFFSET PKLITE115EXEBRK3
		CALL POPTEMP
		CMP [BYTE CS:PKTYPE],05
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],06
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],07
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],08
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],09
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],0AH
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],0BH
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],0CH
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],0DH
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],0EH
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],0FH
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],10H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],11H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],12H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],13H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],14H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],15H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],16H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],17H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],18H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],19H
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],1AH
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],1BH
		JZ ESPECIAL2
		CMP [BYTE CS:PKTYPE],1CH
		JZ ESPECIAL2
		POPF
		IRET
ESPECIAL1:
		MOV DX,[WORD CS:TEMPAX]
		LODSW
		JMP TODOCOMUN
ESPECIAL2:
		LODSW
		POPF
		IRET


PKLITE115EXEBRK3:
		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		POP AX
		MOV [WORD CS:EXEHEADORIG+14H],AX
		POP AX
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX
                XOR AH,AH
                JMP SAVECOMMON

CHECKPKLITE115EXE2:
		PUSH CS
		POP ES
		MOV SI,012AH
		MOV DI,OFFSET PKLITE115EXEID2; METODO LARGO
		MOV CX,0025
		CLD
		REP CMPSB
		JNZ CHECKPKLITE115EXTRA

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],02

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE115EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON

SETRESERVEDMEM:
		MOV DX,[WORD CS:PID]
		ADD DX,0010H
		CMP DX,[WORD CS:PARAES]
		JNE ALLNORMALOK
		SUB [WORD CS:PARAES],0010H
		ADD [WORD CS:PARADI],0100H
ALLNORMALOK:
		MOV AX,[WORD CS:PARAES]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV CL,04
		ROL AX,CL
		MOV DX,AX
		AND AX,0FFF0H
		ADD AX,[WORD CS:PARADI]
		ADC DX,0
		AND DX,0FH
		MOV [WORD CS:MSBLENGTH],DX
		MOV [WORD CS:LSBLENGTH],AX

		MOV DX,[WORD CS:EXEHEADORIG+0EH]
		MOV AX,[WORD CS:EXEHEADORIG+10H]
		MOV CL,04H
		ROL DX,CL
		MOV CX,DX
		AND DX,0FH
		AND CX,-10H
		ADD AX,CX
		ADC DX,0
		SUB AX,[WORD CS:LSBLENGTH]
		SBB DX,[WORD CS:MSBLENGTH]
		JB TANTO
		XOR DX,DX
		MOV CX,0010H
		DIV CX
		DEC DX
		CMP DX,CX
		ADC AX,0000
		MOV [WORD CS:EXEHEADORIG+0AH],AX
YEAAAH:
		MOV [WORD CS:EXEHEADORIG+0CH],0FFFFH
		RET
TANTO:
		MOV [WORD CS:EXEHEADORIG+0AH],0000H
		JMP YEAAAH
CHECKPKLITE115EXTRA:
		PUSH CS
		POP ES
		MOV SI,012AH
		MOV DI,OFFSET PKLITE115XTRAID1
		MOV CX,0030
		CLD
		REP CMPSB
		JNZ CHECKPKLITE115EXTRA2
		MOV [BYTE CS:PKXTRATYPE],01H
		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE115XTRA
		CALL PRINT
		CALL PAGK
PKXTRACOMMON:
		CALL GETATTRIB
		MOV DS,[WORD CS:DSEGMENT]
		CMP [BYTE CS:PKXTRATYPE],05H
		JE XTRA120
		CMP [BYTE CS:PKXTRATYPE],06H
		JE XTRA120
		CMP [BYTE CS:PKXTRATYPE],07H
		JE XTRA1202
		MOV [WORD DS:0143H],0F0CDH
		JMP NOMOREPKXTRATYPES
XTRA120:
		MOV [WORD DS:0141H],0F0CDH
		JMP NOMOREPKXTRATYPES
XTRA1202:
		MOV [WORD DS:014BH],0F0CDH

NOMOREPKXTRATYPES:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET PKLITE115XTRABRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX

		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
PKLITE115XTRABRK0:
		PUSHF
		CALL PUSHTEMP

		CALL POPTEMP
		CMP CX,0001
		JE LASTDECRYPT
		CMP [BYTE CS:PKXTRATYPE],05
		JZ PUTADD120
		CMP [BYTE CS:PKXTRATYPE],06
		JZ PUTADD120
		CMP [BYTE CS:PKXTRATYPE],07H
		JZ PUTADD120
		XOR AX,DX
		POPF
		IRET
PUTADD120:
		ADD AX,DX
		POPF
		IRET
LASTDECRYPT:
		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET PKLITE115XTRABRK1
		CMP [BYTE CS:PKXTRATYPE],02
		JZ PK1152BRK
		CMP [BYTE CS:PKXTRATYPE],03
		JZ PK1141BRK
		CMP [BYTE CS:PKXTRATYPE],04
		JZ PK1142BRK
		CMP [BYTE CS:PKXTRATYPE],05
		JZ ALLPK120BRK
		CMP [BYTE CS:PKXTRATYPE],06
		JZ ALLPK120BRK
		CMP [BYTE CS:PKXTRATYPE],07
		JZ ALLPK120BRK2

		MOV [WORD DS:0286H],0F0CDH
		MOV [WORD DS:029AH],0F0CDH
		MOV [BYTE DS:029CH],090H
		MOV [WORD DS:02A6H],0FFB9H
		MOV [BYTE DS:02A8H],0FFH
		MOV [WORD DS:02A9H],0F0CDH
		MOV [WORD DS:02ABH],0F0CDH
		MOV [WORD DS:02ADH],09090H
		MOV [WORD DS:02CCH],0F0CDH
		JMP BRKXTRACOMMON
PK1152BRK:
		MOV [WORD DS:032DH],0F0CDH
		MOV [WORD DS:0340H],0F0CDH
		MOV [BYTE DS:0342H],090H
		MOV [WORD DS:034CH],0FFB9H
		MOV [BYTE DS:034EH],0FFH
		MOV [WORD DS:034FH],0F0CDH
		MOV [WORD DS:0351H],0F0CDH
		MOV [WORD DS:0353H],09090H
		MOV [WORD DS:0372H],0F0CDH
		JMP BRKXTRACOMMON
PK1141BRK:
		MOV [WORD DS:0284H],0F0CDH
		MOV [WORD DS:0298H],0F0CDH
		MOV [BYTE DS:029AH],090H
		MOV [WORD DS:02A4H],0FFB9H
		MOV [BYTE DS:02A6H],0FFH
		MOV [WORD DS:02A7H],0F0CDH
		MOV [WORD DS:02A9H],0F0CDH
		MOV [WORD DS:02ABH],09090H
		MOV [WORD DS:02CAH],0F0CDH
		JMP BRKXTRACOMMON
PK1142BRK:
		MOV [WORD DS:032DH],0F0CDH
		MOV [WORD DS:0340H],0F0CDH
		MOV [BYTE DS:0342H],090H
		MOV [WORD DS:034CH],0FFB9H
		MOV [BYTE DS:034EH],0FFH
		MOV [WORD DS:034FH],0F0CDH
		MOV [WORD DS:0351H],0F0CDH
		MOV [WORD DS:0353H],09090H
		MOV [WORD DS:0372H],0F0CDH
		JMP BRKXTRACOMMON
ALLPK120BRK:
		MOV [WORD DS:025CH],0F0CDH
		MOV [WORD DS:026CH],0F0CDH
		MOV [BYTE DS:026EH],090H

		MOV [WORD DS:0278H],0FFB9H
		MOV [BYTE DS:027AH],0FFH
		MOV [WORD DS:027BH],0F0CDH
		MOV [BYTE DS:027DH],090H
		MOV [WORD DS:027EH],0F0CDH
		MOV [WORD DS:0280H],09090H

		MOV [WORD DS:029AH],0F0CDH
		JMP BRKXTRACOMMON
ALLPK120BRK2:
		MOV [WORD DS:0328H],0F0CDH
		MOV [WORD DS:033EH],0F0CDH
		MOV [BYTE DS:0340H],090H

		MOV [WORD DS:0349H],0FFB9H
		MOV [BYTE DS:034BH],0FFH
		MOV [WORD DS:034CH],0F0CDH
		MOV [BYTE DS:034EH],090H
		MOV [WORD DS:034FH],0F0CDH
		MOV [WORD DS:0351H],09090H

		MOV [WORD DS:036FH],0F0CDH
		JMP BRKXTRACOMMON

BRKXTRACOMMON:
		MOV AX,[WORD CS:TEMPAX]
		MOV DX,[WORD CS:TEMPDX]
		MOV ES,[WORD CS:TEMPES]

		CMP [BYTE CS:PKXTRATYPE],05
		JZ PUT1ADD120
		CMP [BYTE CS:PKXTRATYPE],06
		JZ PUT1ADD120
		CMP [BYTE CS:PKXTRATYPE],07
		JZ PUT1ADD120
		XOR AX,DX
		POPF
		IRET
PUT1ADD120:
		ADD AX,DX
		POPF
		IRET

PKLITE115XTRABRK1:
		PUSHF
		CALL PUSHTEMP

		MOV DX,[WORD CS:TEMPES]
		MOV AX,[WORD CS:TEMPDI]

		CMP DX,[WORD CS:PID]
		JNE ALLPARANORMAL1
		ADD DX,0010H
		SUB AX,0100H

ALLPARANORMAL1:
		MOV [WORD CS:PARAES],DX
		MOV [WORD CS:PARADI],AX

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV [WORD ES:03C0H],OFFSET PKLITE115XTRABRK2

		CALL POPTEMP
		CMP [BYTE CS:PKXTRATYPE],05
		JE PUT2BRK120
		CMP [BYTE CS:PKXTRATYPE],06
		JE PUT2BRK120
		MOV BP,BX
		POPF
		IRET
PUT2BRK120:
		MOV DX,BX
		POPF
		IRET

PKLITE115XTRABRK2:

		PUSHF
		CALL PUSHTEMP
		CMP CX,0FFFFH
		JE NOMASRELOC2

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
NOMASRELOC2:
		MOV [WORD ES:03C0H],OFFSET PKLITE115XTRABRK3

		MOV [WORD CS:TEMPCX],0000
		CALL POPTEMP
		CMP [BYTE CS:PKXTRATYPE],05
		JZ ALL120BRK2
		CMP [BYTE CS:PKXTRATYPE],06
		JZ ALL120BRK2
		CMP [BYTE CS:PKXTRATYPE],07
		JZ ALL120BRK2
		ADD AX,BX
		XCHG AX,DX
		LODSW
		POPF
		IRET
ALL120BRK2:
		LODSW
		ADD AX,BX
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		LODSW
		MOV [WORD CS:EXEHEADORIG+10H],AX
		POPF
		IRET



PKLITE115XTRABRK3:
		PUSHF
		CALL PUSHTEMP
		CMP [BYTE CS:PKXTRATYPE],05
		JZ ANTEULTIMOBRK
		CMP [BYTE CS:PKXTRATYPE],06
		JZ ANTEULTIMOBRK
		CMP [BYTE CS:PKXTRATYPE],07
		JZ ANTEULTIMOBRK

		MOV AX,[WORD CS:TEMPAX]
		MOV DX,[WORD CS:TEMPDX]
		SUB DX,[WORD CS:PID]
		SUB DX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],DX
		MOV [WORD CS:EXEHEADORIG+10H],AX

ANTEULTIMOBRK:
		MOV [WORD ES:03C0H],OFFSET PKLITE115XTRABRK4
		CALL POPTEMP
		POPF
		IRET
PKLITE115XTRABRK4:
		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		POP AX
		MOV [WORD CS:EXEHEADORIG+14H],AX
		POP AX
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX
		MOV [BYTE CS:FAKEPK],01H

		JMP SAVECOMMON
FAKEPKLITE:
		MOV DX,OFFSET FAKEXTR141520
		CALL PRINT

PAGK3:		 ; Press And Get Key 3 :)

GETKEY3:
		MOV AH,08H
		INT 21H
		CMP AL,79H
		JE LETCONT3
		CMP AL,59H
		JE LETCONT3
		CMP AL,4EH
		JE DONTCONT3
		CMP AL,6EH
		JE DONTCONT3
		JMP GETKEY3
DONTCONT3:

		CALL PRINTCHAR
		RETN
LETCONT3:
		CALL PRINTCHAR

		MOV AX,[WORD CS:EXEHEADORIG+14H]
		MOV [WORD CS:FAKEPKUPPER+22],AX
		MOV [WORD CS:FAKEPKLOWER+22],AX
		MOV AX,[WORD CS:EXEHEADORIG+16H]
		ADD AX,0010H
		MOV [WORD CS:FAKEPKUPPER+18],AX
		MOV [WORD CS:FAKEPKLOWER+18],AX

		MOV AX,3D02H
		PUSH CS
		POP DS
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		PUSH DX
		PUSH AX

		XOR DX,DX
		CLC
		MOV CX,0010h
		DIV CX

		CMP DX,0000
		JE NOSUMA
		INC AX
NOSUMA:
		CLC
		XOR DX,DX
		MUL CX
		POP DX
		POP DX
		ADC DX,0000

		PUSH DX
		PUSH AX

		CLC
		XOR DX,DX
		MOV AX,[WORD CS:EXEHEADORIG+08H]
		MOV BX,0010H
		MUL BX

		MOV CX,DX
		MOV BX,AX

		POP AX
		POP DX

		PUSH DX
		PUSH AX

		SUB AX,BX
		SBB DX,CX

		CLC
		MOV CX,0010h
		DIV CX
		MOV [WORD CS:EXEHEADORIG+14H],0000
		MOV [WORD CS:EXEHEADORIG+16H],AX

		POP AX
		POP DX


		MOV CX,DX
		MOV DX,AX

		MOV AX,4200H
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		CMP [BYTE CS:PKXTRATYPE],05
		JZ PUTFAKELOWER
		CMP [BYTE CS:PKXTRATYPE],06
		JZ PUTFAKELOWER
		CMP [BYTE CS:PKXTRATYPE],07
		JZ PUTFAKELOWER

		MOV DX,OFFSET FAKEPKUPPER
		JMP WRITEFAKE
PUTFAKELOWER:
		MOV DX,OFFSET FAKEPKLOWER
WRITEFAKE:
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		PUSH CS
		POP DS
		MOV CX,0026
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		RET

CHECKPKLITE115EXTRA2:
		PUSH CS
		POP ES
		MOV SI,012AH
		MOV DI,OFFSET PKLITE115XTRAID2
		MOV CX,0030
		CLD
		REP CMPSB
		JNZ CHECKPKLITE114EXTRA1

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKXTRATYPE],02

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE115XTRA
		CALL PRINT
		CALL PAGK
		JMP PKXTRACOMMON

CHECKPKLITE114EXTRA1:
		PUSH CS
		POP ES
		MOV SI,012AH
		MOV DI,OFFSET PKLITE114XTRAID1
		MOV CX,0030
		CLD
		REP CMPSB
		JNZ CHECKPKLITE114EXTRA2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKXTRATYPE],03

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE114XTRA
		CALL PRINT
		CALL PAGK
		JMP PKXTRACOMMON
CHECKPKLITE114EXTRA2:
		PUSH CS
		POP ES
		MOV SI,012AH
		MOV DI,OFFSET PKLITE114XTRAID2
		MOV CX,0030
		CLD
		REP CMPSB
		JNZ CHECKPKLITE120EXTRA1

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKXTRATYPE],04

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE114XTRA
		CALL PRINT
		CALL PAGK
		JMP PKXTRACOMMON
CHECKPKLITE120EXTRA1:
		PUSH CS
		POP ES
		MOV SI,012AH
		MOV DI,OFFSET PKLITE120XTRAID1
		MOV CX,0028
		CLD
		REP CMPSB
		JNZ CHECKPKLITE120EXTRA2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKXTRATYPE],05

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE120XTRA
		CALL PRINT
		CALL PAGK
		JMP PKXTRACOMMON
CHECKPKLITE120EXTRA2:
		PUSH CS
		POP ES
		MOV SI,012AH
		MOV DI,OFFSET PKLITE120XTRAID2
		MOV CX,0028
		CLD
		REP CMPSB
		JNZ CHECKPKLITE120EXTRA3

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKXTRATYPE],06

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE120XTRA
		CALL PRINT
		CALL PAGK
		JMP PKXTRACOMMON
CHECKPKLITE120EXTRA3:
		PUSH CS
		POP ES
		MOV SI,012CH
		MOV DI,OFFSET PKLITE120XTRAID3
		MOV CX,0036
		CLD
		REP CMPSB
		JNZ CHECKPKLITE114COM

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKXTRATYPE],07

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE120XTRA
		CALL PRINT
		CALL PAGK
		JMP PKXTRACOMMON
CHECKPKLITE114COM:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE114COMID
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE114EXE1

		CMP [BYTE DS:0297H],0CBH
		JNZ CHECKPKLITE114EXE1

		MOV [WORD CS:DSEGMENT],DS


		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE114COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
PKCOMCOMUN:
		MOV DS,[WORD CS:DSEGMENT]

		CMP [BYTE CS:PKFIRSTYPE],01H
		JZ  PKTYPES1STOK
		CMP [BYTE CS:PKFIRSTYPE],02H
		JZ  PKTYPES2NDOK
		MOV [WORD DS:0295H],0F0CDH
		JMP BRKCOMCOMUN
PKTYPES1STOK:
		MOV [WORD DS:0296H],0F0CDH
		JMP BRKCOMCOMUN
PKTYPES2NDOK:
		MOV [WORD DS:02C9H],0F0CDH
		JMP BRKCOMCOMUN

BRKCOMCOMUN:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET PKLITE114COMBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
PKLITE114COMBRK0:
		SUB DI,0100H
		MOV [WORD CS:FILESIZECOM],DI
		JMP BRKPRX31COM1
CHECKPKLITE114EXE1:
		PUSH CS
		POP ES
		MOV SI,012Ah
		MOV DI,OFFSET PKLITE114EXEID1
		MOV CX,0024
		CLD
		REP CMPSB
		JNZ CHECKPKLITE114EXE2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],03

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE114EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON

CHECKPKLITE114EXE2:
		PUSH CS
		POP ES
		MOV SI,012Ah
		MOV DI,OFFSET PKLITE114EXEID2
		MOV CX,0024
		CLD
		REP CMPSB
		JNZ CHECKPKLITE113COM

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],04H


		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE114EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE113COM:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE113COMID
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE113EXE1

		CMP [BYTE DS:0297H],0CBH
		JNZ CHECKPKLITE113EXE1

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE113COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMCOMUN
CHECKPKLITE113EXE1:
		PUSH CS
		POP ES
		MOV SI,0109H
		MOV DI,OFFSET PKLITE113EXEID1
		MOV CX,0032
		CLD
		REP CMPSB
		JNZ CHECKPKLITE113EXE2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],05

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE113EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE113EXE2:
		PUSH CS
		POP ES
		MOV SI,0109H
		MOV DI,OFFSET PKLITE113EXEID2
		MOV CX,0032
		CLD
		REP CMPSB
		JNZ CHECKPKLITE113XTRA1

		CMP [BYTE DS:0201H],07DH
		JNZ CHECKPKLITE113XTRA1

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],06H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE113EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE113XTRA1:
		PUSH CS
		POP ES
		MOV SI,0109H
		MOV DI,OFFSET PKLITE113XTRAID1
		MOV CX,0032
		CLD
		REP CMPSB
		JNZ CHECKPKLITE113XTRA2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],07H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE113XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE113XTRA2:
		PUSH CS
		POP ES
		MOV SI,0109H
		MOV DI,OFFSET PKLITE113XTRAID2
		MOV CX,0032
		CLD
		REP CMPSB
		JNZ CHECKPKLITE112COM

		CMP [BYTE DS:0204H],07DH
		JNZ CHECKPKLITE112COM

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],08H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE113XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE112COM:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE112COMID
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE112EXE1

		CMP [BYTE DS:0297H],0CBH
		JNZ CHECKPKLITE112EXE1

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE112COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMCOMUN
CHECKPKLITE112EXE1:
		PUSH CS
		POP ES
		MOV SI,0109H
		MOV DI,OFFSET PKLITE112EXEID1
		MOV CX,0032
		CLD
		REP CMPSB
		JNZ CHECKPKLITE112EXE2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],09H
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE112EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE112EXE2:
		PUSH CS
		POP ES
		MOV SI,0109H
		MOV DI,OFFSET PKLITE112EXEID2
		MOV CX,0032
		CLD
		REP CMPSB
		JNZ CHECKPKLITE112XTRA1

		CMP [BYTE DS:0201H],07CH
		JNZ CHECKPKLITE112XTRA1

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],0AH

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE112EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE112XTRA1:
		PUSH CS
		POP ES
		MOV SI,0109H
		MOV DI,OFFSET PKLITE112XTRAID1
		MOV CX,0032
		CLD
		REP CMPSB
		JNZ CHECKPKLITE112XTRA2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],0BH

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE112XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE112XTRA2:
		PUSH CS
		POP ES
		MOV SI,0109H
		MOV DI,OFFSET PKLITE112XTRAID2
		MOV CX,0032
		CLD
		REP CMPSB
		JNZ CHECKPKLITE110XTRA

		CMP [BYTE DS:0204H],07CH

		JNZ CHECKPKLITE110XTRA

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],0CH

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE112XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE110XTRA:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE110XTRAID
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE105COM

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],0DH

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE110XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE105COM:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE105COMID
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE105EXE1

		CMP [BYTE DS:0297H],0CBH
		JNZ CHECKPKLITE105EXE1

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE105COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMCOMUN
CHECKPKLITE105EXE1:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE105EXEID1
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE105EXE2

		CMP [BYTE DS:0151H],08CH
		JNZ CHECKPKLITE105EXE2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],0EH

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE105EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE105EXE2:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE105EXEID2
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE105XTRA1

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],0FH

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE105EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE105XTRA1:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE105XTRAID1
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE105XTRA2

		CMP [BYTE DS:0151H],08CH
		JNZ CHECKPKLITE105XTRA2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],10H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE105XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE105XTRA2:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE105XTRAID2
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE103COM

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],11H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE105XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE103COM:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE103COMID
		MOV CX,0038
		CLD
		REP CMPSB
		JNZ CHECKPKLITE103EXE1

		CMP [BYTE DS:0298H],0CBH
		JNZ CHECKPKLITE103EXE1

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKFIRSTYPE],01
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE103COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMCOMUN
CHECKPKLITE103EXE1:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE103EXEID1
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE103EXE2

		CMP [BYTE DS:0151H],0BEH
		JNZ CHECKPKLITE103EXE2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],12H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE103EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE103EXE2:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE103EXEID2
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE103XTRA1

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],13H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE103EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE103XTRA1:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE103XTRAID1
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKPKLITE103XTRA2

		CMP [BYTE DS:00151H],0BEH
		JNZ CHECKPKLITE103XTRA2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],14H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE103XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE103XTRA2:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET PKLITE103XTRAID2
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKMEGALITECOM

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],15H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE103XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE100COM:
		PUSH CS
		POP ES
		MOV SI,0103H
		MOV DI,OFFSET PKLITE100COMID
		MOV CX,0023
		CLD
		REP CMPSB
		JNZ CHECKPKLITE100EXE1

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKFIRSTYPE],02

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE100COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMCOMUN
CHECKPKLITE100EXE1:
		PUSH CS
		POP ES
		MOV SI,0100H
		MOV DI,OFFSET PKLITE100EXEID1
		MOV CX,0033
		CLD
		REP CMPSB
		JNZ CHECKPKLITE100EXE2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],16H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE100EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE100EXE2:
		PUSH CS
		POP ES
		MOV SI,0100H
		MOV DI,OFFSET PKLITE100EXEID2
		MOV CX,0033
		CLD
		REP CMPSB
		JNZ CHECKPKLITE100XTRA

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],17H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE100EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKPKLITE100XTRA:
		PUSH CS
		POP ES
		MOV SI,0100H
		MOV DI,OFFSET PKLITE100XTRAID
		MOV CX,0033
		CLD
		REP CMPSB
		JNZ CHECKCOMPACK44COM

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],18H

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PKLITE100XTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKCOMPACK44COM:
		PUSH CS
		POP ES
		MOV SI,0103H
		MOV DI,OFFSET COMPACK44COMID
		MOV CX,0035
		CLD
		REP CMPSB
		JNZ CHECKCOMPACK44EXE

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET COMPACK44COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0114H],0F0CDH
		MOV [BYTE DS:0116H],090H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET COMPACK44COMBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
COMPACK44COMBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:TEMPSI]
		SUB SI,0010H
		MOV [WORD DS:SI],0F0CDH
		MOV [WORD ES:03C0H],OFFSET COMPACK44COMBRK1
		CALL POPTEMP
		MOV DI,0FF82H
		POPF
		IRET
COMPACK44COMBRK1:
		SUB DI,0100H
		MOV [WORD CS:FILESIZECOM],DI

		JMP BRKPRX31COM1
CHECKENCRIPTOR100BETA:
		CMP [BYTE DS:0101H],048H
		JNE CHECKSCRUNCH102

		PUSH CS
		POP ES
                MOV SI,0153H
		MOV DI,OFFSET ENCRIPTOR100BETAID
                MOV CX,0027
		CLD
		REP CMPSB
		JNZ CHECKSCRUNCH102

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET ENCRIPTOR100BETA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0185H],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET ENCRIPTOR100BETABRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
ENCRIPTOR100BETABRK0:
		PUSHF
		CALL PUSHTEMP
		MOV AH,02FH
		INT 21H

		MOV AH,04EH
		MOV CX,00FFH
		PUSH CS
		POP DS
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H

		MOV CX,[WORD ES:009AH]
		SUB CX,0096H

		MOV [WORD CS:FILESIZECOM],CX

		CALL POPTEMP
		POPF


		JMP BRKPRX31COM1
CHECKCOMPACK44EXE:
		PUSH CS
		POP ES
		MOV SI,0003H
		MOV DI,OFFSET COMPACK44EXEID
		MOV CX,0045
		CLD
		REP CMPSB
		JNZ CHECKCOMPACK45COM

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET COMPACK44EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:002AH],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET COMPACK44EXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX

		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
COMPACK44EXEBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV BX,SP
		MOV SI,[WORD SS:BX+08H]
		MOV DS,[WORD SS:BX+0AH]
		MOV [WORD CS:DSEGMENT],DS
		MOV [WORD DS:SI+093H],0F0CDH
		MOV [WORD DS:SI+0AFH],0F0CDH
		MOV [BYTE DS:SI+0B1H],090H
		MOV [WORD DS:SI+0BCH],0F0CDH
		MOV [WORD DS:SI+0BEH],09090H
		MOV [BYTE DS:SI+0C0H],090H
		MOV [WORD DS:SI+0C9H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET COMPACK44EXEBRK1
		CALL POPTEMP
		XOR DI,DI
		POPF
		IRET
COMPACK44EXEBRK1:
		PUSHF
		CALL PUSHTEMP
		MOV DX,[WORD CS:TEMPES]
		MOV AX,[WORD CS:TEMPDI]

		MOV CX,[WORD CS:PID]
		ADD CX,0010H
		CLC
		CMP CX,DX
		JE ALLPARANORMAL2
		CLC
		ADD AX,0001
		ADC DX,0000


ALLPARANORMAL2:
		CLC
		SUB AX,0001H
		SBB DX,0000H
		MOV [WORD CS:PARAES],DX
		MOV [WORD CS:PARADI],AX

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV [WORD ES:03C0H],OFFSET COMPACK44EXEBRK2
		MOV [BYTE CS:COMPRTYPE],01H
		CALL POPTEMP
		MOV SI,DI
		POPF
		IRET

COMPACK44EXEBRK2:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPAX]
		CMP AX,0FFFFH
		JE NOMASRELOC3

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
NOMASRELOC3:
		MOV [WORD ES:03C0H],OFFSET COMPACK44EXEBRK3
		MOV DS,[WORD CS:DSEGMENT]
		ADD [WORD DS:070DH],DI
		CALL POPTEMP
		POPF
		IRET

COMPACK44EXEBRK3:
		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:0707H]
		MOV DX,DI
		SUB DX,[WORD CS:PID]
		SUB DX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],DX
		MOV [WORD CS:EXEHEADORIG+10H],AX



		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:070BH]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:070DH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX

		JMP SAVECOMMON
CHECKCOMPACK45COM:
		PUSH CS
		POP ES
		MOV SI,0103H
		MOV DI,OFFSET COMPACK45COMID
		MOV CX,0038
		CLD
		REP CMPSB
		JNZ CHECKCOMPACK45EXE

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET COMPACK45COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0118H],0F0CDH
		MOV [BYTE DS:011AH],090H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET COMPACK45COMBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
COMPACK45COMBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:TEMPSI]
		SUB SI,000DH
		MOV [WORD DS:SI],0F0CDH
		MOV [WORD ES:03C0H],OFFSET COMPACK45COMBRK1
		CALL POPTEMP
		MOV DI,0FF82H
		POPF
		IRET
COMPACK45COMBRK1:
		SUB DI,0100H
		MOV [WORD CS:FILESIZECOM],DI

		JMP BRKPRX31COM1
CHECKCOMPACK45EXE:
		PUSH CS
		POP ES
		MOV SI,0003H
		MOV DI,OFFSET COMPACK45EXEID
		MOV CX,0046
		CLD
		REP CMPSB
		JNZ CHECKSHRINK10

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET COMPACK45EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:002AH],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET COMPACK45EXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX

		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
COMPACK45EXEBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV BX,SP
		MOV SI,[WORD SS:BX+08H]
		MOV DS,[WORD SS:BX+0AH]
		MOV [WORD CS:DSEGMENT],DS
		MOV [WORD DS:SI+08CH],0F0CDH
		MOV [WORD DS:SI+093H],09090H
		MOV [WORD DS:SI+095H],09090H
		MOV [BYTE DS:SI+097H],090H

		MOV [WORD DS:SI+0ADH],0F0CDH
		MOV [BYTE DS:SI+0AFH],090H
		MOV [BYTE DS:SI+0BBH],090H
		MOV [WORD DS:SI+0C2H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET COMPACK45EXEBRK1
		CALL POPTEMP
		XOR DI,DI
		POPF
		IRET
COMPACK45EXEBRK1:
		PUSHF
		CALL PUSHTEMP
		MOV DX,[WORD CS:TEMPES]
		MOV AX,[WORD CS:TEMPDI]

		MOV CX,[WORD CS:PID]
		ADD CX,0010H
		CLC
		CMP CX,DX
		JE ALLPARANORMAL3
		CLC
		ADD AX,0001
		ADC DX,0000


ALLPARANORMAL3:
		CLC
		SUB AX,0001H
		SBB DX,0000H
		MOV [WORD CS:PARAES],DX
		MOV [WORD CS:PARADI],AX

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV [WORD ES:03C0H],OFFSET COMPACK45EXEBRK2
		MOV [BYTE CS:COMPRTYPE],01H
		CALL POPTEMP
		MOV SI,DI
		POPF
		IRET

COMPACK45EXEBRK2:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPAX]
		CMP AX,0FFFFH
		JE NOMASRELOC4

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
NOMASRELOC4:
		MOV DS,[WORD CS:DSEGMENT]
		CALL POPTEMP
		POPF

		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:0708H]
		MOV DX,DI
		SUB DX,[WORD CS:PID]
		SUB DX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],DX
		MOV [WORD CS:EXEHEADORIG+10H],AX



		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:070CH]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:070EH]
		MOV [WORD CS:EXEHEADORIG+16H],AX
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX

		JMP SAVECOMMON
CHECKICE100:
		CMP [BYTE DS:0101H],00AH
		JNE CHECKBINLOCK100

		PUSH CS
		POP ES
		MOV SI,010CH
		MOV DI,OFFSET ICE100ID
		MOV CX,0026
		CLD
		REP CMPSB
		JNZ CHECKBINLOCK100

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET ICE100
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0122H],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET ICE100BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
ICE100BRK0:
		PUSHF
		CALL PUSHTEMP

		CMP CX,0001
		JZ PUTSECONDICEBRK

ICEBRKCOMMON:
		CALL POPTEMP

		MOV DX,AX
		POPF
		IRET
PUTSECONDICEBRK:
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:016DH],0F0CDH
		MOV [BYTE DS:016FH],090H
		MOV [WORD ES:03C0H],OFFSET ICE100BRK1

		JMP ICEBRKCOMMON
ICE100BRK1:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD DS:010AH]
		MOV [WORD DS:BX+08H],0F0CDH
		MOV [BYTE DS:BX+0AH],090H
		MOV [WORD DS:BX+2EH],0F0CDH
		MOV [WORD ES:03C0H],OFFSET ICE100BRK2

		CALL POPTEMP
		MOV SI,0179H
		POPF
		IRET
ICE100BRK2:
		PUSHF
		CALL PUSHTEMP
		SUB CX,0003
		MOV [WORD CS:FILESIZECOM],CX
		MOV [WORD ES:03C0H],OFFSET ICE100BRK3

		CALL POPTEMP
		MOV DI,0100H
		POPF
		IRET
ICE100BRK3:
		JMP BRKPRX31COM1
CHECKMRHDKILLERPROT:
		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,0017H
		MOV DI,OFFSET MRHDKILLERPROTID
		PUSH CS
		POP ES
		CLD
		MOV CX,74
		REP CMPSB
		JNZ CHECKMCLOCK

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET MRHDKILLERPROT
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]

		MOV [WORD DS:SI+024H],0F0CDH
		MOV [BYTE DS:SI+026H],0BAH
		MOV [WORD DS:SI+027H],0CFCFH
		MOV [WORD DS:SI+029H],084BBH
		MOV [BYTE DS:SI+02BH],019H
		MOV [WORD DS:SI+02CH],03EEBH
		MOV [WORD DS:SI+087H],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET MRHDKILLERPROTBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
MRHDKILLERPROTBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV CX,[WORD CS:TEMPCX]
		MOV AX,0002H
		MUL CX
		MOV [WORD CS:FILESIZECOM],AX

		MOV [WORD ES:03C0H],OFFSET MRHDKILLERPROTBRK1
		CALL POPTEMP
		POPF
		IRET

MRHDKILLERPROTBRK1:
		JMP BRKPRX31COM1
CHECKCOMLOCK010:
		MOV SI,[WORD CS:OFFSALTO]
		CMP [WORD DS:SI],0EEBH
		JNZ CHECKONEMANCREW

		ADD SI,0013H
		MOV DI,OFFSET COMLOCK010ID
		PUSH CS
		POP ES
		CLD
		MOV CX,61
		REP CMPSB
		JNZ CHECKONEMANCREW

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET COMLOCK010
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]

		MOV [WORD DS:SI+036H],0F0CDH
		ADD SI,0011H

		MOV CX,[WORD DS:SI]
		ADD CX,0003H
		MOV [WORD CS:FILESIZECOM],CX

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET COMLOCK010BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
COMLOCK010BRK0:
		JMP BRKPRX31COM1
CHECKMEGALITECOM:
		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET MEGALITECOMID
		MOV CX,0039
		CLD
		REP CMPSB
		JNZ CHECKMEGALITEEXE1

		CMP [BYTE DS:0297H],0CBH
		JNZ CHECKMEGALITEEXE1

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET MEGALITECOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMCOMUN
CHECKMEGALITEEXE1:
		PUSH CS
		POP ES
		MOV SI,0009H
		MOV DI,OFFSET MEGALITEEXEID1
		MOV CX,0038
		CLD
		REP CMPSB
		JNZ CHECKMEGALITEEXE2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],19H
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET MEGALITEEXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKMEGALITEEXE2:
		PUSH CS
		POP ES
		MOV SI,0009H
		MOV DI,OFFSET MEGALITEEXEID2
		MOV CX,0038
		CLD
		REP CMPSB
		JNZ CHECKMEGALITEXTRA1

		CMP [BYTE DS:0101H],07CH
		JNZ CHECKMEGALITEXTRA1

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],1AH

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET MEGALITEEXE

		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKMEGALITEXTRA1:
		PUSH CS
		POP ES
		MOV SI,0009H
		MOV DI,OFFSET MEGALITEXTRAID1
		MOV CX,0038
		CLD
		REP CMPSB
		JNZ CHECKMEGALITEXTRA2

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],1BH

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET MEGALITEXTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKMEGALITEXTRA2:
		PUSH CS
		POP ES
		MOV SI,0009H
		MOV DI,OFFSET MEGALITEXTRAID2
		MOV CX,0038
		CLD
		REP CMPSB
                JNZ CHECKMEGALITE118EXE

		CMP [BYTE DS:0104H],07CH

                JNZ CHECKMEGALITE118EXE

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:PKTYPE],1CH

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET MEGALITEXTRA
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PKCOMMON
CHECKSHRINK10:
		PUSH CS
		POP ES
		MOV SI,0100H
		MOV DI,OFFSET SHRINK10ID
		MOV CX,0028
		CLD
		REP CMPSB
		JNZ CHECKTPCSCRAMBLER

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET SHRINK10
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:013CH],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET SHRINK10BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
SHRINK10BRK0:
		SUB DI,0100H
		MOV [WORD CS:FILESIZECOM],DI
		JMP BRKPRX31COM1
CHECKTPCSCRAMBLER:
		PUSH CS
		POP ES
		MOV SI,010CH
		MOV DI,OFFSET TPCSCRAMBLERID
		MOV CX,0049
		CLD
		REP CMPSB
		JNZ CHECKSCRUNCH100

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET TPCSCRAMBLER
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0100H],09090H
		MOV [WORD DS:0102H],09090H
		MOV [WORD DS:0104H],09090H

		MOV [WORD DS:0122H],0206H
		MOV [WORD DS:0127H],0204H
		MOV [WORD DS:012BH],020EH
		MOV [WORD DS:0130H],020CH

		MOV [WORD DS:013CH],083CDH
		MOV [WORD DS:013EH],0F0CDH
		MOV [WORD DS:014DH],081CDH
		MOV [WORD DS:015EH],0F0CDH
		MOV CX,[WORD DS:010AH]
		MOV [WORD CS:FILESIZECOM],CX

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET TPCSCRAMBLERBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
TPCSCRAMBLERBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV [WORD ES:03C0H],OFFSET TPCSCRAMBLERBRK1
		CALL POPTEMP
		MOV SI,0177H
		POPF
		IRET
TPCSCRAMBLERBRK1:
		JMP BRKPRX31COM1
CHECKSCRUNCH100:
                PUSH CS
		POP ES
                MOV SI,0107H
		MOV DI,OFFSET SCRUNCH100ID
                MOV CX,0015
		CLD
		REP CMPSB
		JNZ CHECKLOCKIT011EXE

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET SCRUNCH100
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:029CH],0F0CDH
		MOV CX,[WORD DS:0254H]
		SUB CX,0100H
		MOV [WORD CS:FILESIZECOM],CX
SCRUNCHCOMMON:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET SCRUNCH100BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
SCRUNCH100BRK0:
		JMP BRKPRX31COM1
CHECKSCRUNCH102:
                MOV SI,[WORD CS:CHILDCSIP]
                CMP [BYTE DS:SI+001H],013H
                JZ SCRUNCH102OK
                JMP CHECKICE100

SCRUNCH102OK:
		PUSH CS
		POP ES
                ADD SI,0015H
		MOV DI,OFFSET SCRUNCH102ID
		MOV CX,0022
		CLD
		REP CMPSB
                JZ SCRUNCH102OK2

                MOV SI,[WORD CS:CHILDCSIP]
                PUSH CS
		POP ES
                ADD SI,0015H
                MOV DI,OFFSET SCRUNCH102EXEID1
                MOV CX,0009
		CLD
		REP CMPSB
                JNZ CHECKICE100

                PUSH CS
		POP ES
                ADD SI,0002H
                MOV DI,OFFSET SCRUNCH102EXEID2
                MOV CX,0011
		CLD
		REP CMPSB
                JNZ CHECKICE100
                MOV [BYTE CS:SCRUNCHEXE],01H
SCRUNCH102OK2:
		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET SCRUNCH102
                CMP [BYTE CS:SCRUNCHEXE],00H
                JZ PRINTSCRUNCH
                MOV DX,OFFSET SCRUNCH102EXE
PRINTSCRUNCH:
                CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
                CMP [BYTE CS:SCRUNCHEXE],01H
                JZ ITSCRUNCHEXE
                MOV [WORD DS:02CDH],0F0CDH
		MOV CX,[WORD DS:0285H]
		SUB CX,0100H
                JMP SCRUNCH102OK3
ITSCRUNCHEXE:
                MOV [WORD DS:0245H],0F0CDH
                MOV CX,[WORD DS:0201H]
                MOV [WORD CS:EXEHEADORIG],0000H
SCRUNCH102OK3:
                MOV [WORD CS:FILESIZECOM],CX
		JMP SCRUNCHCOMMON
CHECKMCLOCK:
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET MCLOCKID1
		PUSH CS
		POP ES
		CLD
		MOV CX,13
		REP CMPSB
		JNZ CHECKEXE2COMREG

		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,37
		MOV DI,OFFSET MCLOCKID2
		PUSH CS
		POP ES
		CLD
		MOV CX,21
		REP CMPSB
		JNZ CHECKEXE2COMREG

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET MCLOCK
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]

		MOV [WORD DS:SI+11],0204H
		MOV [WORD DS:SI+17],0205H
		MOV [WORD DS:SI+23],0206H
		MOV [WORD DS:SI+28],020CH
		MOV [WORD DS:SI+34],020DH
		MOV [WORD DS:SI+40],020EH
		MOV [WORD DS:SI+2BH],081CDH
		MOV [WORD DS:SI+31H],083CDH
		MOV [WORD DS:SI+2DH],0F0CDH



		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET MCLOCKBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
MCLOCKBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
		MOV CX,[WORD DS:SI+063H]
		MOV [WORD CS:FILESIZECOM],CX
		MOV [WORD DS:SI+039H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET MCLOCKBRK1
		CALL POPTEMP
		MOV AX,[WORD CS:DSEGMENT]
		POPF
		IRET
MCLOCKBRK1:
                MOV [WORD CS:EXEHEADORIG+00EH],0FFF0H
                MOV [WORD CS:EXEHEADORIG+010H],0FFFEH
                JMP BRKPRX31COM1
CHECKEXE2COMREG:
                MOV SI,[WORD CS:OFFSALTO]
		ADD SI,002EH
		MOV DI,OFFSET EXE2COMREGID1
		PUSH CS
		POP ES
		CLD
		MOV CX,12
		REP CMPSB
                JNZ CHECKEXE2COMREGUNKNOWN

		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,002EH+14
		MOV DI,OFFSET EXE2COMREGID2
		PUSH CS
		POP ES
		CLD
		MOV CX,11
		REP CMPSB
                JNZ CHECKEXE2COMREGUNKNOWN
                JMP EXE2COMREGISOK
CHECKEXE2COMREGUNKNOWN:
                MOV SI,[WORD CS:OFFSALTO]
                ADD SI,0004H
		MOV DI,OFFSET EXE2COMREGID1
		PUSH CS
		POP ES
		CLD
		MOV CX,12
		REP CMPSB
		JNZ CHECKLOCKIT011COM

		MOV SI,[WORD CS:OFFSALTO]
                ADD SI,0012H
		MOV DI,OFFSET EXE2COMREGID2
		PUSH CS
		POP ES
		CLD
		MOV CX,11
		REP CMPSB
		JNZ CHECKLOCKIT011COM
                MOV SI,[WORD CS:OFFSALTO]
                SUB SI,002AH
                MOV [WORD CS:OFFSALTO],SI
                JMP EXE2COMREGISOK


EXE2COMREGISOK:
                MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EXE2COMREG
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]

                MOV [WORD DS:SI+032H],09090H
                MOV [WORD DS:SI+03EH],0F0CDH
                MOV [WORD DS:SI+043H],0F0CDH

                MOV DI,[WORD DS:SI+02CH]
                ADD DI,0003H
                PUSH DI
                MOV DI,[WORD DS:DI]
                MOV AX,[WORD DS:DI]
                POP DI
                ADD DI,0002
                MOV DI,[WORD DS:DI]
                MOV BX,[WORD DS:DI]

                MOV [WORD CS:EXEHEAD+016H],AX
                MOV [WORD CS:EXEHEAD+00EH],BX

                MOV AX,[WORD DS:SI+047H]
                MOV BX,[WORD DS:SI+04BH]

                MOV [WORD CS:EXEHEAD+010H],AX
                MOV [WORD CS:EXEHEAD+014H],BX


                MOV CX,[WORD DS:SI+02CH]
                SUB CX,0100H
                SUB [WORD DS:SI+03AH],0002H
                ADD [WORD DS:SI+02CH],0007H
                MOV AX,DS
		ADD AX,0010H
                MOV SI,CX

		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],SI

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
                MOV CX,001CH
		MOV DX,OFFSET EXEHEAD
		INT 21H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET EXE2COMREGBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
EXE2COMREGBRK0:
                PUSHF
                CALL PUSHTEMP
                MOV CX,[WORD CS:TEMPCX]
                JCXZ EXE2COMREGENDRELOC
                CALL SAVERELOC2
                CALL POPTEMP
                POPF
                IRET
EXE2COMREGENDRELOC:
                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE]
                INT 21H
                MOV AX,[WORD CS:CANTRELOC]
                MOV [WORD CS:EXEHEAD+06H],AX

                MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
                SUB [WORD DS:SI+02CH],0007H

                MOV DI,[WORD DS:SI+02CH]
                MOV AX,[WORD DS:DI]
                MOV [WORD DS:0100H],AX
                ADD DI,0002H
                MOV AL,[BYTE DS:DI]
                MOV [BYTE DS:0102H],AL

                PUSH CS
                POP DS
                PUSH CS
                POP ES
                MOV SI,OFFSET EXEHEAD
                MOV DI,OFFSET EXEHEADORIG
                MOV CX,001CH
                CLD
                REP MOVSB
                JMP SAVECOMMON

CHECKLOCKIT011COM:
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET LOCKIT011COMID1
		PUSH CS
		POP ES
		CLD
		MOV CX,13
		REP CMPSB
		JNZ CHECKEPW120

		MOV SI,[WORD CS:OFFSALTO]
		ADD SI,21
		MOV DI,OFFSET LOCKIT011COMID2
		PUSH CS
		POP ES
		CLD
		MOV CX,13
		REP CMPSB
		JNZ CHECKCOMLOCK010


		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET LOCKIT011COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]

		MOV [WORD DS:SI+005H],0204H
		MOV [WORD DS:SI+020H],0F0CDH

		SUB SI,0100H
		MOV [WORD CS:FILESIZECOM],SI

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET LOCKIT011COMBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
LOCKIT011COMBRK0:
		JMP BRKPRX31COM1
CHECKLOCKIT011EXE:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET LOCKIT011EXEID1
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,16
		REP CMPSB
		JNZ CHECKGAHDR10

		MOV SI,[WORD CS:CHILDCSIP]
		ADD SI,0022
		MOV DI,OFFSET LOCKIT011EXEID2
		MOV DS,[WORD CS:CHILDCSIP+02]
		PUSH CS
		POP ES
		CLD
		MOV CX,6
		REP CMPSB
		JNZ CHECKGAHDR10

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET LOCKIT011EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:CHILDCSIP]

		MOV [WORD DS:SI+006H],0204H
		MOV [WORD DS:SI+01BH],0F0CDH

		MOV AX,DS
		ADD AX,0010H

		SUB SI,0100H
		SBB AX,0000H
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],SI

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET LOCKIT011EXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
LOCKIT011EXEBRK0:
		POP AX
		POP AX
		POP AX
		POP AX
		MOV [WORD CS:EXEHEADORIG+014H],AX
		POP AX
		SUB AX,[WORD CS:PID]
		SUB AX,0010H

		MOV [WORD CS:EXEHEADORIG+016H],AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+00EH],AX
		MOV [WORD CS:EXEHEADORIG+010H],SP

                PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
                MOV [WORD CS:HANDLE],AX
                MOV AX,3D00H
                MOV DX,OFFSET LINEPARAMETERS
                INT 21H
                MOV [WORD CS:HANDLE3],AX
                MOV CX,[WORD CS:EXEHEADORIG+006H]
                MOV [WORD CS:CANTRELOC],CX

                MOV AX,4200H
                MOV BX,[WORD CS:HANDLE3]
                XOR CX,CX
                MOV DX,[WORD CS:EXEHEADORIG+018H]
                INT 21H

                MOV [WORD CS:EXEHEADORIG+018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
                MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

                MOV CX,[WORD CS:CANTRELOC]
                JCXZ ENDLOCKIT011EXE
READLOCKIT:
                PUSH CX

                MOV AH,3FH
                MOV BX,[WORD CS:HANDLE3]
                MOV CX,0002
                MOV DX,OFFSET DATADI
                INT 21H

                MOV AH,3FH
                MOV BX,[WORD CS:HANDLE3]
                MOV CX,0002
                MOV DX,OFFSET DATAES
                INT 21H

                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
                MOV CX,0002
                MOV DX,OFFSET DATADI
                INT 21H

                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
                MOV CX,0002
                MOV DX,OFFSET DATAES
                INT 21H

                MOV AX,[WORD CS:PID]
                ADD AX,[WORD CS:DATAES]
                ADD AX,0010H
                MOV ES,AX
                MOV DI,[WORD CS:DATADI]
                MOV AX,[WORD CS:PID]
                ADD AX,0010H
                SUB [WORD ES:DI],AX

                POP CX
                LOOP READLOCKIT
ENDLOCKIT011EXE:
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE3]
                INT 21H
		JMP SAVECOMMON
CHECKGAHDR10:
		MOV SI,0100H
		MOV DI,OFFSET GAHDR10ID
		PUSH CS
		POP ES
		CLD
		MOV CX,30
		REP CMPSB
		JNZ CHECKPP1

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET GAHDR10
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:CHILDCSIP]

		MOV [WORD DS:SI+035H],0F0CDH

		MOV AX,DS
		ADD AX,0010H

		SUB SI,0100H

		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],SI

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET GAHDR10BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
GAHDR10BRK0:
		MOV DS,[WORD CS:DSEGMENT]

		MOV AX,[WORD DS:014DH]
		MOV [WORD CS:EXEHEADORIG+014H],AX

		MOV AX,[WORD DS:014FH]

		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+016H],AX

		MOV AX,[WORD DS:0153H]

		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+00EH],AX

		MOV AX,[WORD DS:0151H]
		MOV [WORD CS:EXEHEADORIG+010H],AX

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0020H
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		JMP SAVECOMMON
CHECKPP1:
		MOV SI,0100H
		MOV DI,OFFSET PPEPSCOMID
		PUSH CS
		POP ES
		CLD
		MOV CX,41
		REP CMPSB
		JNZ CHECKPP2

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PPEPSCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
PPMETOD1:
		MOV [WORD DS:01EEH],0F0CDH
		JMP PPCOMMON
PPMETOD2:
		MOV [WORD DS:01FCH],0F0CDH
		JMP PPCOMMON
PPMETOD3:
		MOV [WORD DS:0241H],0F0CDH
		JMP PPCOMMON
PPMETOD4:
		MOV [WORD DS:0265H],0F0CDH
		JMP PPCOMMON
PPMETOD5:
		MOV [WORD DS:01F6H],0F0CDH
		JMP PPCOMMON
PPMETOD6:
		MOV [WORD DS:0204H],0F0CDH
		JMP PPCOMMON
PPMETOD7:
		MOV [WORD DS:0245H],0F0CDH
		JMP PPCOMMON
PPMETOD8:
		MOV [WORD DS:026AH],0F0CDH
		JMP PPCOMMON
PPCOMMON:

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET PPEPSCOMBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
PPEPSCOMBRK0:
		SUB DI,0100H
		MOV [WORD CS:FILESIZECOM],DI
		JMP BRKPRX31COM1
CHECKPP2:
		MOV SI,0100H
		MOV DI,OFFSET PPEPSLCOMID
		PUSH CS
		POP ES
		CLD
		MOV CX,41
		REP CMPSB
		JNZ CHECKPP3

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PPEPSLCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		JMP PPMETOD2
CHECKPP3:
		MOV SI,0100H
		MOV DI,OFFSET PPEUSCOMID
		PUSH CS
		POP ES
		CLD
		MOV CX,40
		REP CMPSB
		JNZ CHECKPP4

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PPEUSCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		JMP PPMETOD3
CHECKPP4:
		MOV SI,0100H
		MOV DI,OFFSET PPEUSLCOMID
		PUSH CS
		POP ES
		CLD
		MOV CX,40
		REP CMPSB
		JNZ CHECKPP5

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PPEUSLCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		JMP PPMETOD4

CHECKPP5:
		MOV SI,0100H
		MOV DI,OFFSET PPEPSCOMVID
		PUSH CS
		POP ES
		CLD
		MOV CX,41
		REP CMPSB
		JNZ CHECKPP6

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PPEPSVCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		JMP PPMETOD5
CHECKPP6:
		MOV SI,0100H
		MOV DI,OFFSET PPEPSLCOMVID
		PUSH CS
		POP ES
		CLD
		MOV CX,41
		REP CMPSB
		JNZ CHECKPP7

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PPEPSLVCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		JMP PPMETOD6
CHECKPP7:
		MOV SI,0100H
		MOV DI,OFFSET PPEUSCOMVID
		PUSH CS
		POP ES
		CLD
		MOV CX,40
		REP CMPSB
		JNZ CHECKPP8

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PPEUSVCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		JMP PPMETOD7
CHECKPP8:
		MOV SI,0100H
		MOV DI,OFFSET PPEUSLCOMVID
		PUSH CS
		POP ES
		CLD
		MOV CX,40
		REP CMPSB
		JNZ CHECKPPEXE

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET PPEUSLVCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		JMP PPMETOD8













CHECKPPEXE:
		MOV SI,000CH
		MOV DI,OFFSET PPEXEID
		PUSH CS
		POP ES
		CLD
		MOV CX,34
		REP CMPSB
		JNZ CHECKDELTAPACKER
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DS,[WORD CS:DSEGMENT]
		JMP SEETYPECOMPR
PRINTPPCOMMON:
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		JMP PPEXECOMMON
SEETYPECOMPR:
SEETYPE1:
		CMP [BYTE DS:008CH],029H
		JNE SEETYPE2
		MOV DX,OFFSET PPEPSEXE
		MOV [BYTE CS:PPTYPE],01H
		JMP PRINTPPCOMMON
SEETYPE2:
		CMP [BYTE DS:008CH],037H
		JNE SEETYPE3
		MOV DX,OFFSET PPEPSLEXE
		MOV [BYTE CS:PPTYPE],02H
		JMP PRINTPPCOMMON
SEETYPE3:
		CMP [BYTE DS:008CH],0B1H
		JNE SEETYPE4
		MOV DX,OFFSET PPEUSEXE
		MOV [BYTE CS:PPTYPE],03H
		JMP PRINTPPCOMMON
SEETYPE4:
		CMP [BYTE DS:008CH],012H
		JNE SEETYPE5
		MOV DX,OFFSET PPEUSLEXE
		MOV [BYTE CS:PPTYPE],04H
		JMP PRINTPPCOMMON
SEETYPE5:
		CMP [BYTE DS:008CH],01AH
		JNE SEETYPE6
		MOV DX,OFFSET PPEPSVEXE
		MOV [BYTE CS:PPTYPE],05H
		JMP PRINTPPCOMMON
SEETYPE6:
		CMP [BYTE DS:008CH],01CH
		JNE SEETYPE7
		MOV DX,OFFSET PPEPSLVEXE
		MOV [BYTE CS:PPTYPE],06H
		JMP PRINTPPCOMMON
SEETYPE7:
		CMP [BYTE DS:008CH],0ACH
		JNE SEETYPE8
		MOV DX,OFFSET PPEUSVEXE
		MOV [BYTE CS:PPTYPE],07H
		JMP PRINTPPCOMMON
SEETYPE8:
		CMP [BYTE DS:008CH],0F5H
		JNE CHECKSCRE2B
		MOV DX,OFFSET PPEUSLVEXE
		MOV [BYTE CS:PPTYPE],08H
		JMP PRINTPPCOMMON







PPEXECOMMON:
		MOV DS,[WORD CS:DSEGMENT]

		CMP [BYTE CS:PPTYPE],01H
		JZ PUTBRK1
		CMP [BYTE CS:PPTYPE],02H
		JZ PUTBRK2
		CMP [BYTE CS:PPTYPE],03H
		JZ PUTBRK3
		CMP [BYTE CS:PPTYPE],04H
		JZ PUTBRK4
		CMP [BYTE CS:PPTYPE],05H
		JZ PUTBRK5
		CMP [BYTE CS:PPTYPE],06H
		JZ PUTBRK6
		CMP [BYTE CS:PPTYPE],07H
		JZ PUTBRK7
		CMP [BYTE CS:PPTYPE],08H
		JZ PUTBRK8

PUTBRK1:
		MOV [WORD DS:012EH],0F0CDH
		MOV [WORD DS:014AH],0F0CDH
		MOV [BYTE DS:014CH],090H
		MOV [WORD DS:016CH],0F0CDH
		JMP PPBRKCOMMON
PUTBRK2:
		MOV [WORD DS:013CH],0F0CDH
		MOV [WORD DS:0158H],0F0CDH
		MOV [BYTE DS:015AH],090H
		MOV [WORD DS:017AH],0F0CDH
		JMP PPBRKCOMMON
PUTBRK3:
		MOV [WORD DS:0172H],0F0CDH
		MOV [WORD DS:018AH],0F0CDH
		MOV [BYTE DS:018CH],090H
		MOV [WORD DS:01AAH],0F0CDH
		JMP PPBRKCOMMON
PUTBRK4:
		MOV [WORD DS:019AH],0F0CDH
		MOV [WORD DS:01B2H],0F0CDH
		MOV [BYTE DS:01B4H],090H
		MOV [WORD DS:01D2H],0F0CDH
		JMP PPBRKCOMMON
PUTBRK5:
		MOV [WORD DS:014DH],0F0CDH
		MOV [WORD DS:0177H],0F0CDH
		MOV [BYTE DS:0179H],090H
		MOV [WORD DS:0199H],0F0CDH
		JMP PPBRKCOMMON
PUTBRK6:
		MOV [WORD DS:015BH],0F0CDH
		MOV [WORD DS:0185H],0F0CDH
		MOV [BYTE DS:0187H],090H
		MOV [WORD DS:01A7H],0F0CDH
		JMP PPBRKCOMMON
PUTBRK7:
		MOV [WORD DS:018EH],0F0CDH
		MOV [WORD DS:01ADH],0F0CDH
		MOV [BYTE DS:01AFH],090H
		MOV [WORD DS:01CDH],0F0CDH
		JMP PPBRKCOMMON
PUTBRK8:
		MOV [WORD DS:01B6H],0F0CDH
		MOV [WORD DS:01D5H],0F0CDH
		MOV [BYTE DS:01D7H],090H
		MOV [WORD DS:01F5H],0F0CDH
		JMP PPBRKCOMMON


PPBRKCOMMON:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET PPEXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		MOV [WORD CS:DSEGMENT],SS
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
PPEXEBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPES]
		MOV BX,[WORD CS:TEMPDI]
		MOV CX,[WORD CS:PID]
		ADD CX,0010H
		CMP AX,CX
		JAE PUTPPNORMAL
CALCLENGTH:
		INC AX
		SUB BX,0010H
		CMP AX,CX
		JE PUTPPNORMAL
		JMP CALCLENGTH
PUTPPNORMAL:
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],BX


		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV [WORD ES:03C0H],OFFSET PPEXEBRK1

		CALL POPTEMP
		CMP [BYTE CS:PPTYPE],03
		JZ THEOTHERDSEGMENT
		CMP [BYTE CS:PPTYPE],04
		JZ THEOTHERDSEGMENT
		CMP [BYTE CS:PPTYPE],05
		JZ THEOTHERINSTRUCTION
		CMP [BYTE CS:PPTYPE],06
		JZ THEOTHERINSTRUCTION
		CMP [BYTE CS:PPTYPE],07
		JZ THEOTHERINSTRUCTION
		CMP [BYTE CS:PPTYPE],08
		JZ THEOTHERINSTRUCTION

		MOV ES,[WORD CS:TEMPDS]
		JMP ALLCOMMONPP
THEOTHERINSTRUCTION:
		XOR SI,SI
		JMP ALLCOMMONPP

THEOTHERDSEGMENT:
		MOV DS,[WORD CS:DSEGMENT]
ALLCOMMONPP:
		POPF
		IRET

PPEXEBRK1:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPCX]
		CMP AX,0000H
		JE NOMASRELOC5

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
NOMASRELOC5:
		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:TEMPSI]
		MOV DI,[WORD CS:TEMPDI]
		SUB DI,[WORD CS:PID]
		SUB DI,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],DI
		MOV [WORD CS:EXEHEADORIG+10H],SI



		MOV AX,[WORD DS:0000H]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:0002H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX

		JMP SAVECOMMON
CHECKUTILCODED:
		MOV SI,0000H
		MOV DI,OFFSET UTILCODEDID
		PUSH CS
		POP ES
		CLD
		MOV CX,37
		REP CMPSB
		JNZ CHECKDEMO20

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET UTILCODED
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:04FH],0F0CDH
		MOV [WORD DS:051H],09090H
		MOV [BYTE DS:053H],090H

		MOV [WORD DS:066H],0F0CDH
		MOV [WORD DS:068H],090H
		MOV [WORD DS:07CH],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET UTILCODEDBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
UTILCODEDBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPES]
		MOV BX,[WORD CS:TEMPDI]
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],BX

		MOV [WORD ES:03C0H],OFFSET UTILCODEDBRK1

		CALL POPTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV CX,[WORD DS:BP+0AF3H]
		MOV DS,[WORD CS:TEMPDS]
		POPF
		IRET
UTILCODEDBRK1:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPCX]
		CMP AX,0000H
		JE NOMASRELOC6

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
NOMASRELOC6:
		CALL POPTEMP
		POPF

		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV BX,SP
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV [WORD CS:EXEHEADORIG+10H],BX


		MOV AX,[WORD DS:BP+0AEBH]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:BP+0AEDH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX

		JMP SAVECOMMON
CHECKDELTAPACKER:
		MOV SI,000BH
		MOV DI,OFFSET DELTAPACKERID
		PUSH CS
		POP ES
		CLD
		MOV CX,22
		REP CMPSB
		JNZ CHECKEXEPACK360
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET DELTAPACKER
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]

		MOV [WORD DS:034H],0F0CDH
		MOV [WORD DS:059H],0F0CDH
		MOV [BYTE DS:05BH],090H

		MOV [WORD DS:063H],0F0CDH
		MOV [BYTE CS:COMPRTYPE],01H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET DELTAPACKERBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
DELTAPACKERBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPDS]
		MOV BX,[WORD CS:TEMPSI]
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],BX

		MOV [WORD ES:03C0H],OFFSET DELTAPACKERBRK1

		CALL POPTEMP
		MOV AX,[WORD CS:TEMPES]
		POPF
		IRET
DELTAPACKERBRK1:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPCX]
		CMP AX,0000H
		JE NOMASRELOC7

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
NOMASRELOC7:
		CALL POPTEMP
		POPF

		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV BX,SP
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV [WORD CS:EXEHEADORIG+10H],BX


		MOV AX,[WORD DS:069H]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:06BH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX

		JMP SAVECOMMON
CHECKEXEPACK360:
                MOV SI,0010H
		MOV DI,OFFSET EXEPACK360ID
		PUSH CS
		POP ES
		CLD
		MOV CX,34
		REP CMPSB
		JNZ CHECKEXEPACK405
		CMP [WORD DS:0F6H],0FF2EH
		JNZ CHECKEXEPACK400

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EXEPACK360
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:027H],0F0CDH
		MOV [WORD DS:0B5H],0F0CDH
		MOV [BYTE DS:0B7H],090H
		MOV [WORD DS:0CEH],0F0CDH
		MOV [BYTE DS:0D0H],090H

		MOV [WORD DS:0F0H],0F0CDH
EXEPACKCOMMON:

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET EXEPACK360BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
EXEPACK360BRK0:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPES]
		MOV [WORD CS:DSEGMENT],AX
		XOR BX,BX
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],BX

		MOV [WORD ES:03C0H],OFFSET EXEPACK360BRK1

		CALL POPTEMP
		CMP [BYTE CS:EXEPACK],01
		JZ UNKNOWNEXEPACKBRK
		MOV SI,[WORD CS:TEMPDI]
		POPF
		IRET
UNKNOWNEXEPACKBRK:
		MOV DI,[WORD CS:TEMPSI]
		POPF
		IRET
EXEPACK360BRK1:
		PUSHF
		CALL PUSHTEMP
		CMP [BYTE CS:EXEPACK],01H
		JZ SECONDEXEPACKUNKNOWNBRK
		MOV AX,[WORD CS:TEMPCX]
		CMP AX,0000H
		JE NOMASRELOC8
CONTRELOC:
		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
SECONDEXEPACKUNKNOWNBRK:
		MOV AX,[WORD CS:TEMPAX]
		CMP AX,0FFFFH
                JE NOMASRELOC8B
		JMP CONTRELOC
NOMASRELOC8:
                CMP [BYTE CS:EXEPACK],02H
                JNZ NOMASRELOC8C
                MOV BX,SP
                MOV DX,[WORD SS:BX+02H]
                CMP DX,00D9H
                JNZ CONTRELOC
                JMP NOMASRELOC8B



NOMASRELOC8C:
                MOV DX,[WORD CS:TEMPDX]
		CMP DX,0F000H
		JNZ CONTRELOC
NOMASRELOC8B:
                POPF
NOMASRELOC8A:
		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		CMP [BYTE CS:EXEPACK],01H
		JZ UNKNOWNEXEPACK1

		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD CS:TEMPSI]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV BX,[WORD CS:TEMPDI]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV [WORD CS:EXEHEADORIG+10H],BX


		MOV AX,[WORD DS:0000H]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:0002]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP EXEPACKLASTCOMMON
UNKNOWNEXEPACK1:
		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD CS:TEMPCX]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV BX,[WORD CS:TEMPDX]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV [WORD CS:EXEHEADORIG+10H],BX


		MOV AX,[WORD DS:000CH]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:000EH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP EXEPACKLASTCOMMON

EXEPACKLASTCOMMON:
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX

		JMP SAVECOMMON
CHECKEXEPACK400:
                CMP [WORD DS:0E3H],0FF2EH
                JNZ CHECKEXEPACK403

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EXEPACK400
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:027H],0F0CDH
		MOV [WORD DS:0B2H],0F0CDH
		MOV [BYTE DS:0B4H],090H
		MOV [WORD DS:0DDH],0F0CDH

		JMP EXEPACKCOMMON
CHECKEXEPACK405:
		MOV SI,0012H
		MOV DI,OFFSET EXEPACK405ID
		PUSH CS
		POP ES
		CLD
		MOV CX,38
		REP CMPSB
		JNZ CHECKEXEPACK531

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EXEPACK405
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:029H],0F0CDH
		MOV [WORD DS:0BDH],0F0CDH
		MOV [BYTE DS:0BFH],090H
		MOV [WORD DS:0D6H],0F0CDH
		MOV [BYTE DS:0D8H],090H
		MOV [WORD DS:0F8H],0F0CDH

		JMP EXEPACKCOMMON

CHECKEXEPACK531:
                MOV SI,0010H
		MOV DI,OFFSET EXEPACK531ID
		PUSH CS
		POP ES
		CLD
		MOV CX,36
		REP CMPSB
		JNZ CHECKEXEPACKUNKNOWN1

                CMP [WORD DS:0103H],0FF2EH
                JNZ CHECKEXEPACKUNKNOWN2

                MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EXEPACK531
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:029H],0F0CDH
		MOV [WORD DS:0C0H],0F0CDH
		MOV [BYTE DS:0C2H],090H
		MOV [WORD DS:0D9H],0F0CDH
		MOV [BYTE DS:0DBH],090H
		MOV [WORD DS:0FBH],0F0CDH

		JMP EXEPACKCOMMON
CHECKEXEPACKUNKNOWN1:
		MOV SI,0010H
		MOV DI,OFFSET EXEPACKUNKNOWN1ID
		PUSH CS
		POP ES
		CLD
		MOV CX,36
		REP CMPSB
		JNZ CHECKEPW120EXE

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EXEPACKUNKNOWN1
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:029H],0F0CDH
		MOV [WORD DS:0A3H],0F0CDH
		MOV [BYTE DS:0A5H],090H
		MOV [WORD DS:0C0H],0F0CDH
		MOV [BYTE CS:EXEPACK],01H

		JMP EXEPACKCOMMON

CHECKEXEPACKUNKNOWN2:
                CMP [WORD DS:0103H],02EC5H
                JNZ CHECKEXEPACKUNKNOWN1

                MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET EXEPACKUNKNOWN2
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

                MOV DS,[WORD CS:DSEGMENT]
                MOV [WORD DS:029H],0F0CDH
                MOV [WORD DS:0C1H],0F0CDH
                MOV [BYTE DS:0C3H],090H
                MOV [WORD DS:0DAH],0F0CDH
                MOV [BYTE DS:0DCH],090H
                MOV [WORD DS:0FCH],0F0CDH

		JMP EXEPACKCOMMON
CHECKEPW120:
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET EPW120COMID
		PUSH CS
		POP ES
		CLD
		MOV CX,32
		REP CMPSB
		JNZ CHECKEPW130

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EPW120COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]

		MOV [WORD DS:SI+0FDH],0F0CDH
		MOV CX,[WORD DS:SI-0D3H]
		MOV [WORD CS:FILESIZECOM],CX
EPWCOMCOMMON:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET EPW12BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
EPW12BRK0:
		JMP BRKPRX31COM1
CHECKEPW130:
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET EPW130COMID
		PUSH CS
		POP ES
		CLD
		MOV CX,32
		REP CMPSB
		JNZ CHECKEXE2COMMS

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EPW130COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]

		MOV [WORD DS:SI+0100H],0F0CDH
		MOV CX,[WORD DS:SI-0B1H]
		MOV [WORD CS:FILESIZECOM],CX
		JMP EPWCOMCOMMON
CHECKEPW120EXE:
		MOV SI,0166H
		MOV DI,OFFSET EPW120EXEID
		PUSH CS
		POP ES
		CLD
		MOV CX,37
		REP CMPSB
		JNZ CHECKEPW130EXE

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EPW120EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:02C4H],0F0CDH
		MOV [WORD DS:02C6H],09090H
		MOV [WORD DS:02C8H],09090H
		MOV [WORD DS:02CAH],09090H
		MOV [WORD DS:02CCH],09090H
		MOV [WORD DS:02CEH],09090H
		MOV [WORD DS:02D0H],09090H


		MOV [WORD DS:02D4H],0F0CDH
		MOV [BYTE DS:02D6H],090H
		MOV [WORD DS:033AH],0F0CDH

EPWEXECOMMON:
		MOV DX,[WORD DS:0014H]
		MOV AX,[WORD DS:0012H]
		PUSH DX
		PUSH AX

		CLC
		XOR DX,DX
		MOV DS,[WORD CS:PID]
		MOV AX,[WORD DS:0108H]
		MOV CX,0010H
		MUL CX
		MOV BX,DX
		MOV CX,AX

		POP AX
		POP DX
		SUB AX,CX
		SBB DX,BX
		CLC
		MOV CX,0010H
		DIV CX
		CLC

		MOV CX,[WORD CS:PID]
		ADD AX,0010H
		ADD AX,CX

		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],DX

		MOV [BYTE CS:EPW],01H

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET EPW120EXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
EPW120EXEBRK0:
		PUSHF
		CALL PUSHTEMP

		MOV CX,[WORD CS:TEMPCX]
		CMP CX,0000H
		JE NOMASRELOC9

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
NOMASRELOC9:
		MOV [WORD ES:03C0H],OFFSET EPW120BRK1
		CALL POPTEMP
		MOV DS,[WORD CS:TEMPDS]
		MOV AX,[WORD DS:0004H]

		POPF
		IRET
EPW120BRK1:
		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:0006H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV BX,[WORD DS:0004H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV [WORD CS:EXEHEADORIG+10H],BX


		MOV AX,[WORD DS:0000H]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:0002H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX

		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX

		JMP SAVECOMMON
CHECKEPW130EXE:
		MOV SI,0143H
		MOV DI,OFFSET EPW130EXEID
		PUSH CS
		POP ES
		CLD
		MOV CX,33
		REP CMPSB
		JNZ CHECKEXE2COMLIM

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EPW130EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:02A3H],0F0CDH
		MOV [WORD DS:02A5H],09090H
		MOV [WORD DS:02A7H],09090H
		MOV [WORD DS:02A9H],09090H
		MOV [WORD DS:02ABH],09090H
		MOV [WORD DS:02ADH],09090H
		MOV [WORD DS:02AFH],09090H


		MOV [WORD DS:02B3H],0F0CDH
		MOV [BYTE DS:02B5H],090H
		MOV [WORD DS:0319H],0F0CDH

		JMP EPWEXECOMMON
CHECKBINLOCK100:
		CMP [BYTE DS:0101H],004H
                JNE CHECKANTIGENCOM

		PUSH CS
		POP ES
		MOV SI,0106H
		MOV DI,OFFSET BINLOCK100ID
		MOV CX,0045
		CLD
		REP CMPSB
		JNZ CHECKTHEREST

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET BINLOCK100
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:010DH],0204H
		MOV [WORD DS:0114H],0206H
		MOV [WORD DS:0119H],020CH
		MOV [WORD DS:0120H],020EH
		MOV [WORD DS:0122H],09090H
		MOV [WORD DS:0124H],09090H
		MOV [WORD DS:0126H],09090H
		MOV [BYTE DS:0128H],090H
		MOV [WORD DS:0129H],0F0CDH
		MOV [WORD DS:012BH],09090H
		MOV [WORD DS:012DH],083CDH
		MOV [WORD DS:012FH],081CDH
		MOV [WORD DS:015BH],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET BINLOCK100BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]

BINLOCK100BRK0:
		PUSHF
		CALL PUSHTEMP
		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET BINLOCK100BRK1
		CALL POPTEMP
		POPF
		IRET
BINLOCK100BRK1:
		PUSHF
		CALL PUSHTEMP
		MOV CX,[WORD CS:TEMPCX]
		CMP CX,0001H
		JZ BINLOCKOK
		CALL POPTEMP
		ADD DL,BL
		POPF
		IRET
BINLOCKOK:
		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET BINLOCK100BRK2
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:01AEH],0F0CDH
		MOV CX,[WORD DS:0104H]
		MOV [WORD CS:FILESIZECOM],CX
		CALL POPTEMP
		ADD DL,BL
		POPF
		IRET
BINLOCK100BRK2:
		MOV [WORD CS:CHILDCSIP],0100H
		MOV [WORD CS:CHILDCSIP+02H],DS
		JMP BRKPRX31COM1
CHECKEXE2COMLIM:
                CMP [BYTE DS:0100H],0BEH
                JNZ CHECKCRUNCHER10

                MOV SI,0103H
                MOV DI,OFFSET EXE2COMLIMID1
                MOV CX,0005
		REP CMPSB
		JNZ CHECKCRUNCHER10

                MOV SI,[WORD DS:0101H]
                CMP [WORD DS:SI],05A4DH
		JNZ CHECKCRUNCHER10

                XOR AH,AH
                MOV AL,[BYTE DS:0109H]
                ADD AX,010AH

                MOV [WORD CS:OFFSALTO],AX
                MOV [WORD CS:TEMPBYTE],SI

                MOV SI,AX
                MOV DI,OFFSET EXE2COMLIMID2
                MOV CX,0014
		REP CMPSB
		JNZ CHECKCRUNCHER10

                MOV SI,[WORD CS:OFFSALTO]
                ADD SI,0023H
                MOV DI,OFFSET EXE2COMLIMID3
                MOV CX,0011
		REP CMPSB
		JNZ CHECKCRUNCHER10

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EXE2COMLIM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

                MOV SI,[WORD CS:TEMPBYTE]
                MOV [WORD CS:OFFSALTO],SI

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0100H],0F0CDH
		CLC
		XOR DX,DX
                MOV CX,[WORD DS:SI+002H]
                MOV AX,[WORD DS:SI+004H]
		CMP CX,0000H
		JZ ALLNUMBERNORMAL
		DEC AX
ALLNUMBERNORMAL:
		MOV CX,0200H
		MUL CX
                ADD AX,[WORD DS:SI+002H]
		MOV [WORD CS:FILESIZECOM],AX
EXE2COMMSCOMMON:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET EXE2COMLIMBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
EXE2COMLIMBRK0:
		CMP [BYTE CS:EXE2COMMSOK],01H
		JZ PUTOTHERCHILDCSIP
                MOV SI,[WORD CS:TEMPBYTE]
                MOV [WORD CS:CHILDCSIP],SI
		JMP BRKPRX31COM1
PUTOTHERCHILDCSIP:
		MOV [WORD CS:CHILDCSIP],0110H
		JMP BRKPRX31COM1
CHECKCRUNCHER10:
		MOV SI,0005H
		MOV DI,OFFSET CRUNCHER10ID1
		PUSH CS
		POP ES
		CLD
		MOV CX,18
		REP CMPSB
		JNZ CHECKSEAAXE10

		MOV SI,0019H
		MOV DI,OFFSET CRUNCHER10ID2
		PUSH CS
		POP ES
		CLD
		MOV CX,15
		REP CMPSB
		JNZ CHECKSEAAXE10

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET CRUNCHER10
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV AH,062H
		INT 21H
		MOV [WORD CS:PID],BX
		ADD BX,0010H
		MOV DS,BX
		MOV [WORD DS:0027H],0F0CDH
		MOV [BYTE DS:0029H],090H
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:077H],09090H
		MOV [WORD DS:0B3H],09090H
		MOV [WORD DS:0C7H],09090H
		MOV [WORD DS:02C2H],09090H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET CRUNCHER10BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
CRUNCHER10BRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:TEMPDS]
		MOV AX,[WORD DS:0000H]
		CMP AX,05A4DH
		JZ PUTBRKEXE
		CMP AX,04D5AH
		JZ PUTBRKEXE
		MOV BX,SP
		MOV DS,[WORD SS:BX+04H]
		MOV [WORD CS:DSEGMENT],DS
		MOV [WORD DS:050H],0F0CDH
		MOV [WORD DS:072H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET CRUNCHER10BRK1
		CALL POPTEMP
		MOV AX,[WORD DS:0000]
		POPF
		IRET

PUTBRKEXE:
		MOV BX,SP
		MOV DS,[WORD SS:BX+04H]
		MOV [WORD CS:DSEGMENT],DS
		MOV [WORD DS:073H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET CRUNCHER10EXEBRK1
		CALL POPTEMP
		MOV AX,[WORD DS:0000]
		POPF
		IRET
CRUNCHER10BRK1:
		PUSHF
		ADD CX,CX
		CALL PUSHTEMP
		MOV [WORD CS:FILESIZECOM],CX
		MOV [WORD ES:03C0H],OFFSET CRUNCHER10BRK2
		CALL POPTEMP
		POPF
		IRET
CRUNCHER10BRK2:
		MOV DS,[WORD CS:PID]
		MOV [WORD CS:CHILDCSIP],0100H
		MOV [WORD CS:CHILDCSIP+02],DS
		MOV [WORD CS:EXEHEADORIG],02020H
		MOV [BYTE CS:OVERLAY],00H

		JMP BRKPRX31COM1
CRUNCHER10EXEBRK1:
		PUSHF
		CALL POPTEMP
		MOV DS,[WORD CS:TEMPDS]
		CLC
		XOR DX,DX
		MOV CX,[WORD DS:0002H]
		MOV AX,[WORD DS:0004H]
		CMP CX,0000H
		JZ ALLNUMBERNORMAL2
		DEC AX
ALLNUMBERNORMAL2:
		MOV CX,0200H
		MUL CX
		CLC
		MOV CX,0010H
		DIV CX

		PUSH AX

		MOV AX,3D02H
		PUSH CS
		POP DS
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV BX,AX

		POP CX

		MOV AX,[WORD TEMPDS]
		DEC AX
		MOV DS,AX
SAVEALLMEM:
		MOV AX,DS
		INC AX
		MOV DS,AX

		PUSH CX

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0010H
		XOR DX,DX
		INT 21H

		POP CX

		LOOP SAVEALLMEM

		PUSH DS
		MOV DS,[WORD CS:TEMPDS]
		MOV CX,[WORD DS:0002H]
		POP AX
		INC AX
		MOV DS,AX

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		XOR DX,DX
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		MOV [BYTE CS:OVERLAY],00H
		JMP SETCOM

CHECKEXE2COMMS:
		MOV SI,[WORD CS:OFFSALTO]
		MOV DI,OFFSET EXE2COMMSID
		PUSH CS
		POP ES
		CLD
		MOV CX,35
		REP CMPSB
		JNZ CHECKCOMLOCK010

		CMP [WORD DS:0110H],05A4DH
		JNZ CHECKCOMLOCK010

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET EXE2COMMS
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		MOV [BYTE CS:EXE2COMMSOK],01H

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0100H],0F0CDH
		CLC
		XOR DX,DX
		MOV CX,[WORD DS:0112H]
		MOV AX,[WORD DS:0114H]
		CMP CX,0000H
		JZ ALLNUMBERNORMAL3
		DEC AX
ALLNUMBERNORMAL3:
		MOV CX,0200H
		MUL CX
		ADD AX,[WORD DS:0112H]
		MOV [WORD CS:FILESIZECOM],AX
		JMP EXE2COMMSCOMMON
CHECKSEAAXE10:
		MOV SI,00B6H
		MOV DI,OFFSET SEAAXE10ID
		PUSH CS
		POP ES
		CLD
		MOV CX,40
		REP CMPSB
                JNZ CHECKOPTLINKPASS1

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET SEAAXE10
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:03FBH],0F0CDH
		MOV [WORD DS:0150H],0F0CDH
		MOV [BYTE DS:0152H],090H
		MOV [WORD DS:015FH],0F0CDH
		MOV [WORD DS:0161H],09090H
		MOV [WORD DS:0163H],09090H
		MOV [WORD DS:0165H],09090H

		MOV [WORD DS:0177H],0F0CDH
		MOV [BYTE CS:COMPRTYPE],01H

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET SEAAXE10BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
SEAAXE10BRK0:
		PUSHF
		CALL PUSHTEMP
		CMP [WORD SS:00B0H],0FFFFH
		JNZ BRKSEAAXENORMAL

		MOV AX,[WORD CS:TEMPES]
		MOV BX,[WORD CS:TEMPDI]
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],BX
		MOV BX,SP
		MOV AX,[WORD SS:BX+04H]
		MOV [WORD CS:DSEGMENT],AX

		MOV [WORD ES:03C0H],OFFSET SEAAXE10BRK1
BRKSEAAXENORMAL:
		CALL POPTEMP
		MOV AX,DS
		POPF
		IRET
SEAAXE10BRK1:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPCX]
		CMP AX,0000H
		JE NOMASRELOC10

		CALL SAVERELOC2

		CALL POPTEMP
		POPF
		IRET
NOMASRELOC10:
		MOV AX,[WORD CS:TEMPAX]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV [WORD ES:03C0H],OFFSET SEAAXE10BRK2
		CALL POPTEMP
		POPF
		IRET
SEAAXE10BRK2:
		CALL PUSHTEMP
		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD DS:007CH]
		MOV [WORD CS:EXEHEADORIG+10H],BX


		POP AX
		MOV [WORD CS:EXEHEADORIG+14H],AX

		POP AX
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX

		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX

		MOV [BYTE CS:OVERLAY],00H
		JMP SAVECOMMON
CHECKOPTLINKPASS1:
                MOV SI,0000H
                MOV DI,OFFSET OPTLINKPASS1ID1
		PUSH CS
		POP ES
		CLD
		MOV CX,4
		REP CMPSB
                JNZ CHECKOPTLINKPASS2

                MOV SI,000FH
                MOV DI,OFFSET OPTLINKPASS1ID2
		PUSH CS
		POP ES
		CLD
                MOV CX,24
		REP CMPSB
                JNZ CHECKOPTLINKPASS2

                MOV BP,0000H
OPTLBRKADJUST:
                MOV SI,0031H
                ADD SI,BP
                MOV DI,OFFSET OPTLINKGENPASS1ID
                PUSH CS
                POP ES
                CLD
                MOV CX,0029
                REP CMPSB
                JZ OPTLINKOK
                INC BP
                CMP BP,01000H
                JE CHECKOPTLINKPASS2
                JMP OPTLBRKADJUST
OPTLINKOK:
                SUB SI,0029
                MOV [WORD CS:OFFSALTO],SI

                MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET OPTLINKPASS1
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
                MOV [WORD DS:SI+001H],0F0CDH
                MOV [BYTE DS:SI+003H],090H
                MOV [WORD DS:SI+00EH],0F0CDH

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET OPTLINK1BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
OPTLINK1BRK0:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPES]
		MOV BX,[WORD CS:TEMPDI]
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],BX
		MOV BX,SP
		MOV AX,[WORD SS:BX+04H]
		MOV [WORD CS:DSEGMENT],AX
		MOV [WORD ES:03C0H],OFFSET OPTLINK1BRK1
		CALL POPTEMP
		SUB DX,+10
		POPF
		IRET
OPTLINK1BRK1:
		CALL PUSHTEMP

		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H


		MOV AX,[WORD CS:TEMPAX]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX

		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD DS:0007H]
		MOV [WORD CS:EXEHEADORIG+10H],BX

		MOV AX,[WORD DS:000BH]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:000DH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX

		XOR AX,AX
		MOV [WORD EXEHEADORIG+06H],AX

		JMP SAVECOMMON
CHECKOPTLINKPASS2:
                MOV SI,0002H
		MOV DI,OFFSET OPTLINKID4
		PUSH CS
		POP ES
		CLD
		MOV CX,46
		REP CMPSB
		JNZ SEEWHICHOPTL
		MOV [BYTE CS:OPTLINK],01H
		JMP OPTLINKOK2
SEEWHICHOPTL:
		MOV SI,0002H
		MOV DI,OFFSET OPTLINKID5
		PUSH CS
		POP ES
		CLD
		MOV CX,38
		REP CMPSB
		JNZ CHECKOLDUNP1
		MOV [BYTE CS:OPTLINK],02H
OPTLINKOK2:
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET OPTLINKPASS2
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		CMP [BYTE CS:OPTLINK],02
		JZ OPTLINKBRK2
		MOV [WORD DS:06FH],0F0CDH
		MOV [WORD DS:0BAH],0F0CDH
		MOV [WORD DS:0BCH],09090H
		JMP OPTLINKCOMMON
OPTLINKBRK2:
		MOV [WORD DS:067H],0F0CDH
		MOV [WORD DS:0AAH],0F0CDH
		MOV [WORD DS:0ACH],09090H
OPTLINKCOMMON:
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET OPTLINK2BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
OPTLINK2BRK0:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPCX]
		CMP AX,0000H

		JE NOMASRELOC11

		PUSH DI
		SUB DI,0001H
		MOV [WORD CS:TEMPDI],DI
		CLC
		CALL SAVERELOC2
		CALL POPTEMP
		SUB BX,DX
		POP DI
		XCHG BX,[WORD ES:DI-01]
		POPF
		IRET
NOMASRELOC11:
		MOV AX,[WORD CS:TEMPES]
		MOV BX,[WORD CS:TEMPDI]
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],BX
		MOV BX,SP
		MOV AX,[WORD SS:BX+04H]
		MOV [WORD CS:DSEGMENT],AX
		POPF

		POP AX
		POP AX
		POP AX
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		CMP [BYTE CS:OPTLINK],02
		JZ PUTOTHERCSIP

		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:014EH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX

		MOV AX,[WORD DS:014CH]
		MOV [WORD CS:EXEHEADORIG+10H],AX

		MOV AX,[WORD DS:0150H]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:0152H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP SAVECOMMONOPTLINK
PUTOTHERCSIP:
		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:013EH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX

		MOV AX,[WORD DS:013CH]
		MOV [WORD CS:EXEHEADORIG+10H],AX

		MOV AX,[WORD DS:0140H]
		MOV [WORD CS:EXEHEADORIG+14H],AX

		MOV AX,[WORD DS:0142H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
SAVECOMMONOPTLINK:

		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX

		JMP SAVECOMMON
CHECKOLDUNP1:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET OLDUNPID1
		PUSH CS
		POP ES
		CLD
		MOV CX,0007
		REP CMPSB
		JNZ CHECKOLDUNP2
UNPCOMMON:
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET OLDUNP
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
UNPCOMMON2:

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:CHILDCSIP]

		MOV [WORD DS:SI],0F0CDH

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET OLDUNPBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
OLDUNPBRK0:
		POP AX
		POP AX
		POP AX

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:CHILDCSIP]
		CMP [BYTE CS:DISLITEOK],02H
		JNZ XTROK
		MOV AX,[WORD DS:SI+13]
		JMP UNPOK
XTROK:
		CMP [BYTE CS:DISLITEOK],03H
		JNZ OLDUNPOK
		MOV AX,[WORD DS:SI+22]
		JMP UNPOK
OLDUNPOK:
		MOV AX,[WORD DS:SI+07H]
		CMP [BYTE CS:DISLITEOK],01H
		JNZ UNPOK
		MOV BX,SI
		CLC
		ADD AX,BX
		CLC
		ADD AX,0009H
UNPOK:
		MOV [WORD CS:EXEHEADORIG+14H],AX
		CMP [BYTE CS:DISLITEOK],01H
		JZ UNPOK2
		CMP [BYTE CS:DISLITEOK],02H
		JZ NEWUNP1
		CMP [BYTE CS:DISLITEOK],03H
		JZ XTROK2
		MOV AX,[WORD DS:SI+09H]
		JMP UNPOK3
NEWUNP1:
		MOV AX,[WORD DS:SI+09H]
		SUB AX,0010H
		JMP ALLFAKESCOMMON
XTROK2:
		MOV AX,[WORD DS:SI+18]
		SUB AX,0010H
		JMP ALLFAKESCOMMON
UNPOK2:
		MOV AX,DS
UNPOK3:
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
ALLFAKESCOMMON:
		MOV [WORD CS:EXEHEADORIG+16H],AX

		MOV AX,3D00H
		PUSH CS
		POP DS
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE3],AX

		MOV DX,[WORD CS:EXEHEADORIG+18H]
		XOR CX,CX
		MOV AX,4200H
		MOV BX,[WORD CS:HANDLE3]
		INT 21H

		CLC
		MOV CX,[WORD CS:EXEHEADORIG+08H]
		MOV [WORD CS:TEMPBYTE],CX
		MOV CX,[WORD CS:EXEHEADORIG+06H]
		CMP [BYTE CS:DISLITEOK],01H
		JZ UNPOK5
		CMP [BYTE CS:DISLITEOK],02H
		JZ UNPOK5
		CMP [BYTE CS:DISLITEOK],03H
		JZ UNPOK5
		DEC CX
UNPOK5:
		MOV [WORD CS:EXEHEADORIG+06H],CX
		JCXZ HEADFIX
SAVEALLRELOCATIONS:
		PUSH CX

		PUSH CS
		POP DS
		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE3]
		MOV CX,0002H
		MOV DX,OFFSET DATADI
		INT 21H

		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE3]
		MOV CX,0002H
		MOV DX,OFFSET DATAES
		INT 21H

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0002H
		MOV DX,OFFSET DATADI
		INT 21H

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0002H
		MOV DX,OFFSET DATAES
		INT 21H

		POP CX

		LOOP SAVEALLRELOCATIONS
HEADFIX:

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		CALL FIXHEADLENGTH

		MOV AX,3D02H
		PUSH CS
		POP DS
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		CLC
		MOV AX,[WORD CS:TEMPBYTE]
		MOV CX,0010H
		MUL CX
		CLC
		MOV CX,DX
		MOV DX,AX

		MOV AX,4200H
		MOV BX,[WORD CS:HANDLE3]
		INT 21H

		MOV AH,62H
		INT 21H
		MOV ES,BX

		MOV AH,49h
		INT 21H

		MOV ES,[WORD CS:PID3]

		MOV AX,ES
		MOV BX,XT
		SUB BX,AX

		MOV AH,4AH
		INT 21H

		MOV AH,48H
		MOV BX,0500H
		INT 21H

		JNC MEMOOK2

		MOV DX,OFFSET NOTMEMO
		CALL PRINT

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE3]
		INT 21

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21

		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		XOR CX,CX
		INT 21H


		MOV AH,41H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV AX,3D02H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV BX,[WORD CS:HANDLE]
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H
		MOV AH,3EH
		INT 21H
		MOV AX,4301H
		MOV DX,OFFSET LINEPARAMETERS
		MOV CX,[WORD CS:ATRIB]
		INT 21H


		MOV [BYTE CS:EXITORCONT],00H
		MOV AX,OFFSET FIN2
		PUSH AX
		RET

MEMOOK2:
		MOV [WORD CS:RESERSEG],AX

READONCEAGAIN2:
		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE3]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		CMP AX,4000H
		JB WRITELASTBLOCK2

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		JMP READONCEAGAIN2



WRITELASTBLOCK2:
		MOV CX,AX
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		MOV AH,49H
		MOV ES,[WORD CS:RESERSEG]
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE3]
		INT 21H
		MOV AX,4202H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		CLC
		CMP [BYTE CS:DISLITEOK],01H
		JZ SUBDISLITE
		CMP [BYTE CS:DISLITEOK],02H
		JZ SUBDISLITE2
		CMP [BYTE CS:DISLITEOK],03H
		JZ SUBDISLITE3
		CMP [BYTE CS:DISLITEOK],04H
		JZ SUBDISLITE4
		CMP [BYTE CS:DISLITEOK],06H
		JZ FIXMODIFIEDPKL2
		SUB AX,0011
		JMP SUBALLUNPS
SUBDISLITE2:
		SUB AX,0017
		JMP SUBALLUNPS
SUBDISLITE3:
		SUB AX,0029
		JMP SUBALLUNPS
SUBDISLITE4:
		SUB AX,0034
		JMP SUBALLUNPS

SUBDISLITE:
		SUB AX,0009
SUBALLUNPS:
		SBB DX,0000
		MOV CX,DX
		MOV DX,AX
		MOV AX,4200H
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		XOR DX,DX
		INT 21H
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		JMP HEADORIGOK
FIXMODIFIEDPKL2:
		CLC
		XOR DX,DX
		MOV AX,[WORD CS:EXEHEADORIG+08H]
		MOV CX,0010H
		MUL CX
		MOV CX,DX
		MOV DX,AX
		ADD DX,0004H
		ADC CX,0000H
		MOV AX,4200H
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		PUSH CS
		POP DS
		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0005H
		MOV DX,OFFSET PKLITEFIX
		INC DX
		INT 21H

		CLC
		XOR DX,DX
		MOV AX,[WORD CS:EXEHEADORIG+08H]
		MOV CX,0010H
		MUL CX
		MOV CX,DX
		MOV DX,AX
		MOV AX,4200H
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		PUSH CS
		POP DS
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0009H
		MOV DX,OFFSET PKLITEFIX
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		JMP HEADORIGOK





CHECKOLDUNP2:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET OLDUNPID2
		PUSH CS
		POP ES
		CLD
		MOV CX,0007
		REP CMPSB
		JNZ CHECKDISLITE1
		JMP UNPCOMMON
CHECKDISLITE1:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET DISLITEID1
		PUSH CS
		POP ES
		CLD
		MOV CX,0007
		REP CMPSB
		JNZ CHECKDISLITE2
DISLITECOMMON:
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET DISLITE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		MOV [BYTE CS:DISLITEOK],01H
		JMP UNPCOMMON2
CHECKDISLITE2:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET DISLITEID2
		PUSH CS
		POP ES
		CLD
		MOV CX,0007
		REP CMPSB
		JNZ CHECKNEWUNP1
		JMP DISLITECOMMON

CHECKNEWUNP1:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET NEWUNPID1
		PUSH CS
		POP ES
		CLD
		MOV CX,0009
		REP CMPSB
		JNZ CHECKNEWUNP2
NEWUNPCOMMON:
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET NEWUNP
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		MOV [BYTE CS:DISLITEOK],02H
		JMP UNPCOMMON2
CHECKNEWUNP2:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET NEWUNPID2
		PUSH CS
		POP ES
		CLD
		MOV CX,0009
		REP CMPSB
		JNZ CHECKXTR1
		JMP NEWUNPCOMMON
CHECKXTR1:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET XTRID1
		PUSH CS
		POP ES
		CLD
		MOV CX,0018
		REP CMPSB
		JNZ CHECKXTR2
XTRFAKECOMMON:
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET XTRACTFAKE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		MOV [BYTE CS:DISLITEOK],03H
		JMP UNPCOMMON2
CHECKXTR2:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET XTRID2
		PUSH CS
		POP ES
		CLD
		MOV CX,0018
		REP CMPSB
		JNZ CHECKRELOCATION3
		JMP XTRFAKECOMMON
CHECKRELOCATION3:
		MOV SI,[WORD CS:CHILDCSIP]
		MOV DI,OFFSET RELOCATION3ID
		PUSH CS
		POP ES
		CLD
		MOV CX,0041
		REP CMPSB
		JNZ CHECKRELOCATION4

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET RELOCATION3
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
RELOCATIONCOMMON:
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:CHILDCSIP]

		MOV [WORD DS:SI],0F0CDH

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH
		MOV [WORD CS:EXEHEADORIG+0006H],0001H
		MOV [WORD CS:EXEHEADORIG+001CH],0007H
		MOV [WORD CS:EXEHEADORIG+001EH],0000H
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,0020H
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET RELOCBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
RELOCBRK0:
		POP AX
		POP AX
		POP AX

		CMP [BYTE CS:DISLITEOK],05H
		JZ RELOCATION4OK
		CMP [BYTE CS:DISLITEOK],06H
		JZ FIXMODIFIEDPKL
		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:0007H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:0003H]
		SUB AX,0010H
		CLC
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP RELOCATIONSCOMMON
RELOCATION4OK:
		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:000CH]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:0008H]
		CLC
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP RELOCATIONSCOMMON
RELOCATIONSCOMMON:

		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV [WORD CS:EXEHEADORIG+10H],SP
		MOV [BYTE CS:DISLITEOK],04H
		MOV [WORD CS:TEMPBYTE],0002H
RELOCCOMMON2:
		MOV AX,3D00H
		PUSH CS
		POP DS
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE3],AX
		JMP HEADFIX
FIXMODIFIEDPKL:
		MOV AX,[WORD CS:EXEHEADORIG+08H]
		MOV [WORD CS:TEMPBYTE],AX
		JMP RELOCCOMMON2

CHECKRELOCATION4:
		MOV SI,0
		MOV DI,OFFSET RELOCATION4ID
		PUSH CS
		POP ES
		CLD
		MOV CX,0034
		REP CMPSB
		JNZ CHECKMODIFIEDPKL

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET RELOCATION4
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		MOV [BYTE CS:DISLITEOK],05H
		JMP RELOCATIONCOMMON
CHECKMODIFIEDPKL:
		CMP [WORD DS:0100H],0D88CH
		JNZ CHECKDIET100COM
		CMP [BYTE DS:0102H],090H
		JNZ CHECKDIET100COM
		CMP [WORD DS:0109H],063BH
		JNZ CHECKDIET100COM
		CMP [WORD DS:010BH],0002H
		JNZ CHECKDIET100COM

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET MODIFIEDPKL
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV [BYTE CS:DISLITEOK],06H
		JMP RELOCATIONCOMMON
CHECKDIET100COM:
		MOV SI,0111H
		MOV DI,OFFSET DIET100COMID
		PUSH CS
		POP ES
		CLD
                MOV CX,0015
		REP CMPSB
		JNZ CHECKDIET120COM
		CMP [BYTE DS:0100H],0BFH
		JNZ CHECKDIET120COM

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET DIET100COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
DIETCOMCOMMON:
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:011EH],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET DIET100COMBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
DIET100COMBRK0:
		PUSHF
		CALL PUSHTEMP
		CMP [BYTE CS:DIET],01H
		JNZ DIET100BTW

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD DS:0121H]
		ADD SI,0123H
		CMP [BYTE DS:SI],0E8H
		JZ PRINTDIET120COM
		MOV DX,OFFSET DIET102COM
		MOV [BYTE CS:DIET],02H
		JMP PRINTDIETCOMMON
PRINTDIET120COM:
		MOV DX,OFFSET DIET120COM
PRINTDIETCOMMON:
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB




DIET100BTW:
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD DS:0121H]
		CMP [BYTE CS:DIET],02H
		JZ PUTDIET102BRK
		ADD SI,013EH
		JMP ALLNORMALBRK
PUTDIET102BRK:
		ADD SI,0141H
ALLNORMALBRK:
		MOV [WORD DS:SI],0F0CDH
		MOV [WORD ES:03C0H],OFFSET DIET100COMBRK1
		CALL POPTEMP
		MOV DL,10H
		POPF
		IRET
DIET100COMBRK1:
		SUB DI,0100H
		MOV [WORD CS:FILESIZECOM],DI
		JMP BRKPRX31COM1

CHECKDIET120COM:
		MOV SI,0109H
		MOV DI,OFFSET DIET120COMID
		PUSH CS
		POP ES
		CLD
                MOV CX,0023
		REP CMPSB
		JNZ CHECKDIET100EXE

		MOV [WORD CS:DSEGMENT],DS
		MOV [BYTE CS:DIET],01H

		JMP DIETCOMCOMMON
CHECKDIET100EXE:
		MOV SI,0003H
		MOV DI,OFFSET DIET100EXEID1
		PUSH CS
		POP ES
		CLD
		MOV CX,0011
		REP CMPSB
		JNZ CHECKDIET120EXE

		MOV SI,0017H
		MOV DI,OFFSET DIET100EXEID2
		PUSH CS
		POP ES
		CLD
		MOV CX,0020
		REP CMPSB
		JNZ CHECKDIET120EXE
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET DIET100EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
DIETEXE120COMMON:
		CMP [BYTE CS:DIET],05H
		MOV DS,[WORD CS:DSEGMENT]
		JZ PUTDIET120STBRK

		MOV [WORD DS:033H],0F0CDH
		JMP STBRKCOMMON
PUTDIET120STBRK:
		MOV [WORD DS:030H],0F0CDH
STBRKCOMMON:
		MOV AX,3D02H
		PUSH CS
		POP DS
                MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H


		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET DIET100EXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
DIET100EXEBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		CMP [BYTE CS:DIET],05
		JZ PUTNDBRK

		MOV AX,[WORD DS:036H]
		MOV [WORD CS:OFFSALTO],AX
		MOV AX,[WORD DS:038H]
		MOV [WORD CS:DSEGMENT],AX
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
		JMP BRKNDCOMMON
PUTNDBRK:
		MOV AX,[WORD DS:033H]
		MOV [WORD CS:OFFSALTO],AX
		MOV AX,[WORD DS:035H]
		MOV [WORD CS:DSEGMENT],AX
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
BRKNDCOMMON:
		MOV AX,[WORD DS:SI+01CH]
		CMP AX,01F07H
		JZ PUTDIETSHORTSR
		CMP AX,01F0EH
		JZ PUTDIETSHORTCR
		MOV AX,[WORD DS:SI+048H]
		CMP AX,01F07H
		JZ PUTDIETLONGSR
		CMP AX,01F0EH
		JZ PUTDIETLONGCR
PUTDIETSHORTSR:
		MOV [WORD DS:SI+01CH],0F0CDH
		MOV [BYTE CS:DIET],01H ; NO RELOCATIONS
		JMP DIETEXECOMMON
PUTDIETLONGSR:
		MOV [WORD DS:SI+048H],0F0CDH
		MOV [BYTE CS:DIET],02H ; NO RELOCATIONS
		JMP DIETEXECOMMON
PUTDIETSHORTCR:
		MOV [WORD DS:SI+01CH],0F0CDH
		MOV [WORD DS:SI+038H],0F0CDH
		MOV [BYTE DS:SI+03AH],090H
		MOV [WORD DS:SI+03DH],0F0CDH
		MOV [BYTE CS:DIET],03H ; RELOCATIONS OK!
		JMP DIETEXECOMMON2
PUTDIETLONGCR:
		MOV [WORD DS:SI+048H],0F0CDH
		MOV [WORD DS:SI+064H],0F0CDH
		MOV [BYTE DS:SI+066H],090H
		MOV [WORD DS:SI+069H],0F0CDH
		MOV [BYTE CS:DIET],04H ; RELOCATIONS OK!
		JMP DIETEXECOMMON2
DIETEXECOMMON:
		MOV [WORD ES:03C0H],OFFSET DIET100EXEBRK1
		JMP EXEDIETCOMMON
DIETEXECOMMON2:
		MOV [WORD ES:03C0H],OFFSET DIET100EXEINTERMEDIOBRK1
EXEDIETCOMMON:
		CALL POPTEMP
		MOV DL,10H
		POPF
		IRET
DIET100EXEINTERMEDIOBRK1:
		PUSHF
		CALL PUSHTEMP
		CALL SAVELENGTH
		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET DIET100EXEINTERMEDIOBRK2
		MOV [BYTE CS:COMPRTYPE],01H
		MOV BX,SP
		MOV DS,[WORD SS:BX+04]
		MOV [WORD CS:TEMPDS],DS
		CALL POPTEMP
		POPF
		IRET
DIET100EXEINTERMEDIOBRK2:
		PUSHF
		CALL PUSHTEMP
		MOV CX,[WORD CS:TEMPCX]
		CMP CX,0000
		JZ ENDDIETRELOC
		CALL SAVERELOC2
		CALL POPTEMP
		POPF
		IRET
ENDDIETRELOC:
		CALL POPTEMP
		CALL PUSHTEMP
		POPF
		CMP [BYTE CS:DIET],03H
		JZ PUTHEADER3
		CMP [BYTE CS:DIET],04H
		JZ PUTHEADER4



DIET100EXEBRK1:
		CALL PUSHTEMP
SAVELENGTH:
		MOV ES,[WORD CS:TEMPES]
		MOV DI,[WORD CS:TEMPDI]
DENUEVO:
		MOV AX,ES
		MOV BX,[WORD CS:PID]
		ADD BX,0010H
		CMP AX,BX
		JAE SAVENORMALOK
		INC AX
		SUB DI,0010H
		MOV ES,AX
		JMP DENUEVO

SAVENORMALOK:
		CLC
		MOV AX,ES
		SUB DI,0025
		SBB AX,0000
		MOV ES,AX
		MOV [WORD CS:PARAES],ES
		MOV [WORD CS:PARADI],DI
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]

		CMP [BYTE CS:DIET],01H
		JZ PUTHEADER1
		CMP [BYTE CS:DIET],02H
		JZ PUTHEADER2
		CMP [BYTE CS:DIET],03H
		JZ RETORNAR
		CMP [BYTE CS:DIET],04H
		JZ RETORNAR
RETORNAR:
		RET
PUTHEADER1:
		MOV AX,[WORD DS:SI+020H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+025H]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+034H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+036H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP DIETEXELASTCOMMON
PUTHEADER2:
		MOV AX,[WORD DS:SI+04CH]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+051H]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+060H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+062H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP DIETEXELASTCOMMON
PUTHEADER3:
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
		POP AX
		POP AX
		POP AX
                JMP CHECKWITHOUTSSSP
NOPROBLEMS:
		MOV AX,[WORD DS:SI+041H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+046H]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+055H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+057H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
NOPROBLEMS2:

		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX
		MOV [WORD CS:EXEHEADORIG+12H],0000
		MOV [WORD CS:EXEHEADORIG+1AH],0000
		XOR DX,DX
		CLC
		MOV CX,0002
		MUL CX
		MOV DX,[WORD CS:TEMPSI]
		SUB DX,0019H
		SUB DX,AX
		MOV [WORD CS:PARADI],DX
		MOV DS,[WORD CS:TEMPDS]
		MOV [WORD CS:PARAES],DS
		JMP ALLDIETEXECOMMON
CHECKWITHOUTSSSP:
		MOV AX,[WORD DS:SI+043H]
		CMP AX,0F633H
		JZ SPECIALDIET2
		JMP NOPROBLEMS
SPECIALDIET2:
		POP AX
		POP AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+04CH]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+04EH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP NOPROBLEMS2

SPECIALDIET:
		MOV [BYTE CS:DIETOK],00
		JMP WITHOUTSS

PUTHEADER4:
		POP AX
		POP AX
		POP AX
		CMP [BYTE CS:DIETOK],01H
		JZ WITHSS
WITHOUTSS:
		POP AX
		POP AX
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		JMP STACKCOMMON
WITHSS:
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
		MOV AX,[WORD DS:SI+06FH]
		CMP AX,0F633H
		JZ SPECIALDIET

		MOV AX,[WORD DS:SI+06DH]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+072H]

STACKCOMMON:
		MOV [WORD CS:EXEHEADORIG+10H],AX
		CMP [BYTE CS:DIETOK],01H
		JZ OTHERCS
		MOV AX,[WORD DS:SI+078H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+07AH]
		JMP CSCOMMON
OTHERCS:
		MOV AX,[WORD DS:SI+081H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+083H]
CSCOMMON:
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		MOV AX,[WORD CS:CANTRELOC]
		MOV CX,AX
		MOV [WORD EXEHEADORIG+06H],AX
		MOV [WORD CS:EXEHEADORIG+12H],0000
		MOV [WORD CS:EXEHEADORIG+1AH],0000
		XOR DX,DX
		CLC
		MOV CX,0002
		MUL CX
		MOV DX,[WORD CS:TEMPSI]
		SUB DX,0019H
		SUB DX,AX
		MOV [WORD CS:PARADI],DX
		MOV DS,[WORD CS:TEMPDS]
		MOV [WORD CS:PARAES],DS
		MOV AX,[WORD CS:PARAES]
		MOV BX,[WORD CS:PARADI]
		JMP ALLDIETEXECOMMON


DIETEXELASTCOMMON:
		MOV [WORD CS:EXEHEADORIG+1AH],0000
		MOV [WORD CS:EXEHEADORIG+1CH],0000
		MOV [WORD CS:EXEHEADORIG+1EH],0000

		MOV [WORD CS:EXEHEADORIG+06H],0000
ALLDIETEXECOMMON:
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		CALL FIXHEADLENGTH
		JMP SAVECOMMON

CHECKDIET120EXE:
		MOV SI,0000H
		MOV DI,OFFSET DIET120EXEID1
		PUSH CS
		POP ES
		CLD
		MOV CX,0011
		REP CMPSB
		JNZ CHECKDIET144COM

		MOV SI,0014H
		MOV DI,OFFSET DIET120EXEID2
		PUSH CS
		POP ES
		CLD
		MOV CX,0020
		REP CMPSB
		JNZ CHECKDIET144COM
		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET DIET120EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
		MOV [BYTE CS:DIET],05
		MOV [BYTE CS:DIETOK],01
		JMP DIETEXE120COMMON
CHECKDIET144COM:
		MOV SI,010EH
		MOV DI,OFFSET DIET144COMID1
		PUSH CS
		POP ES
		CLD
		MOV CX,0026
		REP CMPSB
		JNZ CHECKDIET144EXE

		MOV SI,0130H
		MOV DI,OFFSET DIET144COMID2
		PUSH CS
		POP ES
		CLD
		MOV CX,0015
		REP CMPSB
		JNZ CHECKDIET144EXE
		MOV [WORD CS:DSEGMENT],DS

		MOV [WORD DS:013CH],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET DIET144COMBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
DIET144COMBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT

		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD DS:013FH]
		ADD SI,0141H
		MOV [WORD CS:OFFSALTO],SI
		CMP [BYTE DS:SI+01BH],058H
		JZ CHOOSENORMALCOM
		CMP [BYTE DS:SI+036H],058H
		JZ CHOOSESFXCOM
CHOOSESFXCOM:
		MOV DX,OFFSET DIET14445COMSFX
		CALL PRINT
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
		MOV [WORD DS:SI+036H],0F0CDH
		JMP DIETCHOOSECOMCOMMON
CHOOSENORMALCOM:
		MOV DX,OFFSET DIET14445COM
		CALL PRINT
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
		MOV [WORD DS:SI+01BH],0F0CDH
DIETCHOOSECOMCOMMON:
		CALL PAGK
		CALL GETATTRIB

		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET DIET144COMBRK1
		CALL POPTEMP
		MOV DL,10H
		POPF
		IRET
DIET144COMBRK1:
		MOV [WORD CS:FILESIZECOM],DI
		JMP BRKPRX31COM1


CHECKDIET144EXE:
		MOV SI,000DH
		MOV DI,OFFSET DIET144EXEID1
		PUSH CS
		POP ES
		CLD
		MOV CX,0018
		REP CMPSB
		JNZ CHECKDIET145EXE

		MOV SI,0028H
		MOV DI,OFFSET DIET144EXEID2
		PUSH CS
		POP ES
		CLD
		MOV CX,0031
		REP CMPSB
		JNZ CHECKDIET145EXE

		MOV [WORD CS:DSEGMENT],DS

		MOV [WORD DS:0044H],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET DIET144EXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
DIET144EXEBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT

		MOV DS,[WORD CS:DSEGMENT]

		MOV SI,[WORD DS:0047H]
		MOV [WORD CS:OFFSALTO],SI
		MOV AX,[WORD DS:0049H]
		MOV [WORD CS:DSEGMENT],AX
		MOV DS,AX

		MOV AX,[WORD DS:SI+01CH]
		CMP AX,01F0EH
		JZ DIET144NORMAL1
		CMP AX,0FF69H
		JZ DIET144NORMAL2
		MOV AX,[WORD DS:SI+037H]
		CMP AX,01F0EH
		JZ DIET144SFX1
		CMP AX,0FEEDH
		JZ DIET144SFX2
DIET144NORMAL1:
		MOV [BYTE CS:DIET],01H
		JMP DIET144NORMALEXE
DIET144NORMAL2:
		MOV [BYTE CS:DIET],02H
		JMP DIET144NORMALEXE
DIET144SFX1:
		MOV [BYTE CS:DIET],03H
		JMP DIET144SFXEXE
DIET144SFX2:
		MOV [BYTE CS:DIET],04H
		JMP DIET144SFXEXE

DIET144NORMALEXE:
		MOV DX,OFFSET DIET144EXE
		CALL PRINT
		JMP DIET144COMMON
DIET144SFXEXE:
		MOV DX,OFFSET DIET144EXESFX
		CALL PRINT
DIET144COMMON:
		CALL PAGK
		CALL GETATTRIB
PUTDIET144BRKS:
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
		CMP [BYTE CS:DIET],01H
		JZ DIETNORMALBRK1
		CMP [BYTE CS:DIET],02H
		JZ DIETNORMALBRK2
		CMP [BYTE CS:DIET],03H
		JZ DIETSFXBRK1
		CMP [BYTE CS:DIET],04H
		JZ DIETSFXBRK2
DIETNORMALBRK1:
		MOV [WORD DS:SI+01CH],0F0CDH
		MOV [WORD DS:SI+03AH],0F0CDH
		MOV [BYTE DS:SI+03CH],090H
		MOV [WORD DS:SI+052H],0F0CDH
		MOV [WORD DS:SI+065H],0F0CDH
		JMP DIET144EXECOMMON
DIETNORMALBRK2:
		MOV [WORD DS:SI+048H],0F0CDH
		MOV [WORD DS:SI+066H],0F0CDH
		MOV [BYTE DS:SI+068H],090H
		MOV [WORD DS:SI+07EH],0F0CDH
		MOV [WORD DS:SI+091H],0F0CDH
		JMP DIET144EXECOMMON
DIETSFXBRK1:
		MOV [WORD DS:SI+037H],0F0CDH
		MOV [WORD DS:SI+055H],0F0CDH
		MOV [BYTE DS:SI+057H],090H
		MOV [WORD DS:SI+06DH],0F0CDH
		MOV [WORD DS:SI+080H],0F0CDH
		JMP DIET144EXECOMMON
DIETSFXBRK2:
		MOV [WORD DS:SI+06BH],0F0CDH
		MOV [WORD DS:SI+089H],0F0CDH
		MOV [BYTE DS:SI+08BH],090H
		MOV [WORD DS:SI+0A1H],0F0CDH
		MOV [WORD DS:SI+0B4H],0F0CDH
		JMP DIET144EXECOMMON
DIET144EXECOMMON:
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET DIET144BRK1
		CALL POPTEMP
		POPF
		MOV DL,10H
		IRET
DIET144BRK1:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPES]
		INC AX
		MOV [WORD CS:PARAES],AX
		MOV AX,[WORD CS:TEMPDI]
		SUB AX,0010H
		MOV [WORD CS:PARADI],AX
		MOV [BYTE CS:COMPRTYPE],01H
		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET DIET144BRK2
		CALL POPTEMP
		MOV DS,[WORD CS:DSEGMENT]
		POPF
		IRET
DIET144BRK2:
		PUSHF
		CALL PUSHTEMP
		MOV CX,[WORD CS:TEMPCX]
		CMP CX,0001H
		JZ PUTRELOCENDOFFSET
		JCXZ NOMOREDIETRELOC
DIET144BRK2TEMP:
		CALL SAVERELOC2
		CALL POPTEMP
		POPF
		IRET
PUTRELOCENDOFFSET:
		MOV AX,[WORD CS:TEMPDS]
		MOV BX,[WORD CS:TEMPSI]
		ADD AX,0004H
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],BX
		JMP DIET144BRK2TEMP

NOMOREDIETRELOC:
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		POP AX
		POP SI ; RESTORE ip :)
		SUB SI,0002H
		POP AX

		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:OFFSALTO]
		SUB SI,BX

		CMP [BYTE CS:DIET],01H
		JZ PUTHEADERNORMAL1
		CMP [BYTE CS:DIET],02H
		JZ PUTHEADERNORMAL2
		CMP [BYTE CS:DIET],03H
		JZ PUTHEADERSFX1
		CMP [BYTE CS:DIET],04H
		JZ PUTHEADERSFX2

PUTHEADERNORMAL1:
		CMP SI,0052H
		JZ WITHSS144A
		CMP SI,0065H
		JZ WITHOUTSS144A

WITHSS144A:
		MOV SI,BX
		MOV AX,[WORD DS:SI+055H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+05AH]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+061H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+063H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP DIET144COMMON1
WITHOUTSS144A:
		MOV SI,BX
		MOV AX,[WORD DS:SI+067H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+069H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		POP AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		MOV [WORD CS:EXEHEADORIG+10H],AX
DIET144COMMON1:
                MOV AX,[WORD CS:EXEHEADORIG+16H]
                CMP AX,0FFF0H
                JNZ DIET144COMMONOK
                MOV AX,[WORD CS:EXEHEADORIG+14H]
                CMP AX,0100H
                JZ DIET144COMMON2
DIET144COMMONOK:
                CLC
		MOV AX,[WORD CS:PARADI]
		SUB AX,0019H
		PUSH AX
		CLC
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX
		MOV CX,0002
		XOR DX,DX
		MUL CX
		MOV BX,AX
		POP AX
		SUB AX,BX
		MOV [WORD CS:PARADI],AX
		JMP SAVECOMMON
DIET144COMMON2:
                CLC
                MOV AX,[WORD CS:CANTRELOC]
                MOV [WORD EXEHEADORIG+06H],AX
                JMP SAVECOMMON
PUTHEADERNORMAL2:
		CMP SI,007EH
		JZ WITHSS144B
		CMP SI,0091H
		JZ WITHOUTSS144B

WITHSS144B:
		MOV SI,BX
		MOV AX,[WORD DS:SI+081H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+086H]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+08DH]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+08FH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP DIET144COMMON1
WITHOUTSS144B:
		MOV SI,BX
		MOV AX,[WORD DS:SI+093H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+095H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		POP AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		MOV [WORD CS:EXEHEADORIG+10H],AX
		JMP DIET144COMMON1
PUTHEADERSFX1:
		CMP SI,006DH
		JZ WITHSS144C
		CMP SI,0080H
		JZ WITHOUTSS144C

WITHSS144C:
		MOV SI,BX
		MOV AX,[WORD DS:SI+070H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+075H]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+07CH]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+07EH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP DIET144COMMON1
WITHOUTSS144C:
		MOV SI,BX
		MOV AX,[WORD DS:SI+082H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+084H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		POP AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		MOV [WORD CS:EXEHEADORIG+10H],AX
		JMP DIET144COMMON1
PUTHEADERSFX2:
		CMP SI,00A1H
		JZ WITHSS144D
		CMP SI,00B4H
		JZ WITHOUTSS144D

WITHSS144D:
		MOV SI,BX
		MOV AX,[WORD DS:SI+0A4H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+0A9H]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+0B0H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+0B2H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP DIET144COMMON1
WITHOUTSS144D:
		MOV SI,BX
		MOV AX,[WORD DS:SI+0B6H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+0B8H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		POP AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		MOV [WORD CS:EXEHEADORIG+10H],AX
		JMP DIET144COMMON1
CHECKDIET145EXE:
		MOV SI,000DH
		MOV DI,OFFSET DIET145EXEID1
		PUSH CS
		POP ES
		CLD
		MOV CX,0012
		REP CMPSB
                JNZ CHECKAINEXE22

		MOV SI,002DH
		MOV DI,OFFSET DIET145EXEID2
		PUSH CS
		POP ES
		CLD
		MOV CX,0031
		REP CMPSB
		JNZ CHECKSCRE2B
		MOV [WORD CS:DSEGMENT],DS

		MOV [WORD DS:0049H],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET DIET145EXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
DIET145EXEBRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT

		MOV DS,[WORD CS:DSEGMENT]

		MOV SI,[WORD DS:0020H]
		MOV [WORD CS:OFFSALTO],SI
		MOV AX,[WORD DS:001AH]
		MOV BX,DS
		ADD AX,BX
		MOV [WORD CS:DSEGMENT],AX
		MOV DS,AX

		MOV AX,[WORD DS:SI+01CH]
		CMP AX,01F0EH
		JZ DIET145NORMAL1
		CMP AX,0FF69H
		JZ DIET145NORMAL2
		MOV AX,[WORD DS:SI+037H]
		CMP AX,01F0EH
		JZ DIET145SFX1
		CMP AX,0FEEDH
		JZ DIET145SFX2
DIET145NORMAL1:
		MOV [BYTE CS:DIET],01H
		JMP DIET145NORMALEXE
DIET145NORMAL2:
		MOV [BYTE CS:DIET],02H
		JMP DIET145NORMALEXE
DIET145SFX1:
		MOV [BYTE CS:DIET],03H
		JMP DIET145SFXEXE
DIET145SFX2:
		MOV [BYTE CS:DIET],04H
		JMP DIET145SFXEXE

DIET145NORMALEXE:
		MOV DX,OFFSET DIET145EXE
		CALL PRINT
		JMP DIET145COMMON
DIET145SFXEXE:
		MOV DX,OFFSET DIET145EXESFX
		CALL PRINT
DIET145COMMON:
		CALL PAGK
		CALL GETATTRIB
PUTDIET145BRKS:
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:OFFSALTO]
		CMP [BYTE CS:DIET],01H
		JZ DIETNORMAL2BRK1
		CMP [BYTE CS:DIET],02H
		JZ DIETNORMAL2BRK2
		CMP [BYTE CS:DIET],03H
		JZ DIETSFX2BRK1
		CMP [BYTE CS:DIET],04H
		JZ DIETSFX2BRK2
DIETNORMAL2BRK1:
		MOV [WORD DS:SI+01CH],0F0CDH
		MOV [WORD DS:SI+044H],0F0CDH
		MOV [BYTE DS:SI+046H],090H
		MOV [WORD DS:SI+054H],0F0CDH
		MOV [WORD DS:SI+067H],0F0CDH
		JMP DIET145EXECOMMON
DIETNORMAL2BRK2:
		MOV [WORD DS:SI+048H],0F0CDH
		MOV [WORD DS:SI+070H],0F0CDH
		MOV [BYTE DS:SI+072H],090H
		MOV [WORD DS:SI+080H],0F0CDH
		MOV [WORD DS:SI+093H],0F0CDH
		JMP DIET145EXECOMMON
DIETSFX2BRK1:
		MOV [WORD DS:SI+037H],0F0CDH
		MOV [WORD DS:SI+05FH],0F0CDH
		MOV [BYTE DS:SI+061H],090H
		MOV [WORD DS:SI+06FH],0F0CDH
		MOV [WORD DS:SI+082H],0F0CDH
		JMP DIET145EXECOMMON
DIETSFX2BRK2:
		MOV [WORD DS:SI+06BH],0F0CDH
		MOV [WORD DS:SI+093H],0F0CDH
		MOV [BYTE DS:SI+095H],090H
		MOV [WORD DS:SI+0A3H],0F0CDH
		MOV [WORD DS:SI+0B6H],0F0CDH
		JMP DIET145EXECOMMON
DIET145EXECOMMON:
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET DIET145BRK1
		CALL POPTEMP
		POPF
		MOV DL,10H
		IRET
DIET145BRK1:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPES]
		INC AX
		MOV [WORD CS:PARAES],AX
		MOV AX,[WORD CS:TEMPDI]
		SUB AX,0010H
		MOV [WORD CS:PARADI],AX
		MOV [BYTE CS:COMPRTYPE],01H
		XOR AX,AX
		MOV ES,AX
		MOV [WORD ES:03C0H],OFFSET DIET145BRK2
		CALL POPTEMP
		MOV DS,[WORD CS:DSEGMENT]
		POPF
		IRET
DIET145BRK2:
		PUSHF
		CALL PUSHTEMP
		MOV CX,[WORD CS:TEMPCX]
		CMP CX,0001H
		JZ PUTRELOCENDOFFSET2
		JCXZ NOMOREDIETRELOC2
DIET145BRK2TEMP2:
		CALL SAVERELOC2
		CALL POPTEMP
		POPF
		IRET
PUTRELOCENDOFFSET2:
		MOV AX,[WORD CS:TEMPDS]
		MOV BX,[WORD CS:TEMPSI]
		ADD AX,0004H
		MOV [WORD CS:PARAES],AX
		MOV [WORD CS:PARADI],BX
		JMP DIET145BRK2TEMP2

NOMOREDIETRELOC2:
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		POP AX
		POP SI ; RESTORE ip :)
		SUB SI,0002H
		POP AX

		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:OFFSALTO]
		SUB SI,BX

		CMP [BYTE CS:DIET],01H
		JZ PUTHEADER2NORMAL1
		CMP [BYTE CS:DIET],02H
		JZ PUTHEADER2NORMAL2
		CMP [BYTE CS:DIET],03H
		JZ PUTHEADER2SFX1
		CMP [BYTE CS:DIET],04H
		JZ PUTHEADER2SFX2

PUTHEADER2NORMAL1:
		CMP SI,0054H
		JZ WITHSS145A
		CMP SI,0067H
		JZ WITHOUTSS145A

WITHSS145A:
		MOV SI,BX
		MOV AX,[WORD DS:SI+057H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+05CH]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+063H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+065H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
                JMP DIET145COMMON1
WITHOUTSS145A:
		MOV SI,BX
		MOV AX,[WORD DS:SI+069H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+06BH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		POP AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		MOV [WORD CS:EXEHEADORIG+10H],AX
DIET145COMMON1:
                MOV AX,[WORD CS:EXEHEADORIG+16H]
                CMP AX,0FFF0H
                JNZ DIET145COMMONOK
                MOV AX,[WORD CS:EXEHEADORIG+14H]
                CMP AX,0100H
                JZ DIET145COMMON2
DIET145COMMONOK:
                CLC
		MOV AX,[WORD CS:PARADI]
		SUB AX,0019H
                PUSH AX
		CLC
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD EXEHEADORIG+06H],AX
		MOV CX,0002
		XOR DX,DX
		MUL CX
		MOV BX,AX
		POP AX
		SUB AX,BX
		MOV [WORD CS:PARADI],AX
		JMP SAVECOMMON
DIET145COMMON2:
                CLC
                MOV AX,[WORD CS:CANTRELOC]
                MOV [WORD EXEHEADORIG+06H],AX
                JMP SAVECOMMON
PUTHEADER2NORMAL2:
		CMP SI,0080H
		JZ WITHSS145B
		CMP SI,0093H
		JZ WITHOUTSS145B

WITHSS145B:
		MOV SI,BX
		MOV AX,[WORD DS:SI+083H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+088H]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+08FH]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+091H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP DIET145COMMON1
WITHOUTSS145B:
		MOV SI,BX
		MOV AX,[WORD DS:SI+095H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+097H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		POP AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		MOV [WORD CS:EXEHEADORIG+10H],AX
		JMP DIET145COMMON1
PUTHEADER2SFX1:
		CMP SI,006FH
		JZ WITHSS145C
		CMP SI,0082H
		JZ WITHOUTSS145C

WITHSS145C:
		MOV SI,BX
		MOV AX,[WORD DS:SI+072H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+077H]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+07EH]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+080H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP DIET145COMMON1
WITHOUTSS145C:
		MOV SI,BX
		MOV AX,[WORD DS:SI+084H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+086H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		POP AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		MOV [WORD CS:EXEHEADORIG+10H],AX
		JMP DIET145COMMON1
PUTHEADER2SFX2:
		CMP SI,00A3H
		JZ WITHSS145D
		CMP SI,00B6H
		JZ WITHOUTSS145D

WITHSS145D:
		MOV SI,BX
		MOV AX,[WORD DS:SI+0A6H]
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD DS:SI+0ABH]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD DS:SI+0B2H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+0B4H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		JMP DIET145COMMON1
WITHOUTSS145D:
		MOV SI,BX
		MOV AX,[WORD DS:SI+0B8H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:SI+0BAH]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		POP AX
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,SP
		MOV [WORD CS:EXEHEADORIG+10H],AX
		JMP DIET145COMMON1
CHECKDEMO20:
		CMP [WORD DS:0001H],013CH
		JNZ CHECKERROR

		MOV SI,013FH
		MOV DI,OFFSET DEMO20ID
		PUSH CS
		POP ES
		CLD
		MOV CX,0067
		REP CMPSB
		JNZ CHECKERROR

		MOV [WORD CS:DSEGMENT],DS
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET DEMO20
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:026AH],0F0CDH
		MOV [BYTE DS:026CH],090H

		PUSH CS
		POP DS
		MOV AX,3D02H
		XOR BX,BX
		XOR CX,CX
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET DEMO20BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
DEMO20BRK0:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:TEMPDS]
		MOV AX,[WORD CS:TEMPAX]
		MOV [WORD DS:001FH],AX
		MOV AX,[WORD DS:001FH]
		MOV [WORD CS:OFFSALTO],AX
		MOV AX,[WORD DS:0021H]
		MOV [WORD CS:DSEGMENT],AX
		MOV DS,[WORD CS:DSEGMENT]
		MOV BX,[WORD CS:OFFSALTO]
		MOV [WORD DS:BX+0149H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET DEMO20BRK1
		CALL POPTEMP
		POPF
		IRET
DEMO20BRK1:
		CALL PUSHTEMP
		POP AX
		POP AX
		POP AX

		MOV [WORD CS:EXEHEADORIG+10H],SP
		MOV AX,SS
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX

		MOV AX,3D00H
		PUSH CS
		POP DS
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE3],AX

		MOV AH,62H
		INT 21H
		MOV ES,BX

		MOV AH,49h
		INT 21H

		MOV ES,[WORD CS:PID3]

		MOV AX,ES
		MOV BX,XT
		SUB BX,AX

		MOV AH,4AH
		INT 21H

		MOV AH,48H
		MOV BX,0500H
		INT 21H

		JNC MEMOOK3

		MOV DX,OFFSET NOTMEMO
		CALL PRINT

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE3]
		INT 21

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21

		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		XOR CX,CX
		INT 21H


		MOV AH,41H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV AX,3D02H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV BX,[WORD CS:HANDLE]
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H
		MOV AH,3EH
		INT 21H
		MOV AX,4301H
		MOV DX,OFFSET LINEPARAMETERS
		MOV CX,[WORD CS:ATRIB]
		INT 21H


		MOV [BYTE CS:EXITORCONT],00H
		MOV AX,OFFSET FIN2
		PUSH AX
		RET

MEMOOK3:
		MOV [WORD CS:RESERSEG],AX
                CLI
		MOV SS,[WORD CS:INITSSSP]
		MOV SP,[WORD CS:INITSSSP+02H]
                STI
		MOV AH,1AH
		MOV DS,[WORD CS:PID3]
		MOV DX,0080H
		INT 21H


READONCEAGAIN3:
		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE3]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		CMP AX,4000H
		JB WRITELASTBLOCK3

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		JMP READONCEAGAIN3



WRITELASTBLOCK3:
		MOV CX,AX
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		MOV AH,49H
		MOV ES,[WORD CS:RESERSEG]
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE3]
		INT 21H

		CLC
		MOV AX,[WORD CS:EXEHEADORIG+08H]
		XOR DX,DX
		MOV CX,0010H
		MUL CX
		MOV CX,DX
		MOV DX,AX

		MOV AX,4200H
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		CLC
		XOR DX,DX
		MOV AX,[WORD CS:EXEHEADORIG+16H]
		MOV CX,0010H
		MUL CX
		CLC
		ADD AX,[WORD CS:EXEHEADORIG+14H]
		ADC DX,0000H

		MOV CX,DX
		MOV DX,AX

		MOV AX,4201H
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV AX,4000H
		MOV BX,[WORD CS:HANDLE]
		XOR CX,CX
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV AX,[WORD DS:0003H]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD DS:0005H]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX

		JMP HEADORIGOK

CHECKONEMANCREW:
		MOV SI,[WORD CS:CHILDCSIP]
		CMP [WORD DS:SI+1],0494H
                JNZ CHECKFSHIELD15COM

		MOV SI,0597H
		MOV DI,OFFSET ONEMANCREWID
		PUSH CS
		POP ES
		CLD
		MOV CX,59
		REP CMPSB
                JNZ CHECKFSHIELD15COM

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
		MOV DX,OFFSET ONEMANCREW
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:05DFH],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
		MOV DX,OFFSET ONEMANCREWBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
ONEMANCREWBRK0:
		PUSHF
		CALL PUSHTEMP
		STD
		CLI
		MOV DS,[WORD CS:DSEGMENT]
		MOV ES,[WORD CS:TEMPES]
		MOV CX,[WORD CS:TEMPCX]
		MOV SI,[WORD CS:TEMPSI]
		MOV DI,[WORD CS:TEMPDI]
UNSCRAMBLE:
		TEST CL,0FH
		JNZ NO15
		MOV SI,BX
NO15:
		DEC SI
		STOSW
                MOV AX,[WORD ES:DI]
                XOR AX,[WORD DS:SI]
		LOOP UNSCRAMBLE
		MOV [WORD CS:TEMPCX],CX
		MOV [WORD CS:TEMPSI],SI
		MOV [WORD CS:TEMPDI],DI
		MOV [WORD CS:TEMPAX],AX
                MOV BX,SP
                MOV AX,05F2H
                MOV [WORD SS:BX+02],AX
                MOV DS,[WORD CS:DSEGMENT]
                MOV [WORD DS:0601H],0F0CDH
                XOR AX,AX
                MOV ES,AX
                MOV [WORD ES:03C0H],OFFSET ONEMANCREWBRK0B
                CALL POPTEMP
		POPF
		IRET
ONEMANCREWBRK0B:
                CALL PUSHTEMP
                POP AX
                MOV [WORD CS:STACKIP],AX
                POP AX
                MOV [WORD CS:STACKCS],AX
                POP AX
                MOV [WORD CS:STACKFLAGS],AX
                XOR AX,AX
                MOV DS,[WORD CS:TEMPDS]
                MOV SI,[WORD CS:TEMPSI]
                MOV DI,[WORD CS:TEMPDI]
                MOV ES,[WORD CS:DSEGMENT]

STRANGEMOVE:
                PUSH AX
                PUSH [WORD CS:DSEGMENT]
                PUSH DS
                STI
                ADD SI,+71H
                MOV DS,[WORD CS:DSEGMENT]
                ADD DI,+37H
                MOV CX,000EH
                REP MOVSW
                LAHF
                SAHF
                LAHF
                DAA
                MOV [WORD CS:TEMPAX],AX
                MOV [WORD CS:TEMPCX],CX
                MOV [WORD CS:TEMPSI],SI
                MOV [WORD CS:TEMPDI],DI

                MOV AX,[WORD CS:STACKFLAGS]
                PUSH AX
                MOV AX,[WORD CS:STACKCS]
                PUSH AX
                MOV AX,[WORD CS:STACKIP]
                PUSH AX

		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0142H],0F0CDH
                XOR AX,AX
                MOV ES,AX
                MOV [WORD ES:03C0H],OFFSET ONEMANCREWBRK1
                MOV [WORD CS:TEMPDS],AX
                CALL POPTEMP
		IRET
ONEMANCREWBRK1:
		PUSHF
		CALL PUSHTEMP
		MOV DI,[WORD CS:TEMPDI]
		INC DI
		INC DI
		MOV [WORD CS:TEMPDI],DI
		MOV CX,[WORD CS:TEMPCX]
		CMP CX,0001H
		JZ ONEMANINTERMEDIO
		CALL POPTEMP
		POPF
		IRET
ONEMANINTERMEDIO:
		MOV [WORD ES:03C0H],OFFSET ONEMANCREWBRK2
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0E87H],0F0CDH
		MOV [BYTE DS:0E89H],090H
		CALL POPTEMP
		POPF
		IRET
ONEMANCREWBRK2:
		PUSHF
		CALL PUSHTEMP
		MOV DX,031DH
		MOV [WORD CS:TEMPDX],DX
		MOV [WORD ES:03C0H],OFFSET ONEMANCREWBRK3
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0A42H],0F0CDH
		CALL POPTEMP
		POPF
		IRET
ONEMANCREWBRK3:
		PUSHF
		CALL PUSHTEMP
		MOV BX,SP
		MOV DS,[WORD SS:BX+10H]
		MOV [WORD CS:DSEGMENT],DS
		MOV [WORD DS:060FH],0F0CDH
		MOV [BYTE DS:0611H],090H
		MOV [WORD ES:03C0H],OFFSET ONEMANCREWBRK4
		CALL POPTEMP
		MOV SI,[WORD CS:TEMPBX]
		POPF
		IRET
ONEMANCREWBRK4:
		PUSHF
		CALL PUSHTEMP
		MOV DS,[WORD CS:DSEGMENT]
		MOV SI,[WORD CS:TEMPSI]
		MOV BX,[WORD CS:TEMPBX]
		XOR [BYTE DS:SI],BL
		MOV CX,[WORD CS:TEMPCX]
		CMP CX,0001H
		JZ ONEMANCREWINTERMEDIO2
		CALL POPTEMP
		POPF
		IRET
ONEMANCREWINTERMEDIO2:
		MOV [WORD ES:03C0H],OFFSET ONEMANCREWBRK5
		MOV [WORD DS:06DAH],0F0CDH
		MOV [WORD DS:06DCH],09090H
		MOV [WORD DS:06F0H],0F0CDH
		MOV [BYTE DS:06F2H],090H
		MOV [WORD DS:0701H],0D233H
		MOV [WORD DS:0703H],0F0CDH
		CALL POPTEMP
		POPF
		IRET
ONEMANCREWBRK5:
		PUSHF
		CALL PUSHTEMP
		MOV AX,[WORD CS:TEMPES]
		MOV [WORD CS:PARAES],AX
		MOV AX,[WORD CS:TEMPDI]
		MOV [WORD CS:PARADI],AX
		MOV [WORD ES:03C0H],OFFSET ONEMANCREWBRK6
		MOV [BYTE CS:COMPRTYPE],01H
		CALL POPTEMP
		MOV CX,[WORD DS:011AH]
		POPF
		IRET
ONEMANCREWBRK6:
		PUSHF
		CALL PUSHTEMP
		MOV DX,[WORD CS:TEMPDX]
		CMP DX,0000
		JZ ENDRELOCONEMANCREW
		CALL SAVERELOC2
		CALL POPTEMP
		POPF
		IRET
ENDRELOCONEMANCREW:
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:0933H],0F0CDH
		MOV [BYTE DS:0935H],090H
		MOV [WORD ES:03C0H],OFFSET ONEMANCREWBRK7
		CALL POPTEMP
		LES DI,[DWORD DS:0112H]
		POPF
		IRET
ONEMANCREWBRK7:
		PUSHF
		CALL PUSHTEMP
		MOV SI,[WORD CS:TEMPSI]
		CMP SI,0000H
		JZ ONEMANLAST
		MOV DS,[WORD CS:DSEGMENT]
		MOV CX,[WORD CS:TEMPCX]
		XOR [BYTE DS:SI],CL
		CALL POPTEMP
		POPF
		IRET
ONEMANLAST:
		MOV DS,[WORD CS:DSEGMENT]
		MOV [WORD DS:07A0H],0F0CDH
		MOV [WORD ES:03C0H],OFFSET ONEMANCREWBRK8
		CALL POPTEMP
		MOV BH,AL
		POPF
		IRET
ONEMANCREWBRK8:
		CALL PUSHTEMP

		PUSH CS
		POP DS
		XOR AX,AX
		MOV ES,AX
		MOV DI,AX
		MOV SI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB

		POP AX
		POP AX
		POP AX
		MOV AX,[WORD CS:TEMPCX]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+0EH],AX
		MOV AX,[WORD CS:TEMPBX]
		MOV [WORD CS:EXEHEADORIG+10H],AX
		MOV AX,[WORD CS:TEMPDI]
		SUB AX,[WORD CS:PID]
		SUB AX,0010H
		MOV [WORD CS:EXEHEADORIG+16H],AX
		MOV AX,[WORD CS:TEMPSI]
		MOV [WORD CS:EXEHEADORIG+14H],AX
		MOV AX,[WORD CS:CANTRELOC]
		MOV [WORD CS:EXEHEADORIG+06H],AX

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H
		JMP SAVECOMMON
CHECKTINY:
                MOV SI,BX
                MOV DI,OFFSET TINY10ID
		PUSH CS
		POP ES
		CLD
                MOV CX,47
		REP CMPSB
                JNZ CHECKTINYREST
                MOV [BYTE CS:TINYTYPE],01H
                JMP TINYGENOK
CHECKTINYREST:
                MOV SI,BX
                MOV DI,OFFSET TINYID
		PUSH CS
		POP ES
		CLD
                MOV CX,55
		REP CMPSB
                JNZ NOTTINY
                JMP TINYGENOK
NOTTINY:
                MOV SI,[WORD CS:CHILDCSIP]
                JMP CHECKCOMUN
TINYGENOK:
                MOV [WORD CS:OFFSALTO],BX
                MOV [WORD CS:DSEGMENT],DS

                MOV SI,[WORD CS:OFFSALTO]
                CMP [WORD DS:SI+07CH],06CFFH
                JZ TINY10OK
                CMP [WORD DS:SI+0095H],06CFFH
                JZ TINY3339OK
                CMP [WORD DS:SI+0096H],06CFFH
                JZ TINY30OK
                CMP [WORD DS:SI+00AEH],06CFFH
                JZ TINY3339PASSOK
                CMP [WORD DS:SI+00AFH],06CFFH
                JZ TINY30PASSOK
TINY10OK:
                MOV [WORD DS:SI+07CH],0F0CDH
                MOV [BYTE CS:TINYTYPE],01H
                JMP TINYBRKCOMMON
TINY3339OK:
                MOV [WORD DS:SI+095H],0F0CDH
                MOV [BYTE CS:TINYTYPE],02H
                JMP TINYBRKCOMMON
TINY30OK:
                MOV [WORD DS:SI+096H],0F0CDH
                MOV [BYTE CS:TINYTYPE],02H
                JMP TINYBRKCOMMON
TINY3339PASSOK:
                MOV [WORD DS:SI+00AEH],0F0CDH
                MOV [BYTE CS:TINYTYPE],02H
                JMP TINYBRKCOMMONWPASS
TINY30PASSOK:
                MOV [WORD DS:SI+00AFH],0F0CDH
                MOV [BYTE CS:TINYTYPE],02H
                JMP TINYBRKCOMMONWPASS
TINYBRKCOMMONWPASS:
                PUSH CS
                POP DS
                MOV DX,OFFSET PASSWORD
                MOV AH,09H
                INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX

                MOV DS,[WORD CS:PID]
                MOV [BYTE DS:007FH],0050H

                MOV AH,0CH
                MOV AL,0AH

                MOV DX,007FH
                INT 21H

                MOV AH,09
                PUSH CS
                POP DS
                MOV DX,OFFSET CARRIAGE
                INT 21H

TINYBRKCOMMON:
                PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
                MOV DX,OFFSET TINYBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
TINYBRK0:
                PUSHF
                CALL PUSHTEMP
                MOV DS,[WORD CS:TEMPDS]
                MOV SI,[WORD CS:TEMPSI]
                CMP [BYTE CS:TINYTYPE],01H
                JZ LOADTINY10
                CMP [BYTE CS:TINYTYPE],02H
                JZ LOADTINYREST
LOADTINY10:
                MOV AX,[WORD DS:SI+012H]
                MOV BX,[WORD DS:SI+014H]
                JMP PUTSEGMENTS
LOADTINYREST:
                MOV AX,[WORD DS:SI+01AH]
                MOV BX,[WORD DS:SI+01CH]
                JMP PUTSEGMENTS
PUTSEGMENTS:
                MOV [WORD CS:DSEGMENT],BX
                MOV [WORD CS:OFFSALTO],AX

CHECKVERSION:
                MOV DS,[WORD CS:DSEGMENT]
CHECK10:
                MOV SI,[WORD CS:OFFSALTO]
                ADD SI,01C8H
                MOV DI,OFFSET TINYJUMP
		PUSH CS
		POP ES
		CLD
                MOV CX,5
		REP CMPSB
                JNZ CHECK30
                MOV [BYTE CS:TINYTYPE],01H
                JMP SHOWTINY
CHECK30:
                MOV SI,[WORD CS:OFFSALTO]
                ADD SI,0134H
                MOV DI,OFFSET TINYJUMP
		PUSH CS
		POP ES
		CLD
                MOV CX,5
		REP CMPSB
                JNZ CHECK33
                MOV [BYTE CS:TINYTYPE],02H
                JMP SHOWTINY
CHECK33:
                MOV SI,[WORD CS:OFFSALTO]
                ADD SI,0135H
                MOV DI,OFFSET TINYJUMP
		PUSH CS
		POP ES
		CLD
                MOV CX,5
		REP CMPSB
                JNZ CHECK36
                MOV [BYTE CS:TINYTYPE],03H
                JMP SHOWTINY
CHECK36:
                MOV SI,[WORD CS:OFFSALTO]
                ADD SI,0139H
                MOV DI,OFFSET TINYJUMP
		PUSH CS
		POP ES
		CLD
                MOV CX,5
		REP CMPSB
                JNZ CHECK38
                MOV [BYTE CS:TINYTYPE],04H
                JMP SHOWTINY
CHECK38:
                MOV SI,[WORD CS:OFFSALTO]
                ADD SI,0146H
                MOV DI,OFFSET TINYJUMP
		PUSH CS
		POP ES
		CLD
                MOV CX,5
		REP CMPSB
                JNZ CHECK39
                MOV [BYTE CS:TINYTYPE],05H
                JMP SHOWTINY
CHECK39:
                MOV SI,[WORD CS:OFFSALTO]
                ADD SI,0149H
                MOV DI,OFFSET TINYJUMP
		PUSH CS
		POP ES
		CLD
                MOV CX,5
		REP CMPSB
                JNZ CHECK30
                MOV [BYTE CS:TINYTYPE],06H
                JMP SHOWTINY

SHOWTINY:
		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                CMP [BYTE CS:PKTINYOK],01H
                JNZ TINY1
                MOV DX,OFFSET PKTINY
                CALL PRINT
TINY1:
                CMP [BYTE CS:TINYTYPE],01H
                JNZ TINY2
                MOV DX,OFFSET TINY10
                JMP SHOWTINY2
TINY2:
                CMP [BYTE CS:TINYTYPE],02H
                JNZ TINY3
                MOV DX,OFFSET TINY30
                JMP SHOWTINY2
TINY3:
                CMP [BYTE CS:TINYTYPE],03H
                JNZ TINY4
                MOV DX,OFFSET TINY33
                JMP SHOWTINY2
TINY4:
                CMP [BYTE CS:TINYTYPE],04H
                JNZ TINY5
                MOV DX,OFFSET TINY36
                JMP SHOWTINY2
TINY5:
                CMP [BYTE CS:TINYTYPE],05H
                JNZ TINY6
                MOV DX,OFFSET TINY38
                JMP SHOWTINY2
TINY6:
                CMP [BYTE CS:TINYTYPE],06H
                JNZ TINY1
                MOV DX,OFFSET TINY39
                JMP SHOWTINY2
SHOWTINY2:
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

                MOV DS,[WORD CS:DSEGMENT]
                CMP [BYTE CS:TINYTYPE],01H
                JZ PUTTINY10BRK
                CMP [BYTE CS:TINYTYPE],02H
                JZ PUTTINY30BRK
                CMP [BYTE CS:TINYTYPE],03H
                JZ PUTTINY33BRK
                CMP [BYTE CS:TINYTYPE],04H
                JZ PUTTINY36BRK
                CMP [BYTE CS:TINYTYPE],05H
                JZ PUTTINY38BRK
                CMP [BYTE CS:TINYTYPE],06H
                JZ PUTTINY39BRK
PUTTINY10BRK:
                MOV [WORD DS:0162H],0F0CDH
                MOV [WORD DS:0164H],09090H
                MOV [BYTE DS:0166H],090H
                MOV [WORD DS:017CH],0F0CDH
                MOV [BYTE DS:017EH],090H
                MOV [WORD DS:0184H],0F0CDH
                MOV [WORD DS:01BCH],0F0CDH
                JMP TINYCOMMONMEM

PUTTINY30BRK:
                MOV [WORD DS:00EEH],0F0CDH
                MOV [BYTE DS:00F0H],090H
                MOV [WORD DS:00F4H],0F0CDH
                MOV [WORD DS:0128H],0F0CDH
                JMP TINYCOMMONMEM
PUTTINY33BRK:
                MOV [WORD DS:00EFH],0F0CDH
                MOV [BYTE DS:00F1H],090H
                MOV [WORD DS:00F5H],0F0CDH
                MOV [WORD DS:0129H],0F0CDH
                JMP TINYCOMMONMEM
PUTTINY36BRK:
                MOV [WORD DS:00F3H],0F0CDH
                MOV [BYTE DS:00F5H],090H
                MOV [WORD DS:00F9H],0F0CDH
                MOV [WORD DS:012DH],0F0CDH
                JMP TINYCOMMONMEM
PUTTINY38BRK:
                MOV [WORD DS:0FDH],0F0CDH
                MOV [BYTE DS:0FFH],090H
                MOV [WORD DS:0103H],0F0CDH
                MOV [WORD DS:013AH],0F0CDH
                JMP TINYCOMMONMEM
PUTTINY39BRK:
                MOV [WORD DS:0100H],0F0CDH
                MOV [WORD DS:0106H],0F0CDH
                MOV [WORD DS:013DH],0F0CDH
                JMP TINYCOMMONMEM
TINYCOMMONMEM:
                XOR AX,AX
                MOV ES,AX
                MOV [WORD ES:03C0H],OFFSET TINYBRK1
                MOV BX,SP
                MOV AX,[WORD CS:OFFSALTO]
                MOV [WORD SS:BX+02H],AX
                MOV AX,[WORD CS:DSEGMENT]
                MOV [WORD SS:BX+04H],AX
                MOV [BYTE CS:COMPRTYPE],01H

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

                CALL POPTEMP
                POPF
                IRET
TINYBRK1:
                PUSHF
                CALL PUSHTEMP
                CMP [BYTE CS:TINYTYPE],01H
                JZ TINY10BRK1
                MOV CX,[WORD CS:TEMPCX]
                JCXZ GETSIZEINMEM
                CALL SAVERELOC2
                CALL POPTEMP
                POPF
                IRET
TINY10BRK1:
                MOV BX,SP
                MOV AX,[WORD SS:BX+02H]
                CMP AX,0186H
                JZ GETSIZEINMEM
                CMP AX,017EH
                JZ THELASTRELOC
                MOV [BYTE CS:COMPRTYPE],02H
                JMP TINY10RELOCCOMMON
THELASTRELOC:
                MOV [BYTE CS:COMPRTYPE],03H
TINY10RELOCCOMMON:
                CALL SAVERELOC2
                CALL POPTEMP
                POPF
                IRET

GETSIZEINMEM:
                MOV AX,[WORD CS:TEMPES]
                MOV BX,[WORD CS:TEMPDI]
GETSIZEINMEM2:
                CMP AX,[WORD CS:PID]
                JB CALCMEM
                JA NOPASANADA1
                ADD AX,0010H
                SUB BX,0100H
                JMP NOPASANADA1
CALCMEM:
                INC AX
                SUB BX,0010H
                JMP GETSIZEINMEM2

NOPASANADA1:
                MOV [WORD CS:PARAES],AX
                MOV [WORD CS:PARADI],BX
                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE]
                INT 21H
                XOR AX,AX
                MOV ES,AX
                MOV [WORD ES:03C0H],OFFSET TINYBRK2
                CALL POPTEMP
                MOV DS,[WORD CS:DSEGMENT]
                POPF
                IRET
TINYBRK2:
                CALL PUSHTEMP
                MOV DS,[WORD CS:DSEGMENT]
                MOV AX,[WORD DS:000CH]
                MOV [WORD CS:EXEHEADORIG+014H],AX
                MOV AX,[WORD DS:000EH]
                SUB AX,[WORD CS:PID]
                SUB AX,0010H
                MOV [WORD CS:EXEHEADORIG+016H],AX

                MOV AX,[WORD CS:TEMPBX]
                SUB AX,[WORD CS:PID]
                SUB AX,0010H
                MOV [WORD CS:EXEHEADORIG+0EH],AX

                TEST [BYTE DS:0006H],0FFH
                JNZ SINDECREMENTO
                SUB [WORD CS:TEMPDI],0002H
SINDECREMENTO:
                MOV AX,[WORD CS:TEMPDI]
                MOV [WORD CS:EXEHEADORIG+10H],AX

                MOV AX,[WORD CS:CANTRELOC]
                MOV [WORD CS:EXEHEADORIG+06H],AX
                JMP SAVECOMMON
CHECKAINEXE22:
                MOV SI,0014H
                MOV DI,OFFSET AINEXE22ID
		PUSH CS
		POP ES
		CLD
                MOV CX,0060
		REP CMPSB
                JNZ CHECKEXPAKFIX

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET AINEXE22
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

		MOV DS,[WORD CS:DSEGMENT]
                MOV [WORD DS:0131H],0F0CDH
                MOV [WORD DS:0166H],0F0CDH
                MOV [BYTE DS:0168H],090H
                MOV [WORD DS:00DAH],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
                MOV DX,OFFSET AINEXE22BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
AINEXE22BRK0:
                PUSHF
                CALL PUSHTEMP
                MOV BX,SP
                MOV AX,[WORD SS:BX+04H]
                MOV [WORD CS:DSEGMENT],AX
                MOV AX,[WORD SS:BX+02H]
                CMP AX,0133H
                JNZ PUTAINRELOC
                MOV AX,[WORD CS:TEMPES]
                MOV BX,[WORD CS:TEMPDI]
                MOV [WORD CS:PARAES],AX
                MOV [WORD CS:PARADI],BX
                CALL POPTEMP
                MOV AX,[WORD CS:TEMPDI]
                POPF
                IRET
PUTAINRELOC:
                CMP AX,0168H
                JNZ ENDAIN
                CALL SAVERELOC2
                CALL POPTEMP
                POPF
                IRET
ENDAIN:
                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE]
                INT 21H
                MOV AX,[WORD CS:TEMPAX]
                SUB AX,[WORD CS:PID]
                SUB AX,0010H
                MOV [WORD CS:EXEHEADORIG+0EH],AX
                MOV DS,[WORD CS:DSEGMENT]
                MOV AX,[WORD DS:0008H]
                MOV [WORD CS:EXEHEADORIG+10H],AX
                MOV AX,[WORD DS:000CH]
                MOV [WORD CS:EXEHEADORIG+16H],AX
                MOV AX,[WORD DS:000AH]
                MOV [WORD CS:EXEHEADORIG+14H],AX
                MOV CX,[WORD CS:CANTRELOC]
                MOV [WORD CS:EXEHEADORIG+06H],CX
                JMP SAVECOMMON
CHECKEXPAKFIX:
                MOV SI,0012H
                MOV DI,OFFSET EXPAKFIXID
		PUSH CS
		POP ES
		CLD
                MOV CX,0037
                REP CMPSB
                JNZ CHECKPKTINY

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET EXPAKFIX
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
                MOV [WORD DS:028H],0F0CDH
                MOV [WORD DS:0B9H],0F0CDH
                MOV [BYTE DS:0BBH],090H
                MOV [WORD DS:0D7H],0F0CDH
                MOV [BYTE CS:EXEPACK],02H
                JMP EXEPACKCOMMON
CHECKPKTINY:
                MOV SI,0100H
                MOV DI,OFFSET PKTINYID
		PUSH CS
		POP ES
		CLD
                MOV CX,0021
                REP CMPSB
                JNZ CHECKUN2PACK2

                MOV [BYTE DS:0000H],0E9H
                MOV [BYTE DS:0001H],01DH
                MOV [BYTE DS:0002H],001H

                MOV [BYTE CS:PKTINYOK],01H
                XOR SI,SI
                MOV [WORD CS:CHILDCSIP],SI
                MOV DS,[WORD CS:CHILDCSIP+02]
                JMP CHECK4ALL
CHECKUN2PACK2:
                CMP [WORD DS:0100H],0BA9CH
                JNZ CHECKADYSGLUE110
                CMP [BYTE DS:0104H],02DH
                JNZ CHECKADYSGLUE110
                CMP [WORD DS:0107H],0E181H
                JNZ CHECKADYSGLUE110
                CMP [WORD DS:010BH],0F381H
                JNZ CHECKADYSGLUE110
                CMP [BYTE DS:010FH],0B4H
                JNZ CHECKADYSGLUE110
                CMP [BYTE DS:0111H],09DH
                JNZ CHECKADYSGLUE110

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET UN2PACK2
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
                MOV [WORD DS:0100H],0F0CDH

		PUSH CS
		POP DS
		MOV AX,3D02H
		XOR BX,BX
		XOR CX,CX
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
                MOV DX,OFFSET UN2PACK2BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
UN2PACK2BRK0:
		CALL PUSHTEMP
		POP AX
		POP AX
		POP AX

		MOV AX,3D00H
		PUSH CS
		POP DS
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE3],AX

		MOV AH,62H
		INT 21H
		MOV ES,BX

		MOV AH,49h
		INT 21H

		MOV ES,[WORD CS:PID3]

		MOV AX,ES
		MOV BX,XT
		SUB BX,AX

		MOV AH,4AH
		INT 21H

		MOV AH,48H
		MOV BX,0500H
		INT 21H

                JNC MEMOOK4

		MOV DX,OFFSET NOTMEMO
		CALL PRINT

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE3]
		INT 21

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21

		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		XOR CX,CX
		INT 21H


		MOV AH,41H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV AX,3D02H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV BX,[WORD CS:HANDLE]
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H
		MOV AH,3EH
		INT 21H
		MOV AX,4301H
		MOV DX,OFFSET LINEPARAMETERS
		MOV CX,[WORD CS:ATRIB]
		INT 21H


		MOV [BYTE CS:EXITORCONT],00H
		MOV AX,OFFSET FIN2
		PUSH AX
		RET

MEMOOK4:
		MOV [WORD CS:RESERSEG],AX

                CLI
                MOV SS,[WORD CS:INITSSSP]
		MOV SP,[WORD CS:INITSSSP+02H]
                STI
		MOV AH,1AH
		MOV DS,[WORD CS:PID3]
		MOV DX,0080H
		INT 21H
READONCEAGAIN4:
		MOV AH,3FH
		MOV BX,[WORD CS:HANDLE3]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		CMP AX,4000H
                JB WRITELASTBLOCK4

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

                JMP READONCEAGAIN4



WRITELASTBLOCK4:
		MOV CX,AX
		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE3]
		INT 21H

                CMP [WORD CS:EXEHEADORIG],'MZ'
                JZ MOVEHEADEREXE
                CMP [WORD CS:EXEHEADORIG],'ZM'
                JZ MOVEHEADEREXE
                XOR AL,AL
MOVECOMMON:
                XOR CX,CX
                MOV DX,0012H
                CALL MOVEFILE
                JMP FIXHEADPKL

MOVEHEADEREXE:
                MOV AX,[WORD CS:EXEHEADORIG+08H]
                MOV CX,0010H
                XOR DX,DX
                CLC
                MUL CX
                MOV CX,DX
                MOV DX,AX
                XOR AL,AL
                CALL MOVEFILE
                MOV AL,01H
                JMP MOVECOMMON
MOVEFILE:
                MOV AH,042H
                MOV BX,[WORD CS:HANDLE]
                INT 21H
                RET
FIXHEADPKL:
                MOV AH,03FH
                MOV BX,[WORD CS:HANDLE]
                MOV CX,0045
                MOV DS,[WORD CS:RESERSEG]
                MOV DX,0100H
                INT 21H

                MOV [WORD DS:0123H],0FF33H

                CMP [WORD CS:EXEHEADORIG],'MZ'
                JZ MOVEHEADEREXE1
                CMP [WORD CS:EXEHEADORIG],'ZM'
                JZ MOVEHEADEREXE1
                XOR AL,AL
                XOR CX,CX
                MOV DX,CX
                CALL MOVEFILE
                JMP FIXHEADPKL1

MOVEHEADEREXE1:
                MOV [WORD CS:EXEHEADORIG],'ZM'
                MOV AX,[WORD CS:EXEHEADORIG+08H]
                MOV CX,0010H
                XOR DX,DX
                CLC
                MUL CX
                MOV CX,DX
                MOV DX,AX
                XOR AL,AL
                CALL MOVEFILE
                JMP FIXHEADPKL1
FIXHEADPKL1:
                MOV AH,040H
                MOV BX,[WORD CS:HANDLE]
                MOV CX,0045
                MOV DS,[WORD CS:RESERSEG]
                MOV DX,0100H
                INT 21H

                MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
		INT 21H

		MOV AH,49H
		MOV ES,[WORD CS:RESERSEG]
		INT 21H
                CMP [WORD CS:EXEHEADORIG],'MZ'
                JNZ SETATTRIBEXE2
                CMP [WORD CS:EXEHEADORIG],'ZM'
                JNZ SETATTRIBEXE2
                JMP HEADORIGOK
SETATTRIBEXE2:
		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
                JMP SETATTRIBEXE1
CHECKADYSGLUE110:
                MOV SI,0000H
                MOV DI,OFFSET ADYSGLUE110ID
		PUSH CS
		POP ES
		CLD
                MOV CX,0038
                REP CMPSB
                JNZ CHECKADYSGLUE010

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET ADYSGLUE110
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]
                MOV [WORD DS:00EH],0F0CDH
ADYCOMMON:
		PUSH CS
		POP DS
		MOV AX,3D02H
		XOR BX,BX
		XOR CX,CX
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
                MOV DX,OFFSET ADY110BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
ADY110BRK0:
                CMP [BYTE CS:ADYTYPE],01H
                JE ADY010BRK0
DECRYPT1:
                MOV [WORD DS:00EH],028ACH
                LODSB
                SUB [BYTE DS:DI],AL
                MOV AL,[BYTE DS:DI]
                ADD BX,AX
                ROR [BYTE DS:DI],01H
                INC DI
                CMP SI,0026H
                JB ISTHEEND
                XOR SI,SI
ISTHEEND:
                CMP DI,00FEH
                JB DECRYPT1

                PUSHF
                CALL PUSHTEMP
                MOV BX,SP
                MOV AX,0026H
                MOV [WORD SS:BX+02H],AX
                MOV DS,[WORD CS:DSEGMENT]
                MOV [BYTE DS:045H],090H
                MOV [BYTE DS:048H],090H
                MOV [BYTE DS:04CH],090H
                MOV [BYTE DS:04FH],090H

                MOV [WORD DS:060H],0F0CDH
                MOV [BYTE DS:062H],090H
                MOV [WORD DS:085H],0F0CDH
                MOV [WORD DS:088H],0F0CDH
                MOV [WORD DS:0A4H],0F0CDH
ADYCOMMON2:
                MOV [WORD ES:03C0H],OFFSET ADY110BRK1
                PUSH CS
                POP DS
                PUSH CS
                POP ES
                MOV SI,OFFSET EXEHEADORIG
                MOV DI,OFFSET EXEHEADSTICKER
                MOV CX,0020H
                CLD
                REP MOVSB
                CALL POPTEMP
                CMP [BYTE CS:ADYTYPE],01H
                JNZ THEOTHERADY
                MOV ES,[WORD CS:TEMPDS]
THEOTHERADY:
                POPF
                IRET
ADY010BRK0:
                PUSHF
                CALL PUSHTEMP
                MOV DS,[WORD CS:DSEGMENT]
                MOV [BYTE DS:01EH],090H
                MOV [BYTE DS:021H],090H
                MOV [BYTE DS:025H],090H
                MOV [BYTE DS:028H],090H

                MOV [WORD DS:039H],0F0CDH
                MOV [BYTE DS:03BH],090H
                MOV [WORD DS:05FH],0F0CDH
                MOV [WORD DS:062H],0F0CDH
                MOV [WORD DS:07EH],0F0CDH
                JMP ADYCOMMON2
ADY110BRK1:
                PUSHF
                CALL PUSHTEMP
                MOV AX,[WORD CS:TEMPES]
                MOV [WORD CS:TEMPBYTE],AX
                ADD AX,0010H
                MOV BX,[WORD CS:PID]
                ADD BX,0010H
                SUB AX,BX
                MOV [WORD CS:PARAES],AX

                MOV AX,3C00H
                XOR BX,BX
                MOV CX,0020H
                PUSH CS
                POP DS
                MOV DX,OFFSET STICKERNAME
                INT 21H
                MOV [WORD CS:HANDLE3],AX

                MOV AX,3D00H
                XOR BX,BX
                XOR CX,CX
                MOV DX,OFFSET LINEPARAMETERS
                INT 21H
                MOV [WORD CS:HANDLE2],AX


                XOR DX,DX
                MOV AX,[WORD CS:EXEHEADORIG+08H]
                MOV CX,0010H
                CLC
                MUL CX
                MOV CX,DX
                MOV DX,AX
                MOV AX,4200H
                MOV BX,[WORD CS:HANDLE2]
                INT 21H

                PUSH CS
                POP DS
                MOV AH,40H
                MOV BX,[WORD CS:HANDLE3]
                MOV CX,001CH
                MOV DX,OFFSET EXEHEADSTICKER
                INT 21H

                MOV DS,[WORD CS:DSEGMENT]
                MOV CX,[WORD DS:0182H]
                CMP [BYTE CS:ADYTYPE],01H
                JNZ ADYOK1
                MOV CX,[WORD DS:0157H]
ADYOK1:
                MOV [WORD CS:EXEHEADSTICKER+06H],CX
                JCXZ NOMORERELOCADY110
                MOV SI,0184H
                CMP [BYTE CS:ADYTYPE],01H
                JNZ SAVERELOCADY110
                MOV SI,0159H

SAVERELOCADY110:
                LODSW
                CMP [BYTE CS:ADYTYPE],01H
                JZ ADYOK2
                ADD AX,[WORD DS:007EH]
ADYOK2:
                MOV [WORD CS:DATADI],AX
                LODSW
                MOV [WORD CS:DATAES],AX
                PUSH DS
                PUSH SI
                PUSH CX

		PUSH CS
		POP DS
		MOV AH,40H
                MOV BX,[WORD CS:HANDLE3]
		MOV CX,0002H
		MOV DX,OFFSET DATADI
		INT 21H
		PUSH CS
		POP DS
		MOV AH,40H
                MOV BX,[WORD CS:HANDLE3]
		MOV CX,0002H
		MOV DX,OFFSET DATAES
		INT 21H

                POP CX
                POP SI
                POP DS

                LOOP SAVERELOCADY110
NOMORERELOCADY110:
                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE3]
                INT 21H

		PUSH CS
		POP DS
		MOV AH,4EH
		MOV CX,00FFH
                MOV DX,OFFSET STICKERNAME
		INT 21H
		MOV AH,2FH
		INT 21H

		MOV AX,[WORD ES:009AH]
		MOV BX,0010H
		XOR DX,DX
		DIV BX
		MUL BX
		ADD AX,0010H
		SUB AX,[WORD ES:009AH]
		PUSH AX

		MOV AX,3D02H
                MOV DX,OFFSET STICKERNAME
		INT 21H

                MOV [WORD CS:HANDLE3],AX

		MOV AX,4202H
                MOV BX,[WORD CS:HANDLE3]
		XOR CX,CX
		XOR DX,DX
		INT 21H

		POP CX
		CMP CX,0010H
                JNE WRITEFILLADY
		XOR CX,CX
WRITEFILLADY:
		MOV DX,OFFSET HEADFILL
                CALL WRITEEXE2

		MOV AH,3EH
                MOV BX,[WORD CS:HANDLE3]
		INT 21H

		PUSH CS
		POP DS
		MOV AH,4EH
		MOV CX,00FFH
                MOV DX,OFFSET STICKERNAME
		INT 21H
		MOV AH,2FH
		INT 21H

		MOV AX,[WORD ES:009AH]
		MOV BX,0010H
		XOR DX,DX
		DIV BX
                MOV [WORD CS:EXEHEADSTICKER+0008H],AX

		MOV AX,3D02H
                MOV DX,OFFSET STICKERNAME
		INT 21H

                MOV [WORD CS:HANDLE3],AX

		MOV CX,001CH
                MOV DX,OFFSET EXEHEADSTICKER
                CALL WRITEEXE2

		MOV AH,3EH
                MOV BX,[WORD CS:HANDLE3]
		INT 21H

                MOV AX,3D02H
                XOR BX,BX
                XOR CX,CX
                PUSH CS
                POP DS
                MOV DX,OFFSET STICKERNAME
                INT 21H
                MOV [WORD CS:HANDLE3],AX

                MOV AX,4202H
                MOV BX,[WORD CS:HANDLE3]
                XOR CX,CX
                XOR DX,DX
                INT 21H

                XOR DX,DX
                MOV AX,[WORD CS:EXEHEADORIG+08H]
                MOV CX,0010H
                CLC
                MUL CX
                MOV CX,DX
                MOV DX,AX
                MOV AX,4200H
                MOV BX,[WORD CS:HANDLE2]
                INT 21H

                XOR DX,DX
                MOV AX,[WORD CS:PARAES]
                MOV CX,0010H
                CLC
                MUL CX
                MOV CX,DX
                MOV DX,AX
                MOV AX,4201H
                MOV BX,[WORD CS:HANDLE2]
                INT 21H

                XOR AX,AX
                MOV ES,AX
                MOV [WORD ES:03C0H],OFFSET ADY110BRK2
                CALL POPTEMP
                MOV CX,0080H
                POPF
                IRET
WRITEEXE2:
		MOV AH,40H
                MOV BX,[WORD CS:HANDLE3]
		INT 21H
                RET
ADY110BRK2:
                PUSHF
                CALL PUSHTEMP
                MOV AX,[WORD CS:TEMPAX]
                SUB AX,[WORD CS:TEMPBYTE]
                SUB AX,0010H
                MOV [WORD CS:EXEHEADSTICKER+0EH],AX
                MOV [WORD ES:03C0H],OFFSET ADY110BRK3
                CALL POPTEMP
                POPF
                IRET
ADY110BRK3:
                PUSHF
                CALL PUSHTEMP
                MOV AX,[WORD CS:TEMPAX]
                MOV [WORD CS:EXEHEADSTICKER+10H],AX
                MOV [WORD ES:03C0H],OFFSET ADY110BRK4
                CALL POPTEMP
                POPF
                IRET
ADY110BRK4:
                CALL PUSHTEMP
                POP AX
                POP AX
                POP AX
                POP AX; restoreo IP
                MOV [WORD CS:EXEHEADSTICKER+014H],AX
                POP AX; restoreo CS
                SUB AX,[WORD CS:TEMPBYTE]
                SUB AX,0010H
                MOV [WORD CS:EXEHEADSTICKER+016H],AX

		CLI
		MOV SS,[WORD CS:INITSSSP]
		MOV SP,[WORD CS:INITSSSP+02H]
		STI

                MOV DS,[WORD CS:DSEGMENT]
                MOV SI,00AFH
                CMP [BYTE CS:ADYTYPE],01H
                JNZ ADYOK3
                MOV SI,008BH
ADYOK3:
                LODSW
                MOV [WORD CS:EXEHEADORIG+0EH],AX
                LODSW
                MOV [WORD CS:EXEHEADORIG+10H],AX
                LODSW
                MOV [WORD CS:EXEHEADORIG+16H],AX
                LODSW
                MOV [WORD CS:EXEHEADORIG+14H],AX

                MOV AH,62H
		INT 21H
		MOV ES,BX

		MOV AH,49h
		INT 21H

		MOV ES,[WORD CS:PID3]

		MOV AX,ES
		MOV BX,XT
		SUB BX,AX

		MOV AH,4AH
		INT 21H

		MOV AH,48H
		MOV BX,0500H
		INT 21H

                JNC MEMOOKADY110

		MOV DX,OFFSET NOTMEMO
		CALL PRINT

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE3]
                INT 21H
		MOV AH,3EH
                MOV BX,[WORD CS:HANDLE2]
                INT 21H
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
                INT 21H


		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		XOR CX,CX
		INT 21H


		MOV AH,41H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV AX,3D02H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV BX,[WORD CS:HANDLE]
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H
		MOV AH,3EH
		INT 21H
		MOV AX,4301H
		MOV DX,OFFSET LINEPARAMETERS
		MOV CX,[WORD CS:ATRIB]
		INT 21H


		MOV [BYTE CS:EXITORCONT],00H
		MOV AX,OFFSET FIN2
		PUSH AX
		RET

MEMOOKADY110:
		MOV [WORD CS:RESERSEG],AX

READONCEAGAINADY110:
		MOV AH,3FH
                MOV BX,[WORD CS:HANDLE2]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

		CMP AX,4000H
                JB WRITELASTBLOCKADY110

		MOV AH,40H
                MOV BX,[WORD CS:HANDLE3]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

                JMP READONCEAGAINADY110



WRITELASTBLOCKADY110:
		MOV CX,AX
		MOV AH,40H
                MOV BX,[WORD CS:HANDLE3]
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
                MOV CX,001CH
                PUSH CS
                POP DS
                MOV DX,OFFSET EXEHEADORIG
                INT 21H

                MOV AH,03EH
                MOV BX,[WORD CS:HANDLE3]
                INT 21H

                CALL POPTEMP

		MOV AH,2FH
		INT 21H

		PUSH CS
		POP DS
		MOV AH,4EH
		MOV CX,00FFH
                MOV DX,OFFSET STICKERNAME
		INT 21H

		MOV DX,[WORD ES:009CH]
		MOV AX,[WORD ES:009AH]
		MOV BX,0200H
		XOR CX,CX
		DIV BX
		CMP DX,0000
                JE HEADMUL512ADY
		INC AX
HEADMUL512ADY:
                MOV [WORD CS:EXEHEADSTICKER+0004H],AX
                MOV [WORD CS:EXEHEADSTICKER+0002H],DX
                MOV [WORD CS:EXEHEADSTICKER+018H],0001CH
                PUSH CS
		POP DS
		MOV AX,3D02H
                MOV DX,OFFSET STICKERNAME
		INT 21H

                MOV [WORD CS:HANDLE3],AX
		PUSH CS
		POP DS
		MOV CX,001CH
                MOV DX,OFFSET EXEHEADSTICKER
                CALL WRITEEXE2

                MOV BX,[WORD CS:HANDLE3]
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H
		MOV AH,3EH
                MOV BX,[WORD CS:HANDLE3]
                INT 21H
		MOV AX,4301H
                MOV DX,OFFSET STICKERNAME
		MOV CX,[WORD CS:ATRIB]
		INT 21H

                MOV CX,[WORD CS:EXEHEADORIG+06H]
                JCXZ NOMORERELOCADY110MAIN

                PUSH CX

                MOV AX,4200H
                MOV BX,[WORD CS:HANDLE2]
                XOR CX,CX
                MOV DX,[WORD CS:EXEHEADORIG+018H]
                INT 21H
                POP CX
GRABOTODASLASRELOC:
                PUSH CX

                MOV AH,03FH
                MOV BX,[WORD CS:HANDLE2]
                MOV CX,0004H
                MOV DS,[WORD CS:RESERSEG]
                MOV DX,0100H
                INT 21H

                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
                MOV CX,0004H
                MOV DS,[WORD CS:RESERSEG]
                MOV DX,0100H
                INT 21H

                POP CX
                LOOP GRABOTODASLASRELOC

NOMORERELOCADY110MAIN:
                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE]
                INT 21H
                MOV [WORD CS:EXEHEADORIG+018H],0001CH
                CALL FIXHEADLENGTH

                MOV AX,3D02H
                XOR BX,BX
                XOR CX,CX
                PUSH CS
                POP DS
                MOV DX,OFFSET TEMPPARAMETERS
                INT 21H
                MOV [WORD CS:HANDLE],AX

                MOV AX,4200H
                MOV BX,[WORD CS:HANDLE2]
                XOR CX,CX
                MOV DX,0008H
                INT 21H

                MOV AH,3FH
                MOV BX,[WORD CS:HANDLE2]
                MOV CX,0002
                MOV DS,[WORD CS:RESERSEG]
                MOV DX,0100H
                INT 21H

                MOV AX,[WORD DS:0100H]
                MOV CX,0010H
                XOR DX,DX
                CLC
                MUL CX

                MOV CX,DX
                MOV DX,AX

                MOV AX,4200H
                MOV BX,[WORD CS:HANDLE2]
                INT 21H

                MOV AX,4202H
                MOV BX,[WORD CS:HANDLE]
                XOR CX,CX
                XOR DX,DX
                INT 21H

                MOV AX,[WORD CS:DSEGMENT]
                SUB AX,[WORD CS:PID]
                SUB AX,0010H
                XOR DX,DX
                MOV CX,0010H
                CLC
                MUL CX
                MOV CX,4000H
                CLC
                DIV CX

                CMP DX,0000
                JZ LEAMOSDEUNA

                PUSH AX
                MOV CX,DX
                PUSH CX
                MOV AH,3FH
                MOV BX,[WORD CS:HANDLE2]
                MOV DS,[WORD CS:RESERSEG]
                MOV DX,0100H
                INT 21H
                POP CX
                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
                MOV DS,[WORD CS:RESERSEG]
                MOV DX,0100H
                INT 21H
                POP AX
LEAMOSDEUNA:
                MOV CX,AX
                JCXZ TERMINEMOSADY
LEAMOSDEUNA2:
                PUSH CX

                MOV AH,3FH
                MOV BX,[WORD CS:HANDLE2]
                MOV DS,[WORD CS:RESERSEG]
                MOV CX,4000H
                MOV DX,0100H
                INT 21H
                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
                MOV DS,[WORD CS:RESERSEG]
                MOV CX,4000H
                MOV DX,0100H
                INT 21H

                POP CX
                LOOP LEAMOSDEUNA2
TERMINEMOSADY:
                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE]
                INT 21H

                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE2]
                INT 21H

                MOV AH,49H
                MOV ES,[WORD CS:RESERSEG]
                INT 21H
                JMP HEADORIGOK
CHECKADYSGLUE010:
                MOV SI,0000H
                MOV DI,OFFSET ADYSGLUE010ID
		PUSH CS
		POP ES
		CLD
                MOV CX,0044
                REP CMPSB
                JNZ CHECKFSHIELD15EXE

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET ADYSGLUE010
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
                MOV [BYTE CS:ADYTYPE],01H
                MOV DS,[WORD CS:DSEGMENT]
                MOV [WORD DS:018H],0F0CDH
                JMP ADYCOMMON
CHECKFSHIELD15COM:
                MOV SI,[WORD CS:OFFSALTO]
                MOV DI,OFFSET FSHIELD15ID1

		PUSH CS
		POP ES
		CLD
                MOV CX,19
		REP CMPSB
                JNZ CHECKTNTCOM

                MOV BX,[WORD CS:OFFSALTO]
                ADD BX,0004H
                MOV CL,04H
                SHR BX,CL
                MOV CX,DS
                ADD CX,BX
                MOV DS,CX

                MOV SI,0020H
                MOV DI,OFFSET FSHIELD15ID2

		PUSH CS
		POP ES
		CLD
                MOV CX,0005H
		REP CMPSB
                JNZ CHECKTNTCOM

                MOV SI,00A4H
                MOV DI,OFFSET FSHIELD15ID3

		PUSH CS
		POP ES
		CLD
                MOV CX,0030
		REP CMPSB
                JNZ CHECKTNTCOM

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET FSHIELD15COM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		MOV DS,[WORD CS:DSEGMENT]

                MOV [WORD DS:025CH],0F0CDH
TNTCOMMON:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
                MOV DX,OFFSET FSHIELD15BRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
FSHIELD15BRK0:
                MOV CX,[WORD CS:OFFSALTO]
                SUB CX,0100H
                MOV [WORD CS:FILESIZECOM],CX
		JMP BRKPRX31COM1
CHECKFSHIELD15EXE:
                MOV SI,0000H
                MOV DI,OFFSET FSHIELD15ID4

		PUSH CS
		POP ES
		CLD
                MOV CX,0004H
		REP CMPSB
                JNZ CHECKFSHIELD12EXE

                MOV SI,0075H
                MOV DI,OFFSET FSHIELD15ID5

		PUSH CS
		POP ES
		CLD
                MOV CX,0030
		REP CMPSB
                JNZ CHECKFSHIELD12EXE

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET FSHIELD15EXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX

		MOV DS,[WORD CS:DSEGMENT]
                MOV [WORD DS:01ADH],0F0CDH
FSHIELDEXEALL:
		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
                MOV DX,OFFSET FSHIELD15EXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
                MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI

		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
FSHIELD15EXEBRK0:
                CALL PUSHTEMP
                POP AX
                POP AX
                POP AX

                MOV DS,[WORD CS:DSEGMENT]
                MOV SI,073CH
                CMP [BYTE CS:FSHIELDTYPE],01H
                JNZ FSHIELDEXEV15
                MOV SI,057AH
FSHIELDEXEV15:
                LODSW
                MOV [WORD CS:EXEHEADORIG+014H],AX
                LODSW
                MOV [WORD CS:EXEHEADORIG+016H],AX
                LODSW
                MOV [WORD CS:EXEHEADORIG+00EH],AX
                LODSW
                MOV [WORD CS:EXEHEADORIG+010H],AX

                MOV AX,3D00H
                XOR BX,BX
                XOR CX,CX
                PUSH CS
                POP DS
                MOV DX,OFFSET LINEPARAMETERS
                INT 21H
                MOV [WORD CS:HANDLE3],AX

                MOV AH,62H
		INT 21H
		MOV ES,BX

		MOV AH,49h
		INT 21H

		MOV ES,[WORD CS:PID3]

		MOV AX,ES
		MOV BX,XT
		SUB BX,AX

		MOV AH,4AH
		INT 21H

		MOV AH,48H
		MOV BX,0500H
		INT 21H

                JNC MEMOOKFSHIELD

		MOV DX,OFFSET NOTMEMO
		CALL PRINT

		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE3]
                INT 21H
		MOV AH,3EH
		MOV BX,[WORD CS:HANDLE]
                INT 21H


		MOV AX,4301H
		MOV DX,OFFSET TEMPPARAMETERS
		XOR CX,CX
		INT 21H


		MOV AH,41H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H

		MOV AX,3D02H
		MOV DX,OFFSET LINEPARAMETERS
		INT 21H

		MOV [WORD CS:HANDLE],AX

		MOV BX,[WORD CS:HANDLE]
		MOV AX,5701H
		MOV CX,[WORD CS:TIME]
		MOV DX,[WORD CS:DATE]
		INT 21H
		MOV AH,3EH
		INT 21H
		MOV AX,4301H
		MOV DX,OFFSET LINEPARAMETERS
		MOV CX,[WORD CS:ATRIB]
		INT 21H


		MOV [BYTE CS:EXITORCONT],00H
		MOV AX,OFFSET FIN2
		PUSH AX
		RET

MEMOOKFSHIELD:
		MOV [WORD CS:RESERSEG],AX
                MOV AX,[WORD CS:EXEHEADORIG+08H]
                MOV CX,0010H
                XOR DX,DX
                CLC
                MUL CX

                MOV CX,4000H
                CLC
                DIV CX
                CMP AX,0000
                JE READWRITELAST
                MOV CX,AX
                PUSH DX
LEAMOSFSHIELDALL:
                PUSH CX

                MOV AH,3FH
                MOV BX,[WORD CS:HANDLE3]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

                POP CX

                LOOP LEAMOSFSHIELDALL

                POP DX

READWRITELAST:
                MOV CX,DX
                PUSH CX
                MOV AH,3FH
                MOV BX,[WORD CS:HANDLE3]
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H
                POP CX
                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
                MOV DS,[WORD CS:RESERSEG]
                MOV DX,OFFSET 0100H
                INT 21H

                MOV AX,[WORD CS:DSEGMENT]
                SUB AX,[WORD CS:PID]
                SUB AX,0010H
                XOR DX,DX
                MOV CX,0010H
                CLC
                MUL CX

                MOV CX,4000H
                CLC
                DIV CX
                CMP AX,0000
                JE READWRITELAST1
                MOV CX,AX
                PUSH DX
LEAMOSFSHIELDALL1:
                PUSH CX

                MOV AH,3FH
                MOV BX,[WORD CS:HANDLE3]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
		MOV CX,4000H
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H

                POP CX

                LOOP LEAMOSFSHIELDALL1

                POP DX

READWRITELAST1:
                MOV CX,DX
                PUSH CX
                MOV AH,3FH
                MOV BX,[WORD CS:HANDLE3]
		MOV DS,[WORD CS:RESERSEG]
		MOV DX,0100H
		INT 21H
                POP CX
                MOV AH,40H
                MOV BX,[WORD CS:HANDLE]
                MOV DS,[WORD CS:RESERSEG]
                MOV DX,OFFSET 0100H
                INT 21H

                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE]
                INT 21H

                MOV AH,03EH
                MOV BX,[WORD CS:HANDLE3]
                INT 21H

                MOV AH,049H
                MOV ES,[WORD CS:RESERSEG]
                INT 21H

                JMP HEADORIGOK
CHECKTNTCOM:
                MOV DS,[WORD CS:CHILDCSIP+02H]
                MOV SI,[WORD CS:OFFSALTO]
                MOV DI,OFFSET TNTCOMID1

		PUSH CS
		POP ES
		CLD
                MOV CX,0003H
		REP CMPSB
                JNZ CHECKTNTEXE

                MOV SI,[WORD CS:OFFSALTO]
                SUB SI,0303H
                ADD SI,0020
                MOV DI,OFFSET TNTCOMID3

                PUSH CS
		POP ES
		CLD
                MOV CX,0020
		REP CMPSB
                JNZ CHECKTNTEXE

                MOV SI,[WORD CS:OFFSALTO]
                SUB SI,0303H
                MOV DI,OFFSET TNTCOMID2

                PUSH CS
		POP ES
		CLD
                MOV CX,0019
		REP CMPSB
                JNZ CHECKTNTEXE

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET TNTCOM
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB
                MOV DS,[WORD CS:DSEGMENT]
                MOV SI,[WORD CS:OFFSALTO]
                PUSH SI
                SUB SI,015FH
                MOV [WORD DS:SI],0F0CDH
                POP SI
                SUB SI,0303H
                MOV [WORD CS:OFFSALTO],SI
                JMP TNTCOMMON
CHECKTNTEXE:
                MOV SI,[WORD CS:CHILDCSIP]
                MOV BX,[WORD DS:SI+01H]
                ADD BX,SI
                ADD BX,0003H
                MOV SI,BX
                MOV DI,OFFSET TNTEXEID1

                PUSH CS
		POP ES
		CLD
                MOV CX,0010H
		REP CMPSB
                JNZ CHECKFSHIELD12COM

                ADD SI,0003H
                MOV DI,OFFSET TNTEXEID2
                MOV CX,0017
                CLD
                REP CMPSB
                JNZ CHECKFSHIELD12COM

                MOV BP,0000H
TNTCPAVBRKADJUST:
                MOV SI,004EH
                ADD SI,BP
                MOV DI,OFFSET TNTEXEGENID1
                PUSH CS
                POP ES
                CLD
                MOV CX,0010
                REP CMPSB
                JZ TNTCPAVEXEOK
                INC BP
                CMP BP,01000H
                JE CHECKFSHIELD12COM
                JMP TNTCPAVBRKADJUST
TNTCPAVEXEOK:
                SUB SI,0010
                MOV [WORD CS:OFFSALTO],SI

		MOV [WORD CS:DSEGMENT],DS

		MOV DX,OFFSET FOUNDPRG
		CALL PRINT
                MOV DX,OFFSET TNTEXE
		CALL PRINT
		CALL PAGK
		CALL GETATTRIB

		PUSH CS
		POP DS
		MOV AX,3D02H
		MOV DX,OFFSET TEMPPARAMETERS
		INT 21H
		MOV [WORD CS:HANDLE],AX
		MOV [WORD CS:EXEHEADORIG+0018H],001CH

		MOV AH,40H
		MOV BX,[WORD CS:HANDLE]
		MOV CX,001CH
		MOV DX,OFFSET EXEHEADORIG
		INT 21H

                MOV AX,[WORD CS:DSEGMENT]
                XOR BX,BX
                MOV [WORD CS:PARAES],AX
                MOV [WORD CS:PARADI],BX

                MOV DS,[WORD CS:DSEGMENT]
                MOV SI,[WORD CS:OFFSALTO]

                MOV [WORD DS:SI],0F0CDH
                MOV [BYTE DS:SI+002H],090H
                MOV [WORD DS:SI+008H],0F0CDH

		PUSH CS
		POP ES

		XOR AX,AX
		MOV DS,AX
		MOV SI,0
		MOV DI,OFFSET BACKUPINT
		MOV CX,4*0100H
		CLD
		REP MOVSB
		PUSH CS
		POP DS
		MOV AX,35F0H
		INT 21H
		MOV [WORD PTR CS:INTF0IP],BX
		MOV [WORD PTR CS:INTF0CS],ES
		MOV AX,25F0H
                MOV DX,OFFSET TNTCPAVEXEBRK0
		INT 21H
		MOV AH,62H
		INT 21H
		MOV [WORD CS:PID],BX
		MOV ES,BX
		MOV DS,BX

		MOV [WORD CS:INITSSSP],SS
		MOV [WORD CS:INITSSSP+02H],SP

		CLI
		MOV SS,[WORD CS:CHILDSSSP+02H]
		MOV SP,[WORD CS:CHILDSSSP]
		STI
		XOR AX,AX
		XOR BX,BX
		XOR CX,CX
		XOR DX,DX
		XOR SI,SI
		XOR DI,DI

		PUSH AX
		POPF
		STI
		JMP [DWORD CS:CHILDCSIP]
TNTCPAVEXEBRK0:
                PUSHF
                CALL PUSHTEMP
                MOV CX,[WORD CS:TEMPCX]
                JCXZ ENDTNT
                CALL SAVERELOC2
                CALL POPTEMP
                POPF
                IRET
ENDTNT:
                MOV AH,3EH
                MOV BX,[WORD CS:HANDLE]
                INT 21H
                MOV DS,[WORD CS:DSEGMENT]
                MOV DI,[WORD CS:OFFSALTO]
                MOV SI,[WORD DS:DI+01CH]
                MOV AX,[WORD DS:BP+SI]
                MOV [WORD CS:EXEHEADORIG+0EH],AX
                MOV SI,[WORD DS:DI+023H]
                MOV AX,[WORD DS:BP+SI]
                MOV [WORD CS:EXEHEADORIG+10H],AX
                MOV SI,[WORD DS:DI+00DH]
                MOV AX,[WORD DS:BP+SI]
                MOV [WORD CS:EXEHEADORIG+16H],AX
                MOV SI,[WORD DS:DI+02AH]
                MOV AX,[WORD DS:BP+SI]
                MOV [WORD CS:EXEHEADORIG+14H],AX

                MOV CX,[WORD CS:CANTRELOC]
                MOV [WORD CS:EXEHEADORIG+06H],CX

		CLC
		MOV AX,[WORD CS:CANTRELOC]
                MOV CX,0004
		XOR DX,DX
		MUL CX
                CLC
                ADD AX,0018H
                ADC DX,0000H
                MOV CX,0010H
                DIV CX

                MOV BX,[WORD CS:PARAES]
                SUB BX,AX
                INC BX
                MOV [WORD CS:PARAES],BX
                MOV [BYTE CS:EPW],01H
                JMP SAVECOMMON
INCLUDE "PARTII.ASM"
SEGMENT DESUBICATED
INCLUDE "OUTOFPLA.ASM"
ENDS DESUBICATED

SEGMENT 	XT
ENDS		XT
END MAIN
